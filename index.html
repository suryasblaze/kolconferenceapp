<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#005461">
    <title>TeleRoute Admin</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SheetJS for Excel handling -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#e6f7f5',
                            100: '#b3e8e0',
                            500: '#249E94',
                            600: '#3BC1A8',
                            900: '#005461',
                        },
                        emerald: {
                            50: '#ecfdf5',
                            500: '#10b981',
                            600: '#059669',
                        },
                        surface: '#f8fafc',
                    },
                }
            }
        }
    </script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #005461;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-left { padding-left: env(safe-area-inset-left); }
        .safe-right { padding-right: env(safe-area-inset-right); }

        #app {
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
            overflow: hidden;
        }

        .data-table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
        }
        .data-table th {
            background: linear-gradient(to bottom, #0C7779, #005461);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .data-table input {
            width: 100%;
            min-width: 70px;
            padding: 10px 8px;
            border: none;
            background: transparent;
            font-size: 13px;
            color: #1e293b;
        }
        .data-table input:focus {
            outline: none;
            background: #e0e7ff;
        }
        .data-table input::placeholder {
            color: #94a3b8;
            font-size: 11px;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f1f5f9;
        }

        .section-hidden { display: none; }
        .section-visible {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .touch-btn {
            min-height: 44px;
            min-width: 44px;
        }

        .header-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease;
        }
        .header-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .collapsed-summary {
            display: none;
            padding: 8px 16px;
            background: linear-gradient(to right, #249E94, #3BC1A8);
            color: white;
            font-size: 11px;
            font-weight: 600;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .collapsed-summary.show {
            display: flex;
        }
        .collapsed-summary .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
        }

        .rotate-overlay, .import-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .rotate-overlay.show, .import-modal.show {
            display: flex;
        }
        .rotate-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: rotate-hint 2s ease-in-out infinite;
        }
        @keyframes rotate-hint {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        @media (orientation: landscape) {
            .rotate-overlay { display: none !important; }
            .landscape-hidden { display: none !important; }
        }

        /* Fullscreen styles */
        :fullscreen {
            background: #f8fafc;
        }
        :-webkit-full-screen {
            background: #f8fafc;
        }
        :-ms-fullscreen {
            background: #f8fafc;
        }

        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Action menu */
        .action-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 180px;
            z-index: 100;
            overflow: hidden;
            display: none;
            margin-top: 8px;
        }
        .action-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .action-menu button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }
        .action-menu button:hover {
            background: #f1f5f9;
        }
        .action-menu button i {
            font-size: 18px;
            color: #64748b;
        }
        .action-menu hr {
            margin: 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        /* Dropdown input styling */
        .data-table input[list] {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }
        .data-table input[list]:focus {
            background-color: #e0e7ff;
        }

        /* Bottom Tab Navigation */
        .bottom-tabs {
            display: flex;
            background: #005461;
            border-top: 1px solid #0C7779;
            padding: 8px 16px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }
        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border-radius: 12px;
            color: #64748b;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #3BC1A8;
            background: rgba(59, 130, 246, 0.1);
        }
        .tab-btn i {
            font-size: 20px;
        }

        /* Meeting Page Styles */
        .meeting-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 16px;
        }
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .date-nav button {
            padding: 8px;
            border-radius: 8px;
            background: #f1f5f9;
            color: #475569;
        }
        .date-nav button:active {
            background: #e2e8f0;
        }

        /* Timetable Container */
        .timetable {
            display: flex;
            flex: 1;
            overflow-y: auto;
        }
        .time-labels {
            width: 50px;
            flex-shrink: 0;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }
        .time-label {
            height: 120px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: flex-start;
        }
        .time-grid {
            flex: 1;
            position: relative;
        }
        .time-grid-line {
            height: 120px;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
        }
        .time-grid-line.current-hour {
            background: #fef3c7;
        }
        .time-grid-line::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px dashed #e2e8f0;
        }
        .meetings-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            padding: 0 8px;
        }

        /* Meeting Block (spans time) */
        .meeting-block {
            position: absolute;
            /* left and width are set dynamically for side-by-side support */
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-radius: 8px;
            padding: 8px 10px;
            color: #249E94;
            cursor: pointer;
            pointer-events: auto;
            overflow: visible;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
            border: 1px solid #93c5fd;
            transition: transform 0.15s, box-shadow 0.15s;
            min-height: 55px;
        }
        .meeting-block:active {
            transform: scale(0.98);
        }
        .meeting-block.completed {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #6ee7b7;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.15);
        }
        .meeting-block.starting-soon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 2px 16px rgba(245, 158, 11, 0.7); }
        }
        .meeting-block .company {
            font-weight: 700;
            font-size: 12px;
        }
        .meeting-block .time-range {
            font-size: 10px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }
        .meeting-block .meta-icons {
            display: flex;
            gap: 6px;
            margin-top: 4px;
            font-size: 10px;
            opacity: 0.85;
        }
        .meeting-block.short .meta-icons {
            display: none;
        }

        /* Legacy time-slot for backwards compat */
        .time-slot {
            display: flex;
            min-height: 60px;
            border-bottom: 1px solid #e2e8f0;
        }
        .slot-content {
            flex: 1;
            padding: 8px;
            min-height: 60px;
            position: relative;
        }

        /* Meeting Card (legacy) */
        .meeting-card {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-radius: 10px;
            padding: 10px 12px;
            color: #249E94;
            border: 1px solid #93c5fd;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .meeting-card:active {
            transform: scale(0.98);
        }
        .meeting-card.has-notes {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #6ee7b7;
        }
        .meeting-card .company {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .meeting-card .subject {
            font-size: 11px;
            opacity: 0.9;
        }
        .meeting-card .meta {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            font-size: 10px;
            opacity: 0.8;
        }
        .meeting-card .meta i {
            font-size: 12px;
        }

        /* Meeting Modal */
        .meeting-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 1000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        .meeting-modal.show {
            display: flex;
        }
        .meeting-modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .modal-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: #f8fafc;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3BC1A8;
            background: white;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .meeting-detail-textarea {
            min-height: 60px !important;
            font-size: 12px !important;
            padding: 8px 10px !important;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Rate Search Autocomplete */
        .rate-search-container {
            position: relative;
        }
        .rate-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
        }
        .rate-suggestions.hidden {
            display: none;
        }
        .rate-suggestion-item {
            padding: 10px 12px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .rate-suggestion-item:last-child {
            border-bottom: none;
        }
        .rate-suggestion-item:hover,
        .rate-suggestion-item.active {
            background: #f0f9ff;
        }
        .rate-suggestion-item .rate-main {
            font-weight: 600;
            color: #0C7779;
        }
        .rate-suggestion-item .rate-sub {
            font-size: 10px;
            color: #64748b;
        }
        .rate-no-results {
            padding: 12px;
            text-align: center;
            color: #94a3b8;
            font-size: 12px;
        }
        .rate-suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .rate-suggestion-info {
            flex: 1;
            min-width: 0;
        }
        .rate-suggestion-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .rate-suggestion-actions button {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-rate-view {
            background: #f1f5f9;
            color: #475569;
        }
        .btn-rate-view:hover {
            background: #e2e8f0;
        }
        .btn-rate-add {
            background: #dbeafe;
            color: #249E94;
        }
        .btn-rate-add:hover {
            background: #bfdbfe;
        }

        /* Rate Preview Panel */
        .rate-preview-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1100;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }
        .rate-preview-panel.show {
            transform: translateY(0);
        }
        .rate-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            background: white;
        }
        .rate-preview-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0C7779;
        }
        .rate-preview-content {
            padding: 16px 20px;
        }
        .rate-preview-table {
            width: 100%;
            font-size: 12px;
        }
        .rate-preview-table td {
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .rate-preview-table td:first-child {
            color: #64748b;
            width: 40%;
        }
        .rate-preview-table td:last-child {
            font-weight: 500;
            color: #0C7779;
        }
        .rate-preview-actions {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            position: sticky;
            bottom: 0;
            background: white;
        }
        .rate-preview-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        /* Country Autocomplete */
        .country-autocomplete {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .country-autocomplete.show {
            display: block;
        }
        .country-option {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }
        .country-option:last-child {
            border-bottom: none;
        }
        .country-option:hover,
        .country-option.selected {
            background: #dbeafe;
            color: #249E94;
        }

        /* Linked Data Tags */
        .linked-data {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .linked-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        .linked-tag button {
            background: none;
            border: none;
            padding: 0;
            color: #4338ca;
            cursor: pointer;
            font-size: 14px;
        }

        /* File Attachment */
        .file-list {
            margin-top: 8px;
        }
        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .file-item i {
            color: #3BC1A8;
        }
        .file-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-item button {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Company Card Styles */
        .company-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .company-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3BC1A8, #249E94);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        .company-info {
            flex: 1;
            min-width: 0;
        }
        .company-name {
            font-weight: 600;
            font-size: 14px;
            color: #0C7779;
            margin-bottom: 2px;
        }
        .company-contact {
            font-size: 11px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .company-actions {
            display: flex;
            gap: 8px;
        }
        .btn-schedule {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-schedule:active {
            background: #059669;
        }
        .btn-view-meeting {
            background: #3BC1A8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-view-meeting:active {
            background: #3BC1A8;
        }
        .btn-details {
            background: #249E94;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-details:active {
            background: #3BC1A8;
        }
        .btn-icon {
            background: #f1f5f9;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            cursor: pointer;
        }
        .btn-icon:active {
            background: #e2e8f0;
        }
        .btn-icon.danger:active {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Add Company Form */
        .add-company-form {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .add-company-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .add-company-form input:focus {
            outline: none;
            border-color: #3BC1A8;
        }

        /* Schedule Modal */
        .schedule-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .schedule-modal.show {
            display: flex;
        }
        .schedule-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 360px;
            overflow: hidden;
            animation: scaleIn 0.2s ease;
        }

        /* Meeting Status Badge */
        .meeting-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .meeting-status.scheduled {
            background: #fef3c7;
            color: #d97706;
        }
        .meeting-status.completed {
            background: #d1fae5;
            color: #059669;
        }

        /* Linked Rates Table in Meeting Details */
        .linked-rates-table {
            width: 100%;
            min-width: 800px; /* Force horizontal scroll on mobile */
            border-collapse: collapse;
            font-size: 11px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .linked-rates-table th {
            background: #0C7779;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
        }
        .linked-rates-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        .linked-rates-table tr:last-child td {
            border-bottom: none;
        }
        .linked-rates-table tr:nth-child(even) {
            background: #f8fafc;
        }
        .table-collapsed {
            display: none;
        }
        .toggle-table-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            color: #64748b;
            font-size: 14px;
        }
        .toggle-table-btn:hover {
            background: #f1f5f9;
            color: #3BC1A8;
        }
        .rate-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
        }
        .rate-type-badge.sms {
            background: #dbeafe;
            color: #249E94;
        }
        .rate-type-badge.voice {
            background: #f3e8ff;
            color: #7c3aed;
        }

        /* File display in details view */
        .file-display-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .file-display-item:hover {
            background: #f8fafc;
        }
        .file-display-item i {
            font-size: 24px;
            color: #3BC1A8;
        }
        .file-display-item .file-info {
            flex: 1;
        }
        .file-display-item .file-name {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
        }
        .file-display-item .file-size {
            font-size: 10px;
            color: #94a3b8;
        }

        /* Calendar Picker Styles */
        .calendar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .calendar-overlay.show {
            display: flex;
        }
        .calendar-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 340px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.2s ease;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .calendar-header {
            background: linear-gradient(135deg, #249E94, #3BC1A8);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .calendar-header button:active {
            background: rgba(255,255,255,0.3);
        }
        .calendar-title {
            font-weight: 700;
            font-size: 16px;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8fafc;
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .calendar-weekdays span {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            padding: 8px 12px 16px;
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            color: #334155;
            border: none;
            background: none;
        }
        .calendar-day:hover {
            background: #f1f5f9;
        }
        .calendar-day.other-month {
            color: #cbd5e1;
        }
        .calendar-day.today {
            background: #e0e7ff;
            color: #3BC1A8;
            font-weight: 700;
        }
        .calendar-day.selected {
            background: #3BC1A8;
            color: white;
        }
        .calendar-day.has-meeting::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 5px;
            height: 5px;
            background: #10b981;
            border-radius: 50%;
        }
        .calendar-day.selected.has-meeting::after {
            background: white;
        }
        .calendar-footer {
            padding: 12px 16px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }
        .calendar-footer button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            border: none;
        }
        .calendar-footer .btn-cancel {
            background: #f1f5f9;
            color: #475569;
        }
        .calendar-footer .btn-today {
            background: #3BC1A8;
            color: white;
        }

        /* Skeleton Loader Styles */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        .skeleton-company-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .skeleton-meeting-block {
            background: white;
            border-radius: 8px;
            padding: 8px;
            margin: 4px 8px;
        }

        .skeleton-offer-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>

    <!-- Rotate Overlay -->
    <div id="rotate-overlay" class="rotate-overlay">
        <i class="ph ph-device-rotate rotate-icon"></i>
        <h2 class="text-xl font-bold mb-2">Better View Available</h2>
        <p class="text-sm text-slate-300 mb-6 max-w-[250px]">Rotate your device to landscape mode for the best table editing experience.</p>
        <div class="flex flex-col gap-3 w-full max-w-[250px]">
            <button onclick="app.tryAutoRotate()" class="px-6 py-3 bg-[#3BC1A8] text-white rounded-xl font-semibold text-sm active:bg-[#249E94] flex items-center justify-center gap-2">
                <i class="ph-bold ph-arrows-out"></i> Auto-Rotate (Fullscreen)
            </button>
            <button onclick="app.dismissRotateOverlay()" class="px-6 py-3 bg-white/10 text-white border border-white/20 rounded-xl font-semibold text-sm active:bg-white/20">
                Continue in Portrait
            </button>
        </div>
        <p class="text-[10px] text-slate-500 mt-4">Auto-rotate requires fullscreen mode</p>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="import-modal">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 text-slate-800">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">Import Excel</h3>
                <button onclick="app.closeImportModal()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <div id="import-preview" class="mb-4 hidden">
                <p class="text-sm text-slate-600 mb-2">Preview (<span id="preview-count">0</span> rows):</p>
                <div class="bg-slate-50 rounded-lg p-3 max-h-40 overflow-y-auto text-xs font-mono" id="preview-content"></div>
            </div>

            <div id="import-dropzone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center mb-4 transition-colors">
                <i class="ph ph-file-xls text-4xl text-slate-400 mb-3"></i>
                <p class="text-sm text-slate-600 mb-2">Drop Excel file here or</p>
                <label class="inline-block px-4 py-2 bg-[#3BC1A8] text-white rounded-lg font-semibold text-sm cursor-pointer active:bg-[#249E94]">
                    Browse Files
                    <input type="file" accept=".xlsx,.xls" onchange="app.handleFileSelect(event)" class="hidden">
                </label>
                <p class="text-[10px] text-slate-400 mt-3">Supports .xlsx and .xls files</p>
            </div>

            <div class="flex gap-2">
                <button onclick="app.closeImportModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold text-sm">
                    Cancel
                </button>
                <button onclick="app.confirmImport()" id="confirm-import-btn" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Import Data
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Picker Overlay -->
    <div id="calendar-overlay" class="calendar-overlay" onclick="app.closeCalendar(event)">
        <div class="calendar-container" onclick="event.stopPropagation()">
            <div class="calendar-header">
                <button onclick="app.calendarPrevMonth()">
                    <i class="ph-bold ph-caret-left"></i>
                </button>
                <span class="calendar-title" id="calendar-month-title">January 2024</span>
                <button onclick="app.calendarNextMonth()">
                    <i class="ph-bold ph-caret-right"></i>
                </button>
            </div>
            <div class="calendar-weekdays">
                <span>Sun</span>
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
            </div>
            <div class="calendar-days" id="calendar-days">
                <!-- Days will be generated by JS -->
            </div>
            <div class="calendar-footer">
                <button class="btn-cancel" onclick="app.closeCalendar()">Cancel</button>
                <button class="btn-today" onclick="app.calendarGoToToday()">Go to Today</button>
            </div>
        </div>
    </div>

    <!-- Schedule Meeting Modal (Simple - from company) -->
    <div id="schedule-modal" class="schedule-modal">
        <div class="schedule-modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold text-slate-800">Schedule Meeting</h3>
                <button onclick="app.closeScheduleModal()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="schedule-company-id">

                <div class="flex items-center gap-3 mb-4 p-3 bg-slate-50 rounded-xl">
                    <div class="company-avatar" id="schedule-company-avatar">AB</div>
                    <div>
                        <p class="font-bold text-slate-800" id="schedule-company-name">Company Name</p>
                        <p class="text-xs text-slate-500" id="schedule-company-contact">Contact Person</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Meeting Date *</label>
                    <input type="date" id="schedule-date">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="schedule-start" value="09:00">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="schedule-end" value="10:00">
                    </div>
                </div>

                <div class="form-group">
                    <label>Subject (optional)</label>
                    <input type="text" id="schedule-subject" placeholder="e.g., Rate Discussion, Contract Review">
                </div>

                <div class="form-group">
                    <label>Scheduled By (Your Email) *</label>
                    <input type="email" id="schedule-by-email" placeholder="your.email@example.com" required>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="app.closeScheduleModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold text-sm">
                        Cancel
                    </button>
                    <button id="schedule-btn" onclick="app.confirmScheduleMeeting()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
                        Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Meeting Detail Modal -->
    <div id="meeting-modal" class="meeting-modal">
        <div class="meeting-modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold text-slate-800" id="meeting-modal-title">Meeting Details</h3>
                <button onclick="app.closeMeetingModal()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="meeting-id">

                <!-- DETAILS VIEW (Read-only) -->
                <div id="meeting-details-view">
                    <!-- Meeting Info Header -->
                    <div class="flex items-center gap-3 mb-4 p-3 bg-slate-50 rounded-xl">
                        <div class="company-avatar" id="meeting-company-avatar">AB</div>
                        <div class="flex-1">
                            <p class="font-bold text-slate-800" id="meeting-company-display">Company Name</p>
                            <p class="text-xs text-[#3BC1A8] font-medium" id="meeting-subject-display"></p>
                            <p class="text-xs text-slate-500" id="meeting-time-display">9:00 AM - 10:00 AM</p>
                            <p class="text-xs text-blue-600" id="meeting-created-by-display"></p>
                        </div>
                        <span class="meeting-status scheduled" id="meeting-status-badge">Scheduled</span>
                    </div>

                    <!-- Meeting Details Grid -->
                    <div class="mb-4">
                        <p class="text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-2">
                            <i class="ph ph-info"></i> Meeting Details
                        </p>
                        <div id="meeting-details-grid" class="grid grid-cols-2 gap-2 p-3 bg-white border border-slate-200 rounded-xl text-xs">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Our Offers (Linked Rates) -->
                    <div class="mb-4">
                        <p class="text-[11px] uppercase tracking-wider text-emerald-600 font-semibold mb-2">
                            <i class="ph ph-export"></i> Our Offers
                        </p>
                        <div id="linked-rates-display" class="overflow-x-auto">
                            <p class="text-sm text-slate-400 italic p-3 bg-white border border-slate-200 rounded-xl">No offers linked</p>
                        </div>
                    </div>

                    <!-- Client Offers -->
                    <div class="mb-4" id="client-offers-section">
                        <p class="text-[11px] uppercase tracking-wider text-[#3BC1A8] font-semibold mb-2">
                            <i class="ph ph-download"></i> Client Offers
                        </p>
                        <div id="client-offers-display">
                            <span class="text-slate-400 italic text-sm">No client offers</span>
                        </div>
                    </div>

                    <!-- Attachments Display -->
                    <div class="mb-4">
                        <p class="text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-2">
                            <i class="ph ph-paperclip"></i> Attachments
                        </p>
                        <div id="meeting-files-display" class="space-y-2">
                            <p class="text-sm text-slate-400 italic p-3 bg-white border border-slate-200 rounded-xl">No attachments</p>
                        </div>
                    </div>

                    <!-- Notes Display -->
                    <div class="mb-4">
                        <p class="text-[11px] uppercase tracking-wider text-slate-500 font-semibold mb-2">
                            <i class="ph ph-note-pencil"></i> Notes
                        </p>
                        <div id="meeting-notes-display" class="p-3 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 min-h-[40px]">
                            <span class="text-slate-400 italic">No notes</span>
                        </div>
                    </div>

                    <!-- Actions for Details View -->
                    <div class="flex gap-3 mt-6">
                        <button onclick="app.closeMeetingModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold text-sm">
                            Close
                        </button>
                        <button id="meeting-action-btn" onclick="app.switchToEditMode()" class="flex-1 py-3 bg-[#3BC1A8] text-white rounded-xl font-semibold text-sm flex items-center justify-center gap-2">
                            <i class="ph-bold ph-pencil-simple"></i> <span id="meeting-action-text">Edit</span>
                        </button>
                    </div>
                </div>

                <!-- EDIT VIEW (Form) -->
                <div id="meeting-edit-view" class="hidden">
                    <!-- Meeting Info Header (same) -->
                    <div class="flex items-center gap-3 mb-4 p-3 bg-slate-50 rounded-xl">
                        <div class="company-avatar" id="meeting-company-avatar-edit">AB</div>
                        <div class="flex-1">
                            <p class="font-bold text-slate-800" id="meeting-company-display-edit">Company Name</p>
                            <p class="text-xs text-slate-500" id="meeting-time-display-edit">9:00 AM - 10:00 AM</p>
                            <p class="text-xs text-blue-600" id="meeting-created-by-display-edit"></p>
                        </div>
                    </div>

                    <!-- Meeting Details Form -->
                    <div class="form-group">
                        <label>Meeting Details</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Strong Region</span>
                                <textarea id="meeting-strong-region" placeholder="Enter strong regions..." class="meeting-detail-textarea"></textarea>
                            </div>
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Looking For</span>
                                <textarea id="meeting-looking-for" placeholder="What they're looking for..." class="meeting-detail-textarea"></textarea>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Status</span>
                                <select id="meeting-status-select" class="w-full">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Reason</span>
                                <textarea id="meeting-reason" placeholder="Reason..." class="meeting-detail-textarea"></textarea>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Payable/Receivable</span>
                                <textarea id="meeting-payable" placeholder="Payment terms..." class="meeting-detail-textarea"></textarea>
                            </div>
                            <div>
                                <span class="text-[10px] text-slate-400 block mb-1">Deal Proposals</span>
                                <textarea id="meeting-deal-proposals" placeholder="Deal proposals..." class="meeting-detail-textarea"></textarea>
                            </div>
                        </div>
                        <div>
                            <span class="text-[10px] text-slate-400 block mb-1">Route Issue</span>
                            <textarea id="meeting-route-issue" placeholder="Any route issues..." class="meeting-detail-textarea"></textarea>
                        </div>
                    </div>

                    <!-- Our Offers (Link Rates) -->
                    <div class="form-group">
                        <label class="text-emerald-600"><i class="ph ph-export"></i> Our Offers (Link Rate Data)</label>
                        <div class="rate-search-container">
                            <input type="text" id="meeting-rate-search" placeholder="Search rates by destination, product..."
                                   oninput="app.searchRates(this.value)"
                                   onfocus="app.showRateSuggestions()"
                                   autocomplete="off">
                            <div id="rate-suggestions" class="rate-suggestions hidden">
                                <!-- Suggestions will appear here -->
                            </div>
                        </div>
                        <div class="linked-data" id="linked-rates">
                            <!-- Linked rate tags will appear here -->
                        </div>
                    </div>

                    <!-- Client Offers -->
                    <div class="form-group">
                        <label class="text-[#3BC1A8] flex items-center gap-2 mb-2">
                            <i class="ph ph-download"></i> Client Offers
                        </label>

                        <!-- SMS Client Offers Table -->
                        <div id="sms-client-offers-table" class="hidden">
                            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Designation</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Product</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Network</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Rate</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Traffic</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Display</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">TPS</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">CAP</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">HOP</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold w-8"></div></th>
                                        </tr>
                                    </thead>
                                    <tbody id="sms-client-offers-rows">
                                        <!-- Rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" onclick="app.addClientOfferRow('SMS')" class="mt-2 px-3 py-1.5 bg-[#3BC1A8] text-white rounded-lg text-xs font-semibold flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Add Row
                            </button>
                        </div>

                        <!-- VOICE Client Offers Table -->
                        <div id="voice-client-offers-table" class="hidden">
                            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Destination</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Product</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Breakout</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Rate</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Billing Increment</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">Display</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">ACD</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">ASR</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold">HOP</div></th>
                                            <th><div class="px-3 py-2 text-white text-xs font-semibold w-8"></div></th>
                                        </tr>
                                    </thead>
                                    <tbody id="voice-client-offers-rows">
                                        <!-- Rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" onclick="app.addClientOfferRow('VOICE')" class="mt-2 px-3 py-1.5 bg-[#249E94] text-white rounded-lg text-xs font-semibold flex items-center gap-1">
                                <i class="ph-bold ph-plus"></i> Add Row
                            </button>
                        </div>
                    </div>

                    <!-- Attachments -->
                    <div class="form-group">
                        <label>Attachments</label>
                        <label class="flex items-center justify-center gap-2 p-4 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50">
                            <i class="ph ph-paperclip text-slate-400 text-xl"></i>
                            <span class="text-sm text-slate-600">Attach files</span>
                            <input type="file" multiple onchange="app.handleMeetingFiles(event)" class="hidden">
                        </label>
                        <div class="file-list" id="meeting-files">
                            <!-- File items will appear here -->
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="meeting-notes" placeholder="Additional notes..."></textarea>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="app.switchToDetailsMode()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold text-sm">
                            Cancel
                        </button>
                        <button onclick="app.deleteMeeting()" class="py-3 px-4 bg-red-100 text-red-600 rounded-xl font-semibold text-sm">
                            <i class="ph-fill ph-trash"></i>
                        </button>
                        <button id="meeting-save-btn" onclick="app.saveMeetingDetails()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="meeting-modal">
        <div class="meeting-modal-content" style="max-width: 95%; width: 1200px;">
            <div class="modal-header">
                <h3 class="text-lg font-bold text-slate-800">Compare Client Offers</h3>
                <button onclick="app.closeComparisonModal()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="comparison-content">
                    <!-- Comparison table will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <main id="app" class="safe-top safe-bottom safe-left safe-right">

        <!-- Header -->
        <header class="bg-slate-900 text-white shrink-0 shadow-lg">

            <!-- Mini Title Bar -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-slate-800">
                <div class="flex items-center">
                    <img src="logo.gif" alt="KOL Logo" class="h-12 w-auto object-contain" style="max-width: 180px;">
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.toggleHeader()" id="header-toggle" class="p-2 rounded-lg bg-slate-800 active:bg-slate-700 flex items-center gap-1.5 text-xs font-medium">
                        <i class="ph-bold ph-caret-up text-sm" id="toggle-icon"></i>
                        <span id="toggle-text">Collapse</span>
                    </button>
                </div>
            </div>

            <!-- Collapsed Summary -->
            <div id="collapsed-summary" class="collapsed-summary">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="badge" id="sum-type">-</span>
                    <i class="ph ph-caret-right text-xs opacity-50"></i>
                    <span class="badge" id="sum-list">-</span>
                    <i class="ph ph-caret-right text-xs opacity-50"></i>
                    <span class="badge" id="sum-region">-</span>
                </div>
                <button onclick="app.toggleHeader()" class="text-white/80 text-[10px] underline">Edit</button>
            </div>

            <!-- Collapsible Content -->
            <div id="header-content" class="header-content px-4 pb-3 pt-2">
                <!-- Step 1: SMS / Voice -->
                <div class="mb-3">
                    <p class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold mb-1.5">Step 1: Type</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="app.setServiceType('SMS')" id="btn-sms"
                            class="touch-btn flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 border-2 border-slate-700 text-slate-400">
                            <i class="ph-fill ph-chat-circle-text text-lg"></i> SMS
                        </button>
                        <button onclick="app.setServiceType('VOICE')" id="btn-voice"
                            class="touch-btn flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 border-2 border-slate-700 text-slate-400">
                            <i class="ph-fill ph-phone text-lg"></i> Voice
                        </button>
                    </div>
                </div>

                <!-- Step 2: Target / Push List -->
                <div id="list-type-section" class="section-hidden">
                    <p class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold mb-1.5">Step 2: List Type</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="app.setListType('TARGET')" id="btn-target"
                            class="touch-btn flex items-center justify-center gap-2 py-2 rounded-xl text-xs font-bold uppercase tracking-wide transition-all duration-200 border-2 border-slate-700 text-slate-400">
                            <i class="ph-fill ph-target text-base"></i> Target List
                        </button>
                        <button onclick="app.setListType('PUSH')" id="btn-push"
                            class="touch-btn flex items-center justify-center gap-2 py-2 rounded-xl text-xs font-bold uppercase tracking-wide transition-all duration-200 border-2 border-slate-700 text-slate-400">
                            <i class="ph-fill ph-arrow-circle-up text-base"></i> Push List
                        </button>
                    </div>
                </div>

                <!-- Step 3: Region Selection -->
                <div id="region-section-header" class="section-hidden mt-3">
                    <p class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold mb-1.5">Step 3: Region</p>
                    <div class="grid grid-cols-3 gap-2" id="region-grid-header"></div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden bg-surface" id="main-scroll">

            <!-- Data Table Section -->
            <div id="table-section" class="section-hidden flex flex-col h-full">

                <!-- Table Header Bar -->
                <div class="px-4 py-2 bg-white border-b border-slate-100 flex justify-between items-center sticky top-0 z-20">
                    <div class="min-w-0 flex-1">
                        <h2 class="text-sm font-bold text-slate-800 truncate">Rate Configuration</h2>
                        <p class="text-[10px] text-slate-500 truncate" id="table-context">SMS > Target > APAC</p>
                    </div>
                    <div class="flex gap-2 ml-2 shrink-0 relative">
                        <!-- Action Menu Toggle -->
                        <button onclick="app.toggleActionMenu()" id="action-menu-btn" class="touch-btn px-3 py-2 bg-slate-100 text-slate-700 text-xs font-semibold rounded-lg active:bg-slate-200 flex items-center gap-1">
                            <i class="ph-bold ph-dots-three-outline-vertical"></i>
                        </button>

                        <!-- Action Menu Dropdown -->
                        <div id="action-menu" class="action-menu">
                            <button onclick="app.downloadTemplate()">
                                <i class="ph ph-file-arrow-down text-[#3BC1A8]"></i>
                                Download Template
                            </button>
                            <button onclick="app.openImportModal()">
                                <i class="ph ph-file-arrow-up text-emerald-500"></i>
                                Import Excel
                            </button>
                            <button onclick="app.exportToExcel()">
                                <i class="ph ph-export text-[#249E94]"></i>
                                Export Data
                            </button>
                            <button onclick="app.exportAllRegions()">
                                <i class="ph ph-database text-blue-600"></i>
                                Export All Regions
                            </button>
                            <hr>
                            <button onclick="app.addRow()">
                                <i class="ph ph-plus-circle text-slate-500"></i>
                                Add Row
                            </button>
                            <button onclick="app.clearAllData()">
                                <i class="ph ph-trash text-red-500"></i>
                                Clear All Data
                            </button>
                        </div>

                        <button onclick="app.saveData()" class="touch-btn px-3 py-2 bg-emerald-600 text-white text-xs font-semibold rounded-lg active:bg-emerald-700 flex items-center gap-1">
                            <i class="ph-bold ph-floppy-disk"></i> Save
                        </button>
                        <button onclick="app.requestLandscape()" id="rotate-btn" class="touch-btn px-3 py-2 bg-[#3BC1A8] text-white text-xs font-semibold rounded-lg active:bg-[#249E94] flex items-center gap-1 landscape-hidden">
                            <i class="ph-bold ph-device-rotate"></i>
                        </button>
                        <button onclick="app.exitFullscreenMode()" id="exit-fullscreen-btn" class="touch-btn px-3 py-2 bg-red-600 text-white text-xs font-semibold rounded-lg active:bg-red-700 items-center gap-1 hidden">
                            <i class="ph-bold ph-arrows-in"></i> Exit
                        </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="flex-1 overflow-x-auto overflow-y-auto" id="table-container">
                    <table class="data-table w-full">
                        <thead id="table-head">
                            <!-- Dynamic headers via JS -->
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>

                <!-- Datalists for dropdown fields (SMS only) -->
                <datalist id="datalist-product"></datalist>
                <datalist id="datalist-network"></datalist>
                <datalist id="datalist-traffic"></datalist>
                <!-- Country Autocomplete Dropdown -->
                <div id="country-autocomplete" class="country-autocomplete"></div>

                <!-- Row Count Footer -->
                <div class="px-4 py-2 bg-slate-50 border-t border-slate-200 flex justify-between items-center text-[10px] text-slate-500 shrink-0">
                    <span id="row-count">0 rows</span>
                    <span>Auto-saved</span>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center py-12 text-center px-6">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-400">
                    <i class="ph ph-list-checks text-3xl"></i>
                </div>
                <h3 class="text-sm font-semibold text-slate-900" id="empty-title">Get Started</h3>
                <p class="text-xs text-slate-500 mt-1 max-w-[220px]" id="empty-desc">Select SMS or Voice above to begin.</p>
            </div>

            <!-- Meetings Section -->
            <div id="meetings-section" class="hidden flex flex-col flex-1" style="min-height: 0;">
                <!-- Service Type Toggle for Meetings -->
                <div class="bg-slate-900 px-4 py-2 shrink-0">
                    <div class="flex gap-2">
                        <button onclick="app.setMeetingsServiceType('SMS')" id="meeting-sms-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white">
                            <i class="ph-bold ph-chat-text"></i> SMS
                        </button>
                        <button onclick="app.setMeetingsServiceType('VOICE')" id="meeting-voice-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300">
                            <i class="ph-bold ph-phone-call"></i> Voice
                        </button>
                    </div>
                </div>

                <!-- Meeting Header with Date Nav -->
                <div class="meeting-header shrink-0">
                    <div class="date-nav">
                        <button onclick="app.prevDay()" class="touch-btn">
                            <i class="ph-bold ph-caret-left"></i>
                        </button>
                        <button onclick="app.openCalendar()" class="text-center flex-1 py-2 px-4 rounded-xl hover:bg-slate-50 active:bg-slate-100 transition-colors">
                            <p class="font-bold text-slate-800 text-sm" id="meeting-date-display">Feb 2, 2024</p>
                            <p class="text-[10px] text-slate-500 mt-0.5" id="meeting-day-name">Today</p>
                        </button>
                        <button onclick="app.nextDay()" class="touch-btn">
                            <i class="ph-bold ph-caret-right"></i>
                        </button>
                        <button onclick="app.goToToday()" class="touch-btn px-3 text-xs font-semibold text-[#3BC1A8]">
                            Today
                        </button>
                    </div>
                </div>

                <!-- Time Slots Container -->
                <div class="flex-1 overflow-y-auto" id="time-slots-container" style="min-height: 0;">
                    <!-- Time slots will be generated by JS -->
                </div>

                <!-- Meeting Count Footer -->
                <div class="px-4 py-2 bg-slate-50 border-t border-slate-200 flex justify-between items-center text-[10px] text-slate-500 shrink-0">
                    <span id="meeting-count">0 meetings</span>
                    <span>Tap meeting to add notes</span>
                </div>
            </div>

            <!-- Companies Section -->
            <div id="companies-section" class="hidden flex flex-col flex-1" style="min-height: 0;">
                <!-- Service Type Toggle for Companies -->
                <div class="bg-slate-900 px-4 py-2 shrink-0">
                    <div class="flex gap-2">
                        <button onclick="app.setCompaniesServiceType('SMS')" id="company-sms-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white">
                            <i class="ph-bold ph-chat-text"></i> SMS
                        </button>
                        <button onclick="app.setCompaniesServiceType('VOICE')" id="company-voice-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300">
                            <i class="ph-bold ph-phone-call"></i> Voice
                        </button>
                    </div>
                </div>

                <!-- Companies Header -->
                <div class="bg-white border-b border-slate-200 px-4 py-3 shrink-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-base font-bold text-slate-800" id="companies-title">SMS Companies</h2>
                            <p class="text-[10px] text-slate-500">Manage companies & schedule meetings</p>
                        </div>
                        <button onclick="app.toggleAddCompanyForm()" id="add-company-btn" class="touch-btn px-3 py-2 bg-[#3BC1A8] text-white text-xs font-semibold rounded-lg flex items-center gap-1">
                            <i class="ph-bold ph-plus"></i> Add
                        </button>
                    </div>
                </div>

                <!-- Add Company Form (hidden by default) -->
                <div id="add-company-form" class="hidden px-4 pt-4">
                    <div class="add-company-form">
                        <input type="text" id="new-company-name" placeholder="Company Name *">
                        <input type="text" id="new-company-delegate" placeholder="Delegate / Region">
                        <input type="email" id="new-company-email" placeholder="Email">
                        <input type="tel" id="new-company-phone" placeholder="Phone">
                        <input type="email" id="new-company-created-by" placeholder="Created By (Your Email) *" required>
                        <div class="flex gap-2 mt-2">
                            <button onclick="app.toggleAddCompanyForm()" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg font-semibold text-sm">Cancel</button>
                            <button onclick="app.saveNewCompany()" class="flex-1 py-2 bg-[#3BC1A8] text-white rounded-lg font-semibold text-sm">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Companies List -->
                <div class="flex-1 overflow-y-auto px-4 py-4" id="companies-list">
                    <!-- Company cards will be generated by JS -->
                </div>

                <!-- Companies Count Footer -->
                <div class="px-4 py-2 bg-slate-50 border-t border-slate-200 flex justify-between items-center text-[10px] text-slate-500 shrink-0">
                    <span id="company-count">0 companies</span>
                    <span>Tap schedule to book meeting</span>
                </div>
            </div>

            <!-- Client Offers Section -->
        <div id="clientoffers-section" class="hidden flex flex-col flex-1" style="min-height: 0;">
            <!-- Service Type Toggle for Client Offers -->
            <div class="bg-slate-900 px-4 py-2 shrink-0">
                <div class="flex gap-2">
                    <button onclick="app.setClientOffersServiceType('SMS')" id="clientoffers-sms-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white">
                        <i class="ph-bold ph-chat-text"></i> SMS
                    </button>
                    <button onclick="app.setClientOffersServiceType('VOICE')" id="clientoffers-voice-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300">
                        <i class="ph-bold ph-phone-call"></i> Voice
                    </button>
                </div>
            </div>

            <div class="bg-white border-b border-slate-200 px-4 py-3 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h2 class="text-base font-bold text-slate-800" id="clientoffers-title">SMS Client Offers</h2>
                            <button
                                onclick="app.toggleClientOffersFilters()"
                                class="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors flex items-center gap-1"
                                title="Toggle Filters"
                                id="clientoffers-filter-toggle"
                            >
                                <i class="ph-bold ph-funnel"></i> Filters
                                <i class="ph-bold ph-caret-down" id="clientoffers-filter-icon"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-500">View all client offers from all companies</p>
                    </div>
                    <button
                        onclick="app.exportClientOffers()"
                        class="px-3 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors flex items-center gap-1"
                        title="Export to Excel"
                    >
                        <i class="ph-bold ph-export"></i> Export
                    </button>
                </div>

                <!-- Filters -->
                <div class="mt-3 space-y-2" id="clientoffers-filters">
                    <!-- Row 1: Search and Dates -->
                    <div class="flex gap-2 flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <input
                                type="text"
                                id="clientoffers-search"
                                placeholder="Search by company name..."
                                class="w-full px-3 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                oninput="app.filterClientOffers()"
                            />
                        </div>
                        <div class="flex gap-2">
                            <input
                                type="date"
                                id="clientoffers-date-from"
                                class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                onchange="app.filterClientOffers()"
                                title="From Date"
                            />
                            <input
                                type="date"
                                id="clientoffers-date-to"
                                class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                onchange="app.filterClientOffers()"
                                title="To Date"
                            />
                        </div>
                    </div>

                    <!-- Row 2: Primary Column Filters -->
                    <div class="flex gap-2 flex-wrap items-center">
                        <select id="clientoffers-filter-designation" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Destinations</option>
                        </select>
                        <select id="clientoffers-filter-product" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Products</option>
                        </select>
                        <select id="clientoffers-filter-network" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Networks</option>
                        </select>
                        <select id="clientoffers-filter-rate" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Rates</option>
                        </select>
                        <select id="clientoffers-filter-traffic" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Traffic</option>
                        </select>
                        <select id="clientoffers-filter-display" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All Display</option>
                        </select>
                    </div>

                    <!-- Row 3: Additional Filters & Actions -->
                    <div class="flex gap-2 flex-wrap items-center">
                        <select id="clientoffers-filter-tps" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All TPS</option>
                        </select>
                        <select id="clientoffers-filter-cap" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All CAP</option>
                        </select>
                        <select id="clientoffers-filter-hop" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterClientOffers()">
                            <option value="">All HOP</option>
                        </select>
                        <button
                            onclick="app.toggleComparisonMode()"
                            id="comparison-mode-btn"
                            class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1"
                            title="Compare selected offers"
                        >
                            <i class="ph-bold ph-git-diff"></i> Compare
                        </button>
                        <button
                            onclick="app.clearClientOffersFilters()"
                            class="px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors"
                            title="Clear Filters"
                        >
                            <i class="ph-bold ph-x"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-4 py-4" id="clientoffers-content" style="min-height: 0;">
                <!-- Content will be populated here -->
            </div>
        </div>

        <!-- Our Offers Section -->
        <div id="ouroffers-section" class="hidden flex flex-col flex-1" style="min-height: 0;">
            <!-- Service Type Toggle for Our Offers -->
            <div class="bg-slate-900 px-4 py-2 shrink-0">
                <div class="flex gap-2">
                    <button onclick="app.setOurOffersServiceType('SMS')" id="ouroffers-sms-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white">
                        <i class="ph-bold ph-chat-text"></i> SMS
                    </button>
                    <button onclick="app.setOurOffersServiceType('VOICE')" id="ouroffers-voice-btn" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300">
                        <i class="ph-bold ph-phone-call"></i> Voice
                    </button>
                </div>
            </div>

            <div class="bg-white border-b border-slate-200 px-4 py-3 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h2 class="text-base font-bold text-slate-800" id="ouroffers-title">SMS Our Offers</h2>
                            <button
                                onclick="app.toggleOurOffersFilters()"
                                class="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors flex items-center gap-1"
                                title="Toggle Filters"
                                id="ouroffers-filter-toggle"
                            >
                                <i class="ph-bold ph-funnel"></i> Filters
                                <i class="ph-bold ph-caret-down" id="ouroffers-filter-icon"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-500">View all our offers linked to meetings</p>
                    </div>
                    <button
                        onclick="app.exportOurOffers()"
                        class="px-3 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors flex items-center gap-1"
                        title="Export to Excel"
                    >
                        <i class="ph-bold ph-export"></i> Export
                    </button>
                </div>

                <!-- Filters -->
                <div class="mt-3 space-y-2" id="ouroffers-filters">
                    <!-- Row 1: Search and Dates -->
                    <div class="flex gap-2 flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <input
                                type="text"
                                id="ouroffers-search"
                                placeholder="Search by company name..."
                                class="w-full px-3 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                oninput="app.filterOurOffers()"
                            />
                        </div>
                        <div class="flex gap-2">
                            <input
                                type="date"
                                id="ouroffers-date-from"
                                class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                onchange="app.filterOurOffers()"
                                title="From Date"
                            />
                            <input
                                type="date"
                                id="ouroffers-date-to"
                                class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500"
                                onchange="app.filterOurOffers()"
                                title="To Date"
                            />
                        </div>
                    </div>

                    <!-- Row 2: Primary Column Filters -->
                    <div class="flex gap-2 flex-wrap items-center">
                        <select id="ouroffers-filter-designation" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Destinations</option>
                        </select>
                        <select id="ouroffers-filter-product" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Products</option>
                        </select>
                        <select id="ouroffers-filter-network" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Networks</option>
                        </select>
                        <select id="ouroffers-filter-rate" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Rates</option>
                        </select>
                        <select id="ouroffers-filter-traffic" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Traffic</option>
                        </select>
                        <select id="ouroffers-filter-display" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All Display</option>
                        </select>
                    </div>

                    <!-- Row 3: Additional Filters & Actions -->
                    <div class="flex gap-2 flex-wrap items-center">
                        <select id="ouroffers-filter-tps" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All TPS</option>
                        </select>
                        <select id="ouroffers-filter-cap" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All CAP</option>
                        </select>
                        <select id="ouroffers-filter-hop" class="px-2 py-1.5 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-teal-500" onchange="app.filterOurOffers()">
                            <option value="">All HOP</option>
                        </select>
                        <button
                            onclick="app.toggleOurOffersComparisonMode()"
                            id="ouroffers-comparison-mode-btn"
                            class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1"
                            title="Compare selected offers"
                        >
                            <i class="ph-bold ph-git-diff"></i> Compare
                        </button>
                        <button
                            onclick="app.clearOurOffersFilters()"
                            class="px-3 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors"
                            title="Clear Filters"
                        >
                            <i class="ph-bold ph-x"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-4 py-4" id="ouroffers-content" style="min-height: 0;">
                <!-- Content will be populated here -->
            </div>
        </div>

        </div><!-- End main-scroll -->

        <!-- Rate Preview Panel -->
        <div id="rate-preview-panel" class="rate-preview-panel">
            <div class="rate-preview-header">
                <h3>Rate Details</h3>
                <button onclick="app.closeRatePreview()" class="text-slate-400">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="rate-preview-content">
                <table class="rate-preview-table" id="rate-preview-table">
                    <!-- Rate data will be populated here -->
                </table>
            </div>
            <div class="rate-preview-actions">
                <button onclick="app.closeRatePreview()" class="bg-slate-100 text-slate-600">Cancel</button>
                <button onclick="app.confirmLinkRate()" class="bg-[#3BC1A8] text-white">Link This Rate</button>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-5 py-2.5 rounded-full shadow-xl flex items-center gap-2 transition-all duration-300 transform -translate-y-20 z-[100]">
            <i class="ph-fill ph-check-circle text-green-400 text-lg"></i>
            <span class="text-xs font-medium" id="toast-msg">Success</span>
        </div>

        <!-- Bottom Tab Navigation -->
        <nav class="bottom-tabs shrink-0">
            <button onclick="app.switchTab('rates')" id="tab-rates" class="tab-btn active">
                <i class="ph-fill ph-chart-line-up"></i>
                <span>Rates</span>
            </button>
            <button onclick="app.switchTab('companies')" id="tab-companies" class="tab-btn">
                <i class="ph-fill ph-buildings"></i>
                <span>Companies</span>
            </button>
            <button onclick="app.switchTab('clientoffers')" id="tab-clientoffers" class="tab-btn">
                <i class="ph-fill ph-download"></i>
                <span>Client Offers</span>
            </button>
            <button onclick="app.switchTab('ouroffers')" id="tab-ouroffers" class="tab-btn">
                <i class="ph-fill ph-upload"></i>
                <span>Our Offers</span>
            </button>
            <button onclick="app.switchTab('meetings')" id="tab-meetings" class="tab-btn">
                <i class="ph-fill ph-calendar-check"></i>
                <span>Meetings</span>
            </button>
        </nav>

    </main>

    <script>
        // ========================================
        // SUPABASE CONFIGURATION
        // ========================================
        const SUPABASE_URL = 'https://cjtnbhnwdiprajdrkaai.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqdG5iaG53ZGlwcmFqZHJrYWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTk5MjYsImV4cCI6MjA4NTU5NTkyNn0.6Tqy1jW_CYRxg5JX4t0teB4aTg6Fyj0O0Paszsn8ThY';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global loading state
        let isLoading = false;

        // ========================================
        // REGIONS & COUNTRIES DATA
        // ========================================
        const regions = [
            { id: 'APAC', label: 'Asia Pacific' },
            { id: 'EUR', label: 'Europe' },
            { id: 'AFR', label: 'Africa' },
            { id: 'MENA', label: 'MENA' },
            { id: 'EURASIA', label: 'EURASIA' },
            { id: 'LATAM', label: 'LatAm' },
        ];

        // Countries by Region
        const REGION_COUNTRIES = {
            'APAC': [
                'Australia', 'New Zealand', 'Fiji', 'Papua New Guinea', 'Samoa', 'Tonga', 'Vanuatu', 'Solomon Islands',
                'Kiribati', 'Marshall Islands', 'Micronesia', 'Nauru', 'Palau', 'Tuvalu', 'Cook Islands',
                'India', 'Pakistan', 'Bangladesh', 'Sri Lanka', 'Nepal', 'Bhutan', 'Maldives', 'Afghanistan',
                'China', 'Japan', 'South Korea', 'North Korea', 'Taiwan', 'Hong Kong', 'Macau', 'Mongolia',
                'Thailand', 'Vietnam', 'Malaysia', 'Singapore', 'Indonesia', 'Philippines', 'Myanmar', 'Cambodia',
                'Laos', 'Brunei', 'Timor-Leste'
            ],
            'EUR': [
                'United Kingdom', 'Germany', 'France', 'Italy', 'Spain', 'Portugal', 'Netherlands', 'Belgium',
                'Austria', 'Switzerland', 'Poland', 'Czech Republic', 'Hungary', 'Romania', 'Bulgaria', 'Greece',
                'Sweden', 'Norway', 'Denmark', 'Finland', 'Ireland', 'Iceland', 'Luxembourg', 'Malta', 'Cyprus',
                'Estonia', 'Latvia', 'Lithuania', 'Slovakia', 'Slovenia', 'Croatia', 'Serbia', 'Bosnia',
                'Montenegro', 'North Macedonia', 'Albania', 'Kosovo', 'Moldova', 'Ukraine', 'Belarus', 'Russia'
            ],
            'ME': [
                'United Arab Emirates', 'Saudi Arabia', 'Qatar', 'Kuwait', 'Bahrain', 'Oman', 'Yemen',
                'Iraq', 'Iran', 'Israel', 'Palestine', 'Jordan', 'Lebanon', 'Syria', 'Turkey',
                'Armenia', 'Azerbaijan', 'Georgia', 'Cyprus'
            ],
            'AFR': [
                'South Africa', 'Nigeria', 'Egypt', 'Kenya', 'Ghana', 'Morocco', 'Algeria', 'Tunisia',
                'Ethiopia', 'Tanzania', 'Uganda', 'Rwanda', 'Senegal', 'Ivory Coast', 'Cameroon', 'Angola',
                'Mozambique', 'Zimbabwe', 'Zambia', 'Botswana', 'Namibia', 'Mauritius', 'Madagascar',
                'Democratic Republic of Congo', 'Sudan', 'Libya', 'Mali', 'Niger', 'Burkina Faso', 'Benin',
                'Togo', 'Sierra Leone', 'Liberia', 'Guinea', 'Gambia', 'Cape Verde', 'Mauritania', 'Malawi'
            ],
            'LATAM': [
                'Brazil', 'Mexico', 'Argentina', 'Colombia', 'Chile', 'Peru', 'Venezuela', 'Ecuador',
                'Bolivia', 'Paraguay', 'Uruguay', 'Panama', 'Costa Rica', 'Guatemala', 'Honduras',
                'El Salvador', 'Nicaragua', 'Cuba', 'Dominican Republic', 'Puerto Rico', 'Jamaica',
                'Trinidad and Tobago', 'Haiti', 'Bahamas', 'Barbados', 'Guyana', 'Suriname', 'Belize'
            ],
            'NA': [
                'United States', 'Canada', 'USA - AT&T', 'USA - Verizon', 'USA - T-Mobile', 'USA - Sprint',
                'Canada - Rogers', 'Canada - Bell', 'Canada - Telus'
            ],
            'MENA': [
                // GCC Countries
                'Saudi Arabia', 'United Arab Emirates', 'Qatar', 'Kuwait', 'Bahrain', 'Oman',
                // Other Middle East
                'Israel', 'Jordan', 'Lebanon', 'Iraq', 'Iran', 'Yemen', 'Syria', 'Palestine',
                // North Africa
                'Egypt', 'Morocco', 'Algeria', 'Tunisia', 'Libya', 'Sudan'
            ],
            'EURASIA': [
                // Eastern Europe
                'Russia', 'Ukraine', 'Belarus', 'Moldova',
                // South Caucasus
                'Armenia', 'Azerbaijan', 'Georgia',
                // Central Asia
                'Kazakhstan', 'Uzbekistan', 'Turkmenistan', 'Kyrgyzstan', 'Tajikistan'
            ]
        };

        // SMS Columns
        const SMS_COLUMNS = ['designation', 'product', 'network', 'rate', 'traffic', 'display', 'tps', 'cap', 'hop'];
        const SMS_HEADERS = ['Designation', 'Product', 'Network', 'Rate', 'Traffic', 'Display', 'TPS', 'CAP', 'HOP'];

        // Voice Columns
        const VOICE_COLUMNS = ['destination', 'product', 'breakout', 'rate', 'billingIncrement', 'display', 'acd', 'asr', 'hop'];
        const VOICE_HEADERS = ['Destination', 'Product', 'Breakout', 'Rate', 'Billing Increment', 'Display', 'ACD', 'ASR', 'HOP'];

        // Default dropdown options for SMS
        const DEFAULT_PRODUCT_OPTIONS = ['PRIME', 'Direct', 'HQ', 'Premium', 'Wholesale', 'SS7', 'SIM'];
        const DEFAULT_NETWORK_OPTIONS = ['Local Bypass', 'Local to Local', 'Local Direct', 'All Network'];
        const DEFAULT_TRAFFIC_OPTIONS = ['OTP', 'Casino', 'Spam', 'All', 'Marketing'];

        class TelecomApp {
            constructor() {
                this.state = {
                    serviceType: null,
                    listType: null,
                    region: null,
                    data: {},
                    headerCollapsed: false,
                    rotateOverlayDismissed: false,
                    // Custom options added by users (persisted)
                    customOptions: {
                        product: [],
                        network: [],
                        traffic: []
                    },
                    // Meetings data
                    activeTab: 'rates',
                    companiesServiceType: 'SMS',  // SMS or VOICE - for companies tab
                    meetingsServiceType: 'SMS',   // SMS or VOICE - for meetings tab
                    clientOffersServiceType: 'SMS', // SMS or VOICE - for client offers tab
                    ourOffersServiceType: 'SMS', // SMS or VOICE - for our offers tab
                    companies: [], // Array of company objects with serviceType
                    meetings: [], // Array of meeting objects with serviceType
                    currentMeetingDate: new Date().toISOString().split('T')[0],
                    // Track deleted IDs for targeted deletion (not delete-all)
                    deletedRateIds: [],
                    deletedCompanyIds: [],
                    deletedMeetingIds: []
                };
                this.pendingImportData = null;
                this.pendingMeetingFiles = [];
                this.pendingLinkedRates = [];
                this.editingMeetingId = null;
                this.schedulingCompanyId = null;
                // Calendar picker state
                this.calendarViewMonth = new Date().getMonth();
                this.calendarViewYear = new Date().getFullYear();
                this.init();
            }

            // ========================================
            // SUPABASE OPERATIONS
            // ========================================

            async loadFromSupabase() {
                try {
                    // Load rates - each rate is now a separate row
                    const { data: ratesData } = await supabaseClient
                        .from('rates')
                        .select('*')
                        .order('created_at', { ascending: true });

                    // Reconstruct this.state.data from individual rate rows
                    if (ratesData && ratesData.length > 0) {
                        this.state.data = {};

                        ratesData.forEach(rate => {
                            const key = `${rate.service_type}_${rate.list_type}_${rate.region}`;

                            if (!this.state.data[key]) {
                                this.state.data[key] = [];
                            }

                            // Reconstruct rate object based on service type
                            // IMPORTANT: Preserve ID for UPSERT operations
                            const rateObj = {
                                id: rate.id  // Preserve database ID
                            };

                            if (rate.service_type === 'SMS') {
                                rateObj.designation = rate.designation || '';
                                rateObj.product = rate.product || '';
                                rateObj.network = rate.network || '';
                                rateObj.rate = rate.rate || '';
                                rateObj.traffic = rate.traffic || '';
                                rateObj.display = rate.display || '';
                                rateObj.tps = rate.tps || '';
                                rateObj.cap = rate.cap || '';
                                rateObj.hop = rate.hop || '';
                            } else {
                                // VOICE
                                rateObj.destination = rate.destination || '';
                                rateObj.product = rate.product || '';
                                rateObj.breakout = rate.breakout || '';
                                rateObj.rate = rate.rate || '';
                                rateObj.billingIncrement = rate.billing_increment || '';
                                rateObj.display = rate.display || '';
                                rateObj.acd = rate.acd || '';
                                rateObj.asr = rate.asr || '';
                                rateObj.hop = rate.hop || '';
                            }

                            this.state.data[key].push(rateObj);
                        });
                    }

                    // Load companies
                    const { data: companiesData } = await supabaseClient
                        .from('companies')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (companiesData) {
                        this.state.companies = companiesData.map(c => ({
                            id: c.id,
                            company: c.company_name,
                            serviceType: c.service_type,
                            contactPerson: c.contact_person,
                            email: c.email,
                            phone: c.phone,
                            skype: c.skype,
                            whatsapp: c.whatsapp,
                            createdBy: c.created_by
                        }));
                    }

                    // Load meetings
                    const { data: meetingsData } = await supabaseClient
                        .from('meetings')
                        .select(`
                            *,
                            meeting_files(*)
                        `)
                        .order('date', { ascending: false });

                    if (meetingsData) {
                        const allMeetings = meetingsData.map(m => ({
                            id: m.id,
                            companyId: m.company_id,
                            company: m.company,
                            subject: m.subject || '',
                            date: m.date,
                            startTime: m.start_time,
                            endTime: m.end_time,
                            serviceType: m.service_type,
                            status: m.status || 'scheduled',
                            contactPerson: m.contact_person,
                            email: m.email,
                            phone: m.phone,
                            skype: m.skype,
                            whatsapp: m.whatsapp,
                            scheduledBy: m.scheduled_by,
                            strongRegion: m.strong_region,
                            lookingFor: m.looking_for,
                            activeStatus: m.active_status,
                            reason: m.reason,
                            payable: m.payable,
                            dealProposals: m.deal_proposals,
                            routeIssue: m.route_issue,
                            notes: m.notes,
                            clientOffers: m.client_offers || [],
                            linkedRates: m.linked_rates || [],
                            files: (m.meeting_files || []).map(f => ({
                                id: f.id,
                                name: f.file_name,
                                size: f.file_size,
                                type: f.file_type,
                                data: f.file_data
                            }))
                        }));

                        // Load all meetings as-is from DB - no auto-deletion
                        this.state.meetings = allMeetings;

                        // Log meetings with details to verify DB data
                        const withDetails = allMeetings.filter(m => m.strongRegion || m.lookingFor || m.notes || m.activeStatus || m.reason);
                        console.log(` LOADED ${allMeetings.length} meetings from DB, ${withDetails.length} have details`);
                        withDetails.forEach(m => console.log('  ', m.company, '- strongRegion:', m.strongRegion, 'notes:', m.notes?.substring(0, 50)));
                    }

                    // Load custom options
                    const { data: customOptionsData } = await supabaseClient
                        .from('custom_options')
                        .select('*');

                    if (customOptionsData) {
                        this.state.customOptions = {
                            product: customOptionsData.filter(o => o.option_type === 'product').map(o => o.option_value),
                            network: customOptionsData.filter(o => o.option_type === 'network').map(o => o.option_value),
                            traffic: customOptionsData.filter(o => o.option_type === 'traffic').map(o => o.option_value)
                        };
                    }
                } catch (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }
            }

            // Save only a single company to Supabase (fast - 1 DB call)
            async saveSingleCompanyToSupabase(company) {
                const record = {
                    id: company.id,
                    company_name: company.company,
                    service_type: company.serviceType,
                    contact_person: company.contactPerson,
                    email: company.email,
                    phone: company.phone,
                    skype: company.skype,
                    whatsapp: company.whatsapp,
                    created_by: company.createdBy,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabaseClient
                    .from('companies')
                    .upsert([record], { onConflict: 'id' });

                if (error) {
                    console.error('Error upserting company:', error);
                    throw error;
                }
            }

            // Save only a single meeting to Supabase (fast - 1 DB call instead of 80+)
            async saveSingleMeetingToSupabase(meeting) {
                const meetingRecord = {
                    id: meeting.id,
                    company_id: meeting.companyId,
                    company: meeting.company,
                    subject: meeting.subject || '',
                    date: meeting.date,
                    start_time: meeting.startTime,
                    end_time: meeting.endTime,
                    service_type: meeting.serviceType,
                    status: meeting.status || 'scheduled',
                    contact_person: meeting.contactPerson,
                    email: meeting.email,
                    phone: meeting.phone,
                    skype: meeting.skype,
                    whatsapp: meeting.whatsapp,
                    scheduled_by: meeting.scheduledBy,
                    strong_region: meeting.strongRegion,
                    looking_for: meeting.lookingFor,
                    active_status: meeting.activeStatus,
                    reason: meeting.reason,
                    payable: meeting.payable,
                    deal_proposals: meeting.dealProposals,
                    route_issue: meeting.routeIssue,
                    notes: meeting.notes,
                    client_offers: meeting.clientOffers || [],
                    linked_rates: meeting.linkedRates || [],
                    updated_at: new Date().toISOString()
                };

                console.log(' SAVING meeting to DB:', meeting.id, 'Details:', {
                    strongRegion: meeting.strongRegion,
                    lookingFor: meeting.lookingFor,
                    notes: meeting.notes,
                    activeStatus: meeting.activeStatus,
                    reason: meeting.reason
                });

                const { data: upsertData, error } = await supabaseClient
                    .from('meetings')
                    .upsert([meetingRecord], { onConflict: 'id' })
                    .select();

                if (error) {
                    console.error(' UPSERT FAILED for meeting:', meeting.id, error);
                    throw error;
                }

                console.log(' UPSERT SUCCESS for meeting:', meeting.id, 'Returned:', upsertData);

                // Verify: read back from DB to confirm data was actually saved
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('meetings')
                    .select('id, strong_region, looking_for, notes, active_status, reason, deal_proposals')
                    .eq('id', meeting.id)
                    .single();

                if (verifyError) {
                    console.error(' VERIFY READ FAILED:', verifyError);
                } else {
                    console.log(' VERIFY from DB:', verifyData);
                    // Check if details actually saved
                    if (meeting.strongRegion && !verifyData.strong_region) {
                        console.error(' DATA LOSS: strongRegion was sent but not in DB!');
                    }
                    if (meeting.notes && !verifyData.notes) {
                        console.error(' DATA LOSS: notes was sent but not in DB!');
                    }
                }

                // Handle meeting files
                await supabaseClient
                    .from('meeting_files')
                    .delete()
                    .eq('meeting_id', meeting.id);

                if (meeting.files && meeting.files.length > 0) {
                    const fileRecords = meeting.files.map(f => ({
                        meeting_id: meeting.id,
                        file_name: f.name,
                        file_size: f.size,
                        file_type: f.type,
                        file_data: f.data
                    }));

                    const { error: fileError } = await supabaseClient.from('meeting_files').insert(fileRecords);
                    if (fileError) {
                        console.error('Error saving files:', fileError);
                        throw fileError;
                    }
                }
            }

            async saveState() {
                try {
                    // Only save rates and custom options here.
                    // Meetings and companies are saved individually via
                    // saveSingleMeetingToSupabase / saveSingleCompanyToSupabase
                    // to prevent bulk overwrites that wipe meeting details.
                    await Promise.all([
                        this.saveRatesToSupabase(),
                        this.saveCustomOptionsToSupabase()
                    ]);
                } catch (error) {
                    console.error('Error saving to Supabase:', error);
                    this.showToast('Error saving data', 'error');
                }
            }

            async saveRatesToSupabase() {
                try {
                    // Delete only specifically deleted rates (not all)
                    if (this.state.deletedRateIds && this.state.deletedRateIds.length > 0) {
                        const { error: deleteError } = await supabaseClient
                            .from('rates')
                            .delete()
                            .in('id', this.state.deletedRateIds);

                        if (deleteError) {
                            console.error('Error deleting rates:', deleteError);
                        }
                        // Clear deleted IDs after successful deletion
                        this.state.deletedRateIds = [];
                    }

                    // UPSERT rates - each rate row is a separate database record
                    const rateRecords = [];

                    for (const [key, rows] of Object.entries(this.state.data || {})) {
                        const [serviceType, listType, region] = key.split('_');

                        if (rows && Array.isArray(rows) && rows.length > 0) {
                            rows.forEach(row => {
                                // Ensure row has an ID for UPSERT
                                const rateId = row.id || ('rate_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));

                                const record = {
                                    id: rateId,
                                    service_type: serviceType,
                                    list_type: listType,
                                    region: region,
                                    updated_at: new Date().toISOString()
                                };

                                // Update the row's ID in memory if it was just generated
                                if (!row.id) {
                                    row.id = rateId;
                                }

                                // Add fields based on service type
                                if (serviceType === 'SMS') {
                                    record.designation = row.designation || null;
                                    record.product = row.product || null;
                                    record.network = row.network || null;
                                    record.rate = row.rate || null;
                                    record.traffic = row.traffic || null;
                                    record.display = row.display || null;
                                    record.tps = row.tps || null;
                                    record.cap = row.cap || null;
                                    record.hop = row.hop || null;
                                } else if (serviceType === 'VOICE') {
                                    record.destination = row.destination || null;
                                    record.product = row.product || null;
                                    record.breakout = row.breakout || null;
                                    record.rate = row.rate || null;
                                    record.billing_increment = row.billingIncrement || null;
                                    record.display = row.display || null;
                                    record.acd = row.acd || null;
                                    record.asr = row.asr || null;
                                    record.hop = row.hop || null;
                                }

                                rateRecords.push(record);
                            });
                        }
                    }

                    if (rateRecords.length > 0) {
                        // UPSERT in batches of 100 to avoid payload size limits
                        for (let i = 0; i < rateRecords.length; i += 100) {
                            const batch = rateRecords.slice(i, i + 100);
                            const { error } = await supabaseClient
                                .from('rates')
                                .upsert(batch, { onConflict: 'id' });
                            if (error) {
                                console.error('Error upserting batch:', error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error saving rates:', error);
                    throw error;
                }
            }

            async saveCompaniesToSupabase() {
                try {
                    // Delete only specifically deleted companies (not all)
                    if (this.state.deletedCompanyIds && this.state.deletedCompanyIds.length > 0) {
                        const { error: deleteError } = await supabaseClient
                            .from('companies')
                            .delete()
                            .in('id', this.state.deletedCompanyIds);

                        if (deleteError) {
                            console.error('Error deleting companies:', deleteError);
                        }
                        // Clear deleted IDs after successful deletion
                        this.state.deletedCompanyIds = [];
                    }

                    // UPSERT companies
                    const companyRecords = this.state.companies.map(c => ({
                        id: c.id,
                        company_name: c.company,
                        service_type: c.serviceType,
                        contact_person: c.contactPerson,
                        email: c.email,
                        phone: c.phone,
                        skype: c.skype,
                        whatsapp: c.whatsapp,
                        created_by: c.createdBy,
                        updated_at: new Date().toISOString()
                    }));

                    if (companyRecords.length > 0) {
                        const { error } = await supabaseClient
                            .from('companies')
                            .upsert(companyRecords, { onConflict: 'id' });
                        if (error) {
                            console.error('Error upserting companies:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error saving companies:', error);
                }
            }

            async saveMeetingsToSupabase() {
                try {
                    // Delete only specifically deleted meetings (not all)
                    if (this.state.deletedMeetingIds && this.state.deletedMeetingIds.length > 0) {
                        // First delete meeting files for deleted meetings
                        const { error: fileDeleteError } = await supabaseClient
                            .from('meeting_files')
                            .delete()
                            .in('meeting_id', this.state.deletedMeetingIds);

                        if (fileDeleteError) {
                            console.error('Error deleting meeting files:', fileDeleteError);
                        }

                        // Then delete the meetings
                        const { error: deleteError } = await supabaseClient
                            .from('meetings')
                            .delete()
                            .in('id', this.state.deletedMeetingIds);

                        if (deleteError) {
                            console.error('Error deleting meetings:', deleteError);
                        }
                        // Clear deleted IDs after successful deletion
                        this.state.deletedMeetingIds = [];
                    }

                    // UPSERT meetings
                    for (const meeting of this.state.meetings) {
                        const meetingRecord = {
                            id: meeting.id,
                            company_id: meeting.companyId,
                            company: meeting.company,
                            subject: meeting.subject || '',
                            date: meeting.date,
                            start_time: meeting.startTime,
                            end_time: meeting.endTime,
                            service_type: meeting.serviceType,
                            status: meeting.status || 'scheduled',
                            contact_person: meeting.contactPerson,
                            email: meeting.email,
                            phone: meeting.phone,
                            skype: meeting.skype,
                            whatsapp: meeting.whatsapp,
                            scheduled_by: meeting.scheduledBy,
                            strong_region: meeting.strongRegion,
                            looking_for: meeting.lookingFor,
                            active_status: meeting.activeStatus,
                            reason: meeting.reason,
                            payable: meeting.payable,
                            deal_proposals: meeting.dealProposals,
                            route_issue: meeting.routeIssue,
                            notes: meeting.notes,
                            client_offers: meeting.clientOffers || [],
                            linked_rates: meeting.linkedRates || [],
                            updated_at: new Date().toISOString()
                        };

                        const { error } = await supabaseClient
                            .from('meetings')
                            .upsert([meetingRecord], { onConflict: 'id' });

                        if (error) {
                            console.error('Error upserting meeting:', error);
                        }

                        // Handle meeting files - delete existing and re-insert for this meeting
                        // This is necessary because files may have been added/removed
                        await supabaseClient
                            .from('meeting_files')
                            .delete()
                            .eq('meeting_id', meeting.id);

                        if (meeting.files && meeting.files.length > 0) {
                            console.log(` Saving ${meeting.files.length} files for meeting "${meeting.company}"`);
                            const fileRecords = meeting.files.map(f => ({
                                meeting_id: meeting.id,
                                file_name: f.name,
                                file_size: f.size,
                                file_type: f.type,
                                file_data: f.data
                            }));

                            const { error: fileError } = await supabaseClient.from('meeting_files').insert(fileRecords);
                            if (fileError) {
                                console.error(' Error saving files:', fileError);
                            } else {
                                console.log(` Files saved successfully`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error saving meetings:', error);
                }
            }

            async saveCustomOptionsToSupabase() {
                try {
                    // Fetch existing custom options from database
                    const { data: existingOptions } = await supabaseClient
                        .from('custom_options')
                        .select('*');

                    // Build list of current options
                    const currentOptions = [];
                    ['product', 'network', 'traffic'].forEach(type => {
                        (this.state.customOptions[type] || []).forEach(value => {
                            currentOptions.push({ option_type: type, option_value: value });
                        });
                    });

                    // Find options to delete (exist in DB but not in current state)
                    const optionsToDelete = (existingOptions || []).filter(existing =>
                        !currentOptions.some(current =>
                            current.option_type === existing.option_type &&
                            current.option_value === existing.option_value
                        )
                    );

                    // Delete removed options
                    if (optionsToDelete.length > 0) {
                        const idsToDelete = optionsToDelete.map(o => o.id);
                        await supabaseClient
                            .from('custom_options')
                            .delete()
                            .in('id', idsToDelete);
                    }

                    // Find options to insert (exist in current state but not in DB)
                    const optionsToInsert = currentOptions.filter(current =>
                        !(existingOptions || []).some(existing =>
                            existing.option_type === current.option_type &&
                            existing.option_value === current.option_value
                        )
                    );

                    // Insert new options
                    if (optionsToInsert.length > 0) {
                        await supabaseClient.from('custom_options').insert(optionsToInsert);
                    }
                } catch (error) {
                    console.error('Error saving custom options:', error);
                }
            }

            // ========================================
            // INIT
            // ========================================

            async init() {
                // FIXED: Restore active tab from localStorage FIRST
                const savedTab = localStorage.getItem('teleroute_active_tab');
                if (savedTab && ['rates', 'companies', 'meetings', 'clientoffers', 'ouroffers'].includes(savedTab)) {
                    this.state.activeTab = savedTab;
                }

                // Setup initial UI state
                this.setupRegionGrid();
                this.setupOrientationHandler();
                this.setupClickOutside();
                this.setupDragDrop();

                // Show the correct section with skeleton loader immediately
                const tableSection = document.getElementById('table-section');
                const emptyState = document.getElementById('empty-state');
                const meetingsSection = document.getElementById('meetings-section');
                const companiesSection = document.getElementById('companies-section');
                const clientOffersSection = document.getElementById('clientoffers-section');
                const ourOffersSection = document.getElementById('ouroffers-section');

                // Hide all sections - use inline style for maximum specificity
                tableSection.style.display = 'none';
                emptyState.style.display = 'none';
                meetingsSection.style.display = 'none';
                companiesSection.style.display = 'none';
                clientOffersSection.style.display = 'none';
                ourOffersSection.style.display = 'none';

                // Show active section with skeleton
                if (this.state.activeTab === 'meetings') {
                    meetingsSection.style.display = 'flex';
                    this.showMeetingsSkeleton();
                } else if (this.state.activeTab === 'companies') {
                    companiesSection.style.display = 'flex';
                    this.showCompaniesSkeleton();
                } else if (this.state.activeTab === 'clientoffers') {
                    clientOffersSection.style.display = 'flex';
                    this.showClientOffersSkeleton();
                } else if (this.state.activeTab === 'ouroffers') {
                    ourOffersSection.style.display = 'flex';
                    this.showOurOffersSkeleton();
                } else {
                    // For rates tab, show the table section
                    tableSection.style.display = 'flex';
                }

                // Update tab button states
                document.getElementById('tab-rates').className = `tab-btn ${this.state.activeTab === 'rates' ? 'active' : ''}`;
                document.getElementById('tab-companies').className = `tab-btn ${this.state.activeTab === 'companies' ? 'active' : ''}`;
                document.getElementById('tab-meetings').className = `tab-btn ${this.state.activeTab === 'meetings' ? 'active' : ''}`;
                document.getElementById('tab-clientoffers').className = `tab-btn ${this.state.activeTab === 'clientoffers' ? 'active' : ''}`;
                document.getElementById('tab-ouroffers').className = `tab-btn ${this.state.activeTab === 'ouroffers' ? 'active' : ''}`;

                // Update header visibility - only show for rates tab
                const header = document.querySelector('header');
                if (this.state.activeTab === 'rates') {
                    header.classList.remove('hidden');
                } else {
                    header.classList.add('hidden');
                }

                try {
                    // Load data from Supabase
                    await this.loadFromSupabase();
                } catch (error) {
                    console.error('Error loading from Supabase:', error);
                    this.showToast('Error loading data. Using offline mode.', 'error');
                }

                // Ensure data structures exist
                if (!this.state.customOptions) {
                    this.state.customOptions = { product: [], network: [], traffic: [] };
                }
                if (!this.state.companies) {
                    this.state.companies = [];
                }
                if (!this.state.meetings) {
                    this.state.meetings = [];
                }

                // Migrate old clientOffers from string to array
                this.state.meetings.forEach(meeting => {
                    if (meeting.clientOffers && typeof meeting.clientOffers === 'string') {
                        meeting.clientOffers = [];
                    }
                    if (!meeting.clientOffers) {
                        meeting.clientOffers = [];
                    }
                });

                // Reset to today's date on load
                this.state.currentMeetingDate = new Date().toISOString().split('T')[0];

                // Render the active tab with real data (replaces skeleton)
                if (this.state.activeTab === 'meetings') {
                    this.renderMeetingsUI();
                } else if (this.state.activeTab === 'companies') {
                    this.renderCompaniesUI();
                } else if (this.state.activeTab === 'clientoffers') {
                    this.renderClientOffersUI();
                } else if (this.state.activeTab === 'ouroffers') {
                    this.renderOurOffersUI();
                } else {
                    this.renderUI();
                }

                // Start meeting reminder system
                this.startMeetingReminders();
            }

            // ==================== MEETING REMINDERS ====================

            startMeetingReminders() {
                // Request notification permission
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                // Track notified meetings to avoid duplicates
                this.notifiedMeetings = new Set();

                // Check for upcoming meetings every minute
                this.checkUpcomingMeetings();
                this.reminderInterval = setInterval(() => {
                    this.checkUpcomingMeetings();
                }, 60000); // Check every 1 minute
            }

            checkUpcomingMeetings() {
                if (!this.state.meetings || this.state.meetings.length === 0) return;

                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTimeInMinutes = currentHour * 60 + currentMinute;

                // Get today's meetings
                const todayMeetings = this.state.meetings.filter(m => m.date === todayStr);

                todayMeetings.forEach(meeting => {
                    // Parse meeting start time
                    const [startHour, startMinute] = meeting.startTime.split(':').map(Number);
                    const meetingTimeInMinutes = startHour * 60 + startMinute;
                    const minutesUntilMeeting = meetingTimeInMinutes - currentTimeInMinutes;

                    // Notify if meeting is within 15 minutes and hasn't been notified yet
                    if (minutesUntilMeeting > 0 && minutesUntilMeeting <= 15) {
                        const notificationKey = `${meeting.id}_15min`;
                        if (!this.notifiedMeetings.has(notificationKey)) {
                            this.notifiedMeetings.add(notificationKey);
                            this.showMeetingReminder(meeting, minutesUntilMeeting);
                        }
                    }

                    // Notify if meeting is within 5 minutes (urgent)
                    if (minutesUntilMeeting > 0 && minutesUntilMeeting <= 5) {
                        const notificationKey = `${meeting.id}_5min`;
                        if (!this.notifiedMeetings.has(notificationKey)) {
                            this.notifiedMeetings.add(notificationKey);
                            this.showMeetingReminder(meeting, minutesUntilMeeting, true);
                        }
                    }

                    // Notify if meeting is starting now
                    if (minutesUntilMeeting === 0) {
                        const notificationKey = `${meeting.id}_now`;
                        if (!this.notifiedMeetings.has(notificationKey)) {
                            this.notifiedMeetings.add(notificationKey);
                            this.showMeetingReminder(meeting, 0, true);
                        }
                    }
                });
            }

            showMeetingReminder(meeting, minutesUntil, isUrgent = false) {
                const serviceType = meeting.serviceType === 'VOICE' ? 'Voice' : 'SMS';

                let title, body;
                if (minutesUntil === 0) {
                    title = ` Meeting Starting Now!`;
                    body = `${serviceType} meeting with ${meeting.company} is starting`;
                } else if (minutesUntil <= 5) {
                    title = ` Meeting in ${minutesUntil} minute${minutesUntil > 1 ? 's' : ''}`;
                    body = `${serviceType} meeting with ${meeting.company}`;
                } else {
                    title = ` Upcoming Meeting`;
                    body = `${serviceType} meeting with ${meeting.company} in ${minutesUntil} minutes`;
                }

                // Show browser notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75"></text></svg>',
                        tag: meeting.id,
                        requireInteraction: isUrgent
                    });

                    notification.onclick = () => {
                        window.focus();
                        // Switch to meetings tab and open meeting details
                        this.switchTab('meetings');
                        this.openMeetingModal(meeting.id);
                        notification.close();
                    };
                }

                // Show in-app notification
                this.showToast(body, isUrgent ? 'warning' : 'info', 5000);

                // Add visual indicator to the meeting in calendar
                this.highlightUpcomingMeeting(meeting.id);
            }

            highlightUpcomingMeeting(meetingId) {
                // Add visual indicator to meeting blocks
                const meetingBlocks = document.querySelectorAll('.meeting-block');
                meetingBlocks.forEach(block => {
                    if (block.onclick && block.onclick.toString().includes(meetingId)) {
                        block.style.boxShadow = '0 0 0 3px #f59e0b, 0 4px 12px rgba(245, 158, 11, 0.4)';
                        block.style.animation = 'pulse-glow 2s infinite';
                    }
                });
            }

            setupClickOutside() {
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('action-menu');
                    const btn = document.getElementById('action-menu-btn');
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.remove('show');
                    }

                    // Hide rate suggestions when clicking outside
                    const rateSearch = document.getElementById('meeting-rate-search');
                    const rateSuggestions = document.getElementById('rate-suggestions');
                    if (rateSearch && rateSuggestions && !rateSearch.contains(e.target) && !rateSuggestions.contains(e.target)) {
                        rateSuggestions.classList.add('hidden');
                    }

                    // Hide country autocomplete when clicking outside
                    const countryDropdown = document.getElementById('country-autocomplete');
                    if (countryDropdown && !countryDropdown.contains(e.target) && !e.target.closest('td input')) {
                        countryDropdown.classList.remove('show');
                    }
                });
            }

            setupDragDrop() {
                const dropzone = document.getElementById('import-dropzone');
                if (dropzone) {
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                        dropzone.addEventListener(evt, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });

                    ['dragenter', 'dragover'].forEach(evt => {
                        dropzone.addEventListener(evt, () => {
                            dropzone.classList.add('border-[#3BC1A8]', 'bg-[#3BC1A8]/10');
                        });
                    });

                    ['dragleave', 'drop'].forEach(evt => {
                        dropzone.addEventListener(evt, () => {
                            dropzone.classList.remove('border-[#3BC1A8]', 'bg-[#3BC1A8]/10');
                        });
                    });

                    dropzone.addEventListener('drop', (e) => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            this.processFile(files[0]);
                        }
                    });
                }
            }

            setupOrientationHandler() {
                window.addEventListener('resize', () => this.handleResize());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.handleResize(), 100);
                });

                // Fullscreen change listener
                document.addEventListener('fullscreenchange', () => this.onFullscreenChange());
                document.addEventListener('webkitfullscreenchange', () => this.onFullscreenChange());
                document.addEventListener('msfullscreenchange', () => this.onFullscreenChange());
            }

            onFullscreenChange() {
                const exitBtn = document.getElementById('exit-fullscreen-btn');
                const rotateBtn = document.getElementById('rotate-btn');

                if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                    // In fullscreen - show exit button, hide rotate button
                    if (exitBtn) exitBtn.classList.remove('hidden');
                    if (exitBtn) exitBtn.classList.add('flex');
                    if (rotateBtn) rotateBtn.classList.add('hidden');
                } else {
                    // Not in fullscreen - hide exit button, show rotate button (in portrait)
                    if (exitBtn) exitBtn.classList.add('hidden');
                    if (exitBtn) exitBtn.classList.remove('flex');
                    if (rotateBtn) rotateBtn.classList.remove('hidden');
                }
            }

            handleResize() {
                this.adjustTableHeight();
                if (window.innerWidth > window.innerHeight && !this.state.region) {
                    this.state.headerCollapsed = false;
                    this.updateHeaderState();
                }
            }

            adjustTableHeight() {
                const container = document.getElementById('table-container');
                if (container && this.state.region) {
                    const header = document.querySelector('header');
                    const tableHeader = document.querySelector('#table-section > div:first-child');
                    const footer = document.querySelector('#table-section > div:last-child');

                    const headerH = header ? header.offsetHeight : 0;
                    const tableHeaderH = tableHeader ? tableHeader.offsetHeight : 0;
                    const footerH = footer ? footer.offsetHeight : 0;

                    const available = window.innerHeight - headerH - tableHeaderH - footerH - 10;
                    container.style.height = `${Math.max(150, available)}px`;
                }
            }

            // Action Menu
            toggleActionMenu() {
                const menu = document.getElementById('action-menu');
                menu.classList.toggle('show');
            }

            // Header collapse/expand
            toggleHeader() {
                this.state.headerCollapsed = !this.state.headerCollapsed;
                this.updateHeaderState();
                this.saveState();
                setTimeout(() => this.adjustTableHeight(), 350);
            }

            updateHeaderState() {
                const content = document.getElementById('header-content');
                const summary = document.getElementById('collapsed-summary');
                const icon = document.getElementById('toggle-icon');
                const text = document.getElementById('toggle-text');

                if (this.state.headerCollapsed) {
                    content.classList.add('collapsed');
                    summary.classList.add('show');
                    icon.className = 'ph-bold ph-caret-down text-sm';
                    text.textContent = 'Expand';

                    document.getElementById('sum-type').textContent = this.state.serviceType || '-';
                    document.getElementById('sum-list').textContent = this.state.listType === 'TARGET' ? 'Target' : this.state.listType === 'PUSH' ? 'Push' : '-';
                    document.getElementById('sum-region').textContent = this.state.region || '-';
                } else {
                    content.classList.remove('collapsed');
                    summary.classList.remove('show');
                    icon.className = 'ph-bold ph-caret-up text-sm';
                    text.textContent = 'Collapse';
                }
            }

            // Rotate handling with fullscreen support
            async requestLandscape() {
                const elem = document.documentElement;

                try {
                    // Step 1: Try to enter fullscreen first (required for orientation lock on most browsers)
                    if (!document.fullscreenElement) {
                        if (elem.requestFullscreen) {
                            await elem.requestFullscreen();
                        } else if (elem.webkitRequestFullscreen) {
                            await elem.webkitRequestFullscreen();
                        } else if (elem.msRequestFullscreen) {
                            await elem.msRequestFullscreen();
                        }
                    }

                    // Step 2: Lock orientation to landscape
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape');
                        this.showToast('Rotated to landscape');
                        return;
                    }

                    // Fallback for older API
                    if (screen.lockOrientation) {
                        screen.lockOrientation('landscape');
                        this.showToast('Rotated to landscape');
                        return;
                    }

                    if (screen.mozLockOrientation) {
                        screen.mozLockOrientation('landscape');
                        this.showToast('Rotated to landscape');
                        return;
                    }

                    if (screen.msLockOrientation) {
                        screen.msLockOrientation('landscape');
                        this.showToast('Rotated to landscape');
                        return;
                    }

                    // If no orientation API available, show manual rotate hint
                    this.showRotateOverlay();

                } catch (error) {
                    console.log('Orientation lock failed:', error);
                    // Show manual rotate hint if auto-rotate fails
                    this.showRotateOverlay();
                }
            }

            // Exit fullscreen and unlock orientation
            exitFullscreenMode() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }

            showRotateOverlay() {
                if (!this.state.rotateOverlayDismissed) {
                    document.getElementById('rotate-overlay').classList.add('show');
                }
            }

            dismissRotateOverlay() {
                document.getElementById('rotate-overlay').classList.remove('show');
                this.state.rotateOverlayDismissed = true;
            }

            async tryAutoRotate() {
                document.getElementById('rotate-overlay').classList.remove('show');

                const elem = document.documentElement;

                try {
                    // Enter fullscreen
                    if (elem.requestFullscreen) {
                        await elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        await elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        await elem.msRequestFullscreen();
                    }

                    // Small delay to ensure fullscreen is active
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // Lock to landscape
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape');
                        this.showToast('Rotated to landscape!');
                    } else {
                        this.showToast('Please rotate manually', 'error');
                    }
                } catch (error) {
                    console.log('Auto-rotate failed:', error.message);
                    this.showToast('Please rotate manually', 'error');
                }
            }

            // Excel Template Download
            downloadTemplate() {
                this.toggleActionMenu();

                const headers = this.getHeaders();
                const isVoice = this.state.serviceType === 'VOICE';

                // Create workbook with template
                const wb = XLSX.utils.book_new();

                // Sample data rows based on type
                let templateData;
                if (isVoice) {
                    templateData = [
                        headers,
                        ['India', 'CLI', 'Tier1', '0.025', '60/1', 'Numeric', '180', '45', '1'],
                        ['USA', 'NonCLI', 'Tier2', '0.015', '1/1', 'Alphanumeric', '200', '50', '2'],
                        ['UK', 'CLI', 'Premium', '0.035', '60/60', 'Numeric', '150', '55', '1'],
                        ['', '', '', '', '', '', '', '', ''],
                    ];
                } else {
                    templateData = [
                        headers,
                        ['India', 'OTP', 'Airtel', '0.025', 'High', 'Numeric', '100', '50000', '1'],
                        ['USA', 'Marketing', 'AT&T', '0.015', 'Medium', 'Alphanumeric', '50', '100000', '2'],
                        ['', '', '', '', '', '', '', '', ''],
                    ];
                }

                const ws = XLSX.utils.aoa_to_sheet(templateData);
                ws['!cols'] = headers.map(() => ({ wch: 12 }));

                XLSX.utils.book_append_sheet(wb, ws, 'Rate Template');

                // Add instructions sheet based on type
                let instructions;
                if (isVoice) {
                    instructions = [
                        ['TeleRoute Voice Template Instructions'],
                        [''],
                        ['Column Descriptions:'],
                        ['Destination', 'Country or destination name (e.g., India, USA, UK)'],
                        ['Product', 'Product type (e.g., CLI, NonCLI)'],
                        ['Breakout', 'Breakout tier (e.g., Tier1, Tier2, Premium)'],
                        ['Rate', 'Price per minute (numeric value)'],
                        ['Billing Increment', 'Billing cycle format (e.g., 1/1, 60/1, 60/60, 30/30)'],
                        ['Display', 'Caller ID display type (e.g., Numeric, Alphanumeric)'],
                        ['ACD', 'Average Call Duration in seconds (numeric)'],
                        ['ASR', 'Answer Seizure Ratio percentage (numeric)'],
                        ['HOP', 'Number of hops/routing points (numeric)'],
                        [''],
                        ['Instructions:'],
                        ['1. Fill data in the "Rate Template" sheet'],
                        ['2. Keep the header row (first row) unchanged'],
                        ['3. Add your data starting from row 2'],
                        ['4. Delete sample data rows before importing'],
                        ['5. Save as .xlsx format'],
                    ];
                } else {
                    instructions = [
                        ['TeleRoute SMS Template Instructions'],
                        [''],
                        ['Column Descriptions:'],
                        ['Designation', 'Country or destination name (e.g., India, USA, UK)'],
                        ['Product', 'Product type (e.g., OTP, Marketing, Transactional)'],
                        ['Network', 'Carrier/Network name (e.g., Airtel, Vodafone, AT&T)'],
                        ['Rate', 'Price per message (numeric value)'],
                        ['Traffic', 'Traffic volume level (e.g., High, Medium, Low)'],
                        ['Display', 'Sender ID display type (e.g., Numeric, Alphanumeric)'],
                        ['TPS', 'Transactions Per Second limit (numeric)'],
                        ['CAP', 'Daily/Monthly cap limit (numeric)'],
                        ['HOP', 'Number of hops/routing points (numeric)'],
                        [''],
                        ['Instructions:'],
                        ['1. Fill data in the "Rate Template" sheet'],
                        ['2. Keep the header row (first row) unchanged'],
                        ['3. Add your data starting from row 2'],
                        ['4. Delete sample data rows before importing'],
                        ['5. Save as .xlsx format'],
                    ];
                }

                const wsInstructions = XLSX.utils.aoa_to_sheet(instructions);
                wsInstructions['!cols'] = [{ wch: 20 }, { wch: 60 }];
                XLSX.utils.book_append_sheet(wb, wsInstructions, 'Instructions');

                // Generate simple filename
                const type = (this.state.serviceType || 'rate').toLowerCase();
                const list = (this.state.listType || 'target').toLowerCase();
                const filename = `${type}_${list}_template.xlsx`;

                XLSX.writeFile(wb, filename);
                this.showToast('Template downloaded!');
            }

            // Export current data to Excel
            exportToExcel() {
                this.toggleActionMenu();

                const data = this.getCurrentData();
                if (data.length === 0) {
                    this.showToast('No data to export', 'error');
                    return;
                }

                const headers = this.getHeaders();
                const columns = this.getColumns();
                const wb = XLSX.utils.book_new();

                // Build configuration header
                const serviceType = this.state.serviceType || 'SMS';
                const listType = this.state.listType || 'Target';
                const region = this.state.region || '';
                const configPath = `${serviceType} > ${listType.charAt(0).toUpperCase() + listType.slice(1)} > ${region}`;

                // Convert data to array format with config header
                const exportData = [
                    ['Rate Configuration'],
                    [configPath],
                    [''],  // Empty row for spacing
                    headers
                ];
                data.forEach(row => {
                    exportData.push(columns.map(col => row[col] || ''));
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);

                // Style column widths
                ws['!cols'] = headers.map(() => ({ wch: 12 }));

                // Merge cells for header (optional visual enhancement)
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } },  // Rate Configuration
                    { s: { r: 1, c: 0 }, e: { r: 1, c: headers.length - 1 } }   // Config path
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'Rate Data');

                const type = (this.state.serviceType || 'rate').toLowerCase();
                const list = (this.state.listType || 'target').toLowerCase();
                const filename = `${type}_${list}_export.xlsx`;
                XLSX.writeFile(wb, filename);
                this.showToast('Data exported!');
            }

            // Export all regions to Excel
            exportAllRegions() {
                this.toggleActionMenu();

                if (!this.state.serviceType || !this.state.listType) {
                    this.showToast('Select service type and list first', 'error');
                    return;
                }

                const wb = XLSX.utils.book_new();
                const serviceType = this.state.serviceType || 'SMS';
                const listType = this.state.listType || 'Target';
                const headers = this.getHeaders();
                const columns = this.getColumns();
                let hasData = false;

                // Export data for each region
                regions.forEach(region => {
                    const key = `${this.state.serviceType}_${this.state.listType}_${region.id}`;
                    const data = this.state.data[key] || [];

                    if (data.length > 0) {
                        hasData = true;

                        // Build configuration header
                        const configPath = `${serviceType} > ${listType.charAt(0).toUpperCase() + listType.slice(1)} > ${region.id}`;

                        // Convert data to array format with config header
                        const exportData = [
                            ['Rate Configuration'],
                            [configPath],
                            [''],  // Empty row for spacing
                            headers
                        ];
                        data.forEach(row => {
                            exportData.push(columns.map(col => row[col] || ''));
                        });

                        const ws = XLSX.utils.aoa_to_sheet(exportData);

                        // Style column widths
                        ws['!cols'] = headers.map(() => ({ wch: 12 }));

                        // Merge cells for header
                        ws['!merges'] = [
                            { s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } },
                            { s: { r: 1, c: 0 }, e: { r: 1, c: headers.length - 1 } }
                        ];

                        // Add sheet with region name
                        XLSX.utils.book_append_sheet(wb, ws, `${region.id} - ${region.label}`);
                    }
                });

                if (!hasData) {
                    this.showToast('No data to export across all regions', 'error');
                    return;
                }

                const type = serviceType.toLowerCase();
                const list = listType.toLowerCase();
                const filename = `${type}_${list}_all_regions_export.xlsx`;
                XLSX.writeFile(wb, filename);
                this.showToast('All regions exported!');
            }

            // Import Modal
            openImportModal() {
                this.toggleActionMenu();

                if (!this.state.region) {
                    this.showToast('Select region first', 'error');
                    return;
                }

                this.pendingImportData = null;
                document.getElementById('import-preview').classList.add('hidden');
                document.getElementById('confirm-import-btn').disabled = true;
                document.getElementById('import-modal').classList.add('show');
            }

            closeImportModal() {
                document.getElementById('import-modal').classList.remove('show');
                this.pendingImportData = null;
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
                event.target.value = '';
            }

            processFile(file) {
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    this.showToast('Please select an Excel file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Get first sheet (skip Instructions if exists)
                        let sheetName = workbook.SheetNames[0];
                        if (sheetName === 'Instructions' && workbook.SheetNames.length > 1) {
                            sheetName = workbook.SheetNames[1];
                        }

                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // Parse data (skip header row)
                        const columns = this.getColumns();
                        const parsedData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length > 0 && row.some(cell => cell !== '' && cell !== undefined)) {
                                const rowData = {
                                    // Generate unique ID for each imported row
                                    id: 'rate_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 9)
                                };
                                columns.forEach((col, idx) => {
                                    rowData[col] = row[idx] !== undefined ? String(row[idx]) : '';
                                });
                                parsedData.push(rowData);
                            }
                        }

                        if (parsedData.length === 0) {
                            this.showToast('No data found in file', 'error');
                            return;
                        }

                        this.pendingImportData = parsedData;
                        this.showImportPreview(parsedData);

                    } catch (error) {
                        console.error('Error parsing file:', error);
                        this.showToast('Error reading file', 'error');
                    }
                };

                reader.readAsArrayBuffer(file);
            }

            showImportPreview(data) {
                const previewDiv = document.getElementById('import-preview');
                const previewContent = document.getElementById('preview-content');
                const countSpan = document.getElementById('preview-count');
                const columns = this.getColumns();

                countSpan.textContent = data.length;

                // Show first 5 rows preview using first 3 columns
                const preview = data.slice(0, 5).map((row, i) =>
                    `${i + 1}. ${row[columns[0]] || '-'} | ${row[columns[1]] || '-'} | ${row[columns[2]] || '-'}`
                ).join('\n');

                previewContent.textContent = preview + (data.length > 5 ? `\n... and ${data.length - 5} more rows` : '');

                previewDiv.classList.remove('hidden');
                document.getElementById('confirm-import-btn').disabled = false;
            }

            confirmImport() {
                if (!this.pendingImportData) return;

                // Set data to current selection
                this.setCurrentData(this.pendingImportData);
                this.saveState();
                this.renderTableRows();
                this.closeImportModal();
                this.showToast(`Imported ${this.pendingImportData.length} rows!`);
                this.pendingImportData = null;
            }

            clearAllData() {
                this.toggleActionMenu();

                if (confirm('Clear all data for current selection?')) {
                    // Track all IDs being deleted
                    const currentData = this.getCurrentData();
                    currentData.forEach(row => {
                        if (row && row.id) {
                            this.state.deletedRateIds.push(row.id);
                        }
                    });

                    this.setCurrentData([]);
                    this.saveState();
                    this.renderTableRows();
                    this.showToast('Data cleared');
                }
            }

            // Selection methods
            setServiceType(type) {
                this.state.serviceType = type;
                this.state.listType = null;
                this.state.region = null;
                this.saveState();
                this.renderUI();
            }

            setListType(type) {
                this.state.listType = type;
                this.state.region = null;
                this.saveState();
                this.renderUI();
            }

            setRegion(regionId) {
                this.state.region = regionId;
                this.state.headerCollapsed = true;
                this.saveState();
                this.renderUI();
                this.updateHeaderState();

                if (window.innerHeight > window.innerWidth && !this.state.rotateOverlayDismissed) {
                    setTimeout(() => this.showRotateOverlay(), 300);
                }

                setTimeout(() => this.adjustTableHeight(), 350);
            }

            // Show country suggestions based on typed input
            showCountrySuggestions(input, rowIndex, col) {
                const query = input.value.trim().toLowerCase();
                const dropdown = document.getElementById('country-autocomplete');

                // Hide if less than 1 character typed
                if (query.length < 1) {
                    dropdown.classList.remove('show');
                    return;
                }

                const region = this.state.region;
                const countries = REGION_COUNTRIES[region] || [];

                // Filter countries matching the query
                const matches = countries.filter(c =>
                    c.toLowerCase().includes(query)
                ).slice(0, 8); // Limit to 8 suggestions

                if (matches.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Position dropdown below the input
                const rect = input.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + 2}px`;
                dropdown.style.left = `${rect.left}px`;
                dropdown.style.width = `${Math.max(rect.width, 150)}px`;

                // Store reference to current input
                this.countryInputRef = { input, rowIndex, col };

                // Render options
                dropdown.innerHTML = matches.map((country, i) => `
                    <div class="country-option" onclick="app.selectCountry('${country}')">
                        ${this.escapeHtml(country)}
                    </div>
                `).join('');

                dropdown.classList.add('show');
            }

            selectCountry(country) {
                if (this.countryInputRef) {
                    const { input, rowIndex, col } = this.countryInputRef;
                    input.value = country;
                    this.updateCell(rowIndex, col, country);
                }
                this.hideCountryAutocomplete();
            }

            hideCountryAutocomplete() {
                const dropdown = document.getElementById('country-autocomplete');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                this.countryInputRef = null;
            }

            renderUI() {
                this.renderServiceTypeButtons();
                this.renderListTypeSection();
                this.renderRegionSection();
                this.renderTableSection();
                this.renderEmptyState();
                this.updateHeaderState();
            }

            renderServiceTypeButtons() {
                const btnSMS = document.getElementById('btn-sms');
                const btnVoice = document.getElementById('btn-voice');

                const activeClass = 'border-[#3BC1A8] bg-[#3BC1A8]/20 text-white';
                const inactiveClass = 'border-slate-700 text-slate-400 active:bg-slate-800';
                const baseClass = 'touch-btn flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 border-2';

                btnSMS.className = `${baseClass} ${this.state.serviceType === 'SMS' ? activeClass : inactiveClass}`;
                btnVoice.className = `${baseClass} ${this.state.serviceType === 'VOICE' ? activeClass : inactiveClass}`;
            }

            renderListTypeSection() {
                const section = document.getElementById('list-type-section');
                const btnTarget = document.getElementById('btn-target');
                const btnPush = document.getElementById('btn-push');

                if (this.state.serviceType) {
                    section.className = 'section-visible mt-3';

                    const activeClass = 'border-[#3BC1A8] bg-[#3BC1A8]/20 text-white';
                    const inactiveClass = 'border-slate-700 text-slate-400 active:bg-slate-800';
                    const baseClass = 'touch-btn flex items-center justify-center gap-2 py-2 rounded-xl text-xs font-bold uppercase tracking-wide transition-all duration-200 border-2';

                    btnTarget.className = `${baseClass} ${this.state.listType === 'TARGET' ? activeClass : inactiveClass}`;
                    btnPush.className = `${baseClass} ${this.state.listType === 'PUSH' ? activeClass : inactiveClass}`;
                } else {
                    section.className = 'section-hidden';
                }
            }

            renderRegionSection() {
                const section = document.getElementById('region-section-header');

                if (this.state.serviceType && this.state.listType) {
                    section.className = 'section-visible mt-3';
                    this.updateRegionButtons();
                } else {
                    section.className = 'section-hidden';
                }
            }

            setupRegionGrid() {
                const grid = document.getElementById('region-grid-header');
                grid.innerHTML = regions.map(r => `
                    <button onclick="app.setRegion('${r.id}')"
                            id="reg-btn-${r.id}"
                            class="region-btn touch-btn p-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-400 font-medium text-xs transition-all active:scale-95 flex flex-col items-center justify-center gap-0.5">
                        <span class="block font-bold text-[11px]">${r.id}</span>
                        <span class="text-[8px] text-slate-500 truncate w-full text-center">${r.label}</span>
                    </button>
                `).join('');
            }

            updateRegionButtons() {
                document.querySelectorAll('.region-btn').forEach(btn => {
                    const id = btn.id.replace('reg-btn-', '');
                    if (this.state.region === id) {
                        btn.className = 'region-btn touch-btn p-2 rounded-lg border-2 border-[#3BC1A8] bg-[#3BC1A8]/20 text-white font-bold text-xs flex flex-col items-center justify-center gap-0.5';
                    } else {
                        btn.className = 'region-btn touch-btn p-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-400 font-medium text-xs transition-all active:scale-95 flex flex-col items-center justify-center gap-0.5';
                    }
                });
            }

            renderTableSection() {
                const section = document.getElementById('table-section');
                const contextEl = document.getElementById('table-context');

                if (this.state.serviceType && this.state.listType && this.state.region) {
                    section.className = 'section-visible flex flex-col h-full';
                    contextEl.textContent = `${this.state.serviceType} > ${this.state.listType === 'TARGET' ? 'Target' : 'Push'} > ${this.state.region}`;
                    this.renderTableHeaders();
                    this.renderTableRows();
                    // Update datalist options for SMS dropdowns
                    if (this.state.serviceType === 'SMS') {
                        this.updateDatalistOptions();
                    }
                } else {
                    section.className = 'section-hidden';
                }
            }

            renderTableHeaders() {
                const thead = document.getElementById('table-head');
                const headers = this.getHeaders();

                thead.innerHTML = `
                    <tr>
                        <th class="px-2 py-2.5 text-left text-[10px] font-bold text-white uppercase tracking-wider border-r border-slate-700 w-8">#</th>
                        ${headers.map(h => `
                            <th class="px-2 py-2.5 text-left text-[10px] font-bold text-white uppercase tracking-wider border-r border-slate-700 min-w-[70px]">${h}</th>
                        `).join('')}
                        <th class="px-2 py-2.5 text-center text-[10px] font-bold text-white uppercase tracking-wider w-12">Del</th>
                    </tr>
                `;
            }

            renderEmptyState() {
                const emptyState = document.getElementById('empty-state');
                const title = document.getElementById('empty-title');
                const desc = document.getElementById('empty-desc');

                if (!this.state.serviceType) {
                    emptyState.className = 'flex flex-col items-center justify-center py-12 text-center px-6';
                    title.textContent = 'Get Started';
                    desc.textContent = 'Select SMS or Voice above to begin.';
                } else if (!this.state.listType) {
                    emptyState.className = 'flex flex-col items-center justify-center py-12 text-center px-6';
                    title.textContent = 'Select List Type';
                    desc.textContent = 'Choose Target List or Push List.';
                } else if (!this.state.region) {
                    emptyState.className = 'flex flex-col items-center justify-center py-12 text-center px-6';
                    title.textContent = 'Select Region';
                    desc.textContent = 'Choose a region to configure rates.';
                } else {
                    emptyState.className = 'hidden';
                }
            }

            // Get columns based on service type
            getColumns() {
                return this.state.serviceType === 'VOICE' ? VOICE_COLUMNS : SMS_COLUMNS;
            }

            getHeaders() {
                return this.state.serviceType === 'VOICE' ? VOICE_HEADERS : SMS_HEADERS;
            }

            // Get all options for a dropdown field (default + custom)
            getFieldOptions(field) {
                let defaults = [];
                switch (field) {
                    case 'product':
                        defaults = DEFAULT_PRODUCT_OPTIONS;
                        break;
                    case 'network':
                        defaults = DEFAULT_NETWORK_OPTIONS;
                        break;
                    case 'traffic':
                        defaults = DEFAULT_TRAFFIC_OPTIONS;
                        break;
                    default:
                        return [];
                }
                const custom = this.state.customOptions[field] || [];
                // Combine and remove duplicates
                return [...new Set([...defaults, ...custom])];
            }

            // Add a custom option if it doesn't exist
            addCustomOption(field, value) {
                if (!value || !value.trim()) return;
                value = value.trim();

                const defaults = this.getDefaultOptions(field);
                const custom = this.state.customOptions[field] || [];

                // Only add if not in defaults and not already in custom
                if (!defaults.includes(value) && !custom.includes(value)) {
                    this.state.customOptions[field] = [...custom, value];
                    this.saveState();
                    this.updateDatalistOptions();
                }
            }

            getDefaultOptions(field) {
                switch (field) {
                    case 'product': return DEFAULT_PRODUCT_OPTIONS;
                    case 'network': return DEFAULT_NETWORK_OPTIONS;
                    case 'traffic': return DEFAULT_TRAFFIC_OPTIONS;
                    default: return [];
                }
            }

            // Update datalist options in DOM
            updateDatalistOptions() {
                ['product', 'network', 'traffic'].forEach(field => {
                    const datalist = document.getElementById(`datalist-${field}`);
                    if (datalist) {
                        const options = this.getFieldOptions(field);
                        datalist.innerHTML = options.map(opt => `<option value="${opt}">`).join('');
                    }
                });
            }

            // Check if a column should use dropdown
            isDropdownColumn(col) {
                return this.state.serviceType === 'SMS' && ['product', 'network', 'traffic'].includes(col);
            }

            // Table Operations
            getDataKey() {
                return `${this.state.serviceType}_${this.state.listType}_${this.state.region}`;
            }

            getCurrentData() {
                const key = this.getDataKey();
                return this.state.data[key] || [];
            }

            setCurrentData(data) {
                const key = this.getDataKey();
                this.state.data[key] = data;
            }

            renderTableRows() {
                const tbody = document.getElementById('table-body');
                const data = this.getCurrentData();
                const countEl = document.getElementById('row-count');

                if (data.length === 0) {
                    this.addRow(false);
                    return;
                }

                tbody.innerHTML = data.map((row, index) => this.createRowHTML(row, index)).join('');
                countEl.textContent = `${data.length} row${data.length !== 1 ? 's' : ''}`;
            }

            createRowHTML(row, index) {
                const columns = this.getColumns();
                const numericCols = ['rate', 'tps', 'cap', 'hop', 'acd', 'asr'];
                const isCountryCol = (col) => col === 'designation' || col === 'destination';

                return `
                    <tr class="border-b border-slate-100" data-index="${index}">
                        <td class="px-2 py-1 text-center text-[10px] text-slate-400 font-mono border-r border-slate-100">${index + 1}</td>
                        ${columns.map(col => {
                            const isDropdown = this.isDropdownColumn(col);
                            const isNumeric = numericCols.includes(col);
                            const isCountry = isCountryCol(col);
                            return `
                            <td class="border-r border-slate-100">
                                <input type="text"
                                    ${isNumeric ? 'inputmode="numeric"' : ''}
                                    ${isDropdown ? `list="datalist-${col}"` : ''}
                                    value="${row[col] || ''}"
                                    placeholder="${col.charAt(0).toUpperCase() + col.slice(1)}"
                                    onchange="app.updateCell(${index}, '${col}', this.value)"
                                    ${isCountry ? `oninput="app.showCountrySuggestions(this, ${index}, '${col}')"` : ''}
                                    ${isDropdown ? `onblur="app.handleDropdownBlur('${col}', this.value)"` : ''}
                                    autocomplete="off">
                            </td>
                        `;
                        }).join('')}
                        <td class="px-1 py-1 text-center">
                            <button onclick="app.deleteRow(${index})"
                                class="touch-btn p-2 text-slate-300 active:text-red-500 rounded">
                                <i class="ph-fill ph-trash text-base"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }

            // Handle blur on dropdown fields - add custom option if new
            handleDropdownBlur(field, value) {
                this.addCustomOption(field, value);
            }

            addRow(render = true) {
                const data = this.getCurrentData();
                const columns = this.getColumns();
                const newRow = {
                    id: 'rate_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)  // Generate unique ID
                };
                columns.forEach(col => newRow[col] = '');
                data.push(newRow);
                this.setCurrentData(data);

                if (render) {
                    this.renderTableRows();
                    this.saveState();
                    this.showToast('Row added');
                    document.getElementById('action-menu').classList.remove('show');
                } else {
                    this.renderTableRows();
                }
            }

            updateCell(index, field, value) {
                const data = this.getCurrentData();
                if (data[index]) {
                    data[index][field] = value;
                    this.setCurrentData(data);
                    this.saveState();
                }
            }

            deleteRow(index) {
                const data = this.getCurrentData();
                if (data.length > 1) {
                    // Track deleted ID for targeted deletion in database
                    const deletedRow = data[index];
                    if (deletedRow && deletedRow.id) {
                        this.state.deletedRateIds.push(deletedRow.id);
                    }
                    data.splice(index, 1);
                    this.setCurrentData(data);
                    this.renderTableRows();
                    this.saveState();
                    this.showToast('Row deleted');
                } else {
                    this.showToast('Cannot delete last row', 'error');
                }
            }

            saveData() {
                this.saveState();
                this.showToast('Data saved!');
            }

            // ==================== TAB NAVIGATION ====================
            switchTab(tab) {
                this.state.activeTab = tab;
                // Save active tab to localStorage for persistence
                localStorage.setItem('teleroute_active_tab', tab);

                // Update tab buttons
                document.getElementById('tab-rates').className = `tab-btn ${tab === 'rates' ? 'active' : ''}`;
                document.getElementById('tab-companies').className = `tab-btn ${tab === 'companies' ? 'active' : ''}`;
                document.getElementById('tab-meetings').className = `tab-btn ${tab === 'meetings' ? 'active' : ''}`;
                document.getElementById('tab-clientoffers').className = `tab-btn ${tab === 'clientoffers' ? 'active' : ''}`;
                document.getElementById('tab-ouroffers').className = `tab-btn ${tab === 'ouroffers' ? 'active' : ''}`;

                // Update header visibility - only show for rates tab
                const header = document.querySelector('header');
                if (tab === 'rates') {
                    header.classList.remove('hidden');
                } else {
                    header.classList.add('hidden');
                }

                this.renderTabContent();
            }

            renderTabContent() {
                console.log('=== renderTabContent START ===');
                console.log('Active tab:', this.state.activeTab);

                const app = document.getElementById('app');
                const header = document.querySelector('header');
                const nav = document.querySelector('nav.bottom-tabs');
                const mainScroll = document.getElementById('main-scroll');
                const tableSection = document.getElementById('table-section');
                const emptyState = document.getElementById('empty-state');
                const meetingsSection = document.getElementById('meetings-section');
                const companiesSection = document.getElementById('companies-section');
                const clientOffersSection = document.getElementById('clientoffers-section');
                const ourOffersSection = document.getElementById('ouroffers-section');

                console.log('LAYOUT BREAKDOWN:');
                const appStyle = window.getComputedStyle(app);
                console.log('app container:', {
                    height: app.offsetHeight,
                    clientHeight: app.clientHeight,
                    display: appStyle.display,
                    flexDirection: appStyle.flexDirection,
                    paddingTop: appStyle.paddingTop,
                    paddingBottom: appStyle.paddingBottom
                });
                console.log('header:', {
                    height: header ? header.offsetHeight : 'N/A',
                    display: header ? window.getComputedStyle(header).display : 'N/A'
                });
                console.log('main-scroll:', {
                    height: mainScroll.offsetHeight,
                    flex: window.getComputedStyle(mainScroll).flex,
                    minHeight: window.getComputedStyle(mainScroll).minHeight
                });
                console.log('nav:', {
                    height: nav.offsetHeight
                });

                // Log all children of main-scroll BEFORE hiding
                console.log('main-scroll children BEFORE:');
                Array.from(mainScroll.children).forEach(child => {
                    console.log(`  ${child.id || child.tagName}:`, {
                        height: child.offsetHeight,
                        display: window.getComputedStyle(child).display
                    });
                });

                // Hide all sections first and remove from flex layout - use inline style for maximum specificity
                tableSection.style.display = 'none';
                emptyState.style.display = 'none';
                meetingsSection.style.display = 'none';
                companiesSection.style.display = 'none';
                clientOffersSection.style.display = 'none';
                ourOffersSection.style.display = 'none';

                if (this.state.activeTab === 'meetings') {
                    meetingsSection.style.display = 'flex';
                    console.log(' Showing meetings');
                    this.renderMeetingsUI();
                } else if (this.state.activeTab === 'companies') {
                    companiesSection.style.display = 'flex';
                    console.log(' Showing companies');
                    this.renderCompaniesUI();
                } else if (this.state.activeTab === 'clientoffers') {
                    clientOffersSection.style.display = 'flex';
                    console.log(' Showing clientoffers');
                    this.renderClientOffersUI();
                    setTimeout(() => {
                        console.log('clientoffers-section after render:', {
                            height: clientOffersSection.offsetHeight,
                            scrollHeight: clientOffersSection.scrollHeight,
                            display: window.getComputedStyle(clientOffersSection).display
                        });
                        const content = document.getElementById('clientoffers-content');
                        console.log('clientoffers-content:', {
                            height: content.offsetHeight,
                            scrollHeight: content.scrollHeight
                        });
                    }, 100);
                } else if (this.state.activeTab === 'ouroffers') {
                    ourOffersSection.style.display = 'flex';
                    console.log(' Showing ouroffers');
                    this.renderOurOffersUI();
                    setTimeout(() => {
                        console.log('main-scroll children AFTER showing ouroffers:');
                        Array.from(mainScroll.children).forEach(child => {
                            console.log(`  ${child.id || child.tagName}:`, {
                                height: child.offsetHeight,
                                display: window.getComputedStyle(child).display
                            });
                        });
                        console.log('ouroffers-section after render:', {
                            height: ourOffersSection.offsetHeight,
                            scrollHeight: ourOffersSection.scrollHeight,
                            display: window.getComputedStyle(ourOffersSection).display
                        });
                        const content = document.getElementById('ouroffers-content');
                        console.log('ouroffers-content:', {
                            height: content.offsetHeight,
                            scrollHeight: content.scrollHeight
                        });
                    }, 100);
                } else {
                    // Show rates tab
                    tableSection.style.display = 'flex';
                    console.log(' Showing rates');
                    this.renderUI();
                }
                console.log('=== renderTabContent END ===');
            }

            // ==================== MEETINGS UI ====================
            renderMeetingsUI() {
                this.updateMeetingsToggleUI();
                this.updateMeetingDateDisplay();
                this.renderTimeSlots();
                this.updateMeetingCount();
            }

            updateMeetingsToggleUI() {
                const type = this.state.meetingsServiceType || 'SMS';
                const smsBtn = document.getElementById('meeting-sms-btn');
                const voiceBtn = document.getElementById('meeting-voice-btn');

                if (type === 'SMS') {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                } else {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#249E94] text-white';
                }
            }

            updateMeetingDateDisplay() {
                const dateDisplay = document.getElementById('meeting-date-display');
                const dayNameEl = document.getElementById('meeting-day-name');

                const date = new Date(this.state.currentMeetingDate + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dateObj = new Date(date);
                dateObj.setHours(0, 0, 0, 0);

                // Format date display
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                dateDisplay.textContent = `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;

                if (dateObj.getTime() === today.getTime()) {
                    dayNameEl.textContent = 'Today';
                } else {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    dayNameEl.textContent = days[date.getDay()];
                }
            }

            setMeetingDate(dateStr) {
                this.state.currentMeetingDate = dateStr;
                this.renderMeetingsUI();
            }

            prevDay() {
                const date = new Date(this.state.currentMeetingDate);
                date.setDate(date.getDate() - 1);
                this.state.currentMeetingDate = date.toISOString().split('T')[0];
                this.renderMeetingsUI();
            }

            nextDay() {
                const date = new Date(this.state.currentMeetingDate);
                date.setDate(date.getDate() + 1);
                this.state.currentMeetingDate = date.toISOString().split('T')[0];
                this.renderMeetingsUI();
            }

            goToToday() {
                this.state.currentMeetingDate = new Date().toISOString().split('T')[0];
                this.renderMeetingsUI();
            }

            // ==================== CALENDAR PICKER ====================
            openCalendar() {
                // Set calendar view month to current meeting date
                const date = new Date(this.state.currentMeetingDate);
                this.calendarViewMonth = date.getMonth();
                this.calendarViewYear = date.getFullYear();
                this.renderCalendar();
                document.getElementById('calendar-overlay').classList.add('show');
            }

            closeCalendar(event) {
                if (event && event.target !== event.currentTarget) return;
                document.getElementById('calendar-overlay').classList.remove('show');
            }

            calendarPrevMonth() {
                this.calendarViewMonth--;
                if (this.calendarViewMonth < 0) {
                    this.calendarViewMonth = 11;
                    this.calendarViewYear--;
                }
                this.renderCalendar();
            }

            calendarNextMonth() {
                this.calendarViewMonth++;
                if (this.calendarViewMonth > 11) {
                    this.calendarViewMonth = 0;
                    this.calendarViewYear++;
                }
                this.renderCalendar();
            }

            calendarGoToToday() {
                const today = new Date();
                this.state.currentMeetingDate = today.toISOString().split('T')[0];
                this.closeCalendar();
                this.renderMeetingsUI();
            }

            selectCalendarDate(dateStr) {
                this.state.currentMeetingDate = dateStr;
                this.closeCalendar();
                this.renderMeetingsUI();
            }

            renderCalendar() {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

                document.getElementById('calendar-month-title').textContent =
                    `${months[this.calendarViewMonth]} ${this.calendarViewYear}`;

                const container = document.getElementById('calendar-days');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const selectedDate = this.state.currentMeetingDate;

                // Get first day of month
                const firstDay = new Date(this.calendarViewYear, this.calendarViewMonth, 1);
                const lastDay = new Date(this.calendarViewYear, this.calendarViewMonth + 1, 0);
                const startDay = firstDay.getDay(); // 0 = Sunday

                // Get dates with meetings for this month (filtered by current service type)
                const currentServiceType = this.state.meetingsServiceType || 'SMS';
                const meetingDates = new Set(
                    this.state.meetings
                        .filter(m => {
                            const d = new Date(m.date);
                            return d.getMonth() === this.calendarViewMonth &&
                                   d.getFullYear() === this.calendarViewYear &&
                                   m.serviceType === currentServiceType;
                        })
                        .map(m => m.date)
                );

                let html = '';

                // Previous month days
                const prevMonth = new Date(this.calendarViewYear, this.calendarViewMonth, 0);
                for (let i = startDay - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    const dateStr = this.formatDateStr(this.calendarViewYear, this.calendarViewMonth - 1, day);
                    const hasMeeting = this.state.meetings.some(m => m.date === dateStr && m.serviceType === currentServiceType);
                    html += `<button class="calendar-day other-month ${hasMeeting ? 'has-meeting' : ''}"
                                    onclick="app.selectCalendarDate('${dateStr}')">${day}</button>`;
                }

                // Current month days
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = this.formatDateStr(this.calendarViewYear, this.calendarViewMonth, day);
                    const dateObj = new Date(this.calendarViewYear, this.calendarViewMonth, day);
                    dateObj.setHours(0, 0, 0, 0);

                    const isToday = dateObj.getTime() === today.getTime();
                    const isSelected = dateStr === selectedDate;
                    const hasMeeting = meetingDates.has(dateStr);

                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isSelected) classes += ' selected';
                    if (hasMeeting) classes += ' has-meeting';

                    html += `<button class="${classes}" onclick="app.selectCalendarDate('${dateStr}')">${day}</button>`;
                }

                // Next month days
                const totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
                const remaining = totalCells - (startDay + lastDay.getDate());
                for (let day = 1; day <= remaining; day++) {
                    const dateStr = this.formatDateStr(this.calendarViewYear, this.calendarViewMonth + 1, day);
                    const hasMeeting = this.state.meetings.some(m => m.date === dateStr && m.serviceType === currentServiceType);
                    html += `<button class="calendar-day other-month ${hasMeeting ? 'has-meeting' : ''}"
                                    onclick="app.selectCalendarDate('${dateStr}')">${day}</button>`;
                }

                container.innerHTML = html;
            }

            formatDateStr(year, month, day) {
                // Handle month overflow using local time (not UTC)
                const date = new Date(year, month, day);
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // Check if two meetings overlap in time
            meetingsOverlap(m1, m2) {
                const [h1, min1] = m1.startTime.split(':').map(Number);
                const [h2, min2] = m2.startTime.split(':').map(Number);

                let e1H, e1M, e2H, e2M;
                if (m1.endTime) {
                    [e1H, e1M] = m1.endTime.split(':').map(Number);
                } else {
                    e1H = h1 + 1;
                    e1M = min1;
                }
                if (m2.endTime) {
                    [e2H, e2M] = m2.endTime.split(':').map(Number);
                } else {
                    e2H = h2 + 1;
                    e2M = min2;
                }

                const start1 = h1 * 60 + min1;
                const end1 = e1H * 60 + e1M;
                const start2 = h2 * 60 + min2;
                const end2 = e2H * 60 + e2M;

                return (start1 < end2 && end1 > start2);
            }

            // Allocate meetings to lanes (columns) to avoid overlaps
            allocateMeetingLanes(meetings) {
                if (meetings.length === 0) return [];

                const lanes = [];

                meetings.forEach(meeting => {
                    // Find first lane where this meeting doesn't overlap with any existing meeting
                    let laneIndex = lanes.findIndex(lane =>
                        !lane.some(m => this.meetingsOverlap(meeting, m))
                    );

                    if (laneIndex === -1) {
                        // No available lane, create new one
                        lanes.push([meeting]);
                        meeting._lane = lanes.length - 1;
                    } else {
                        // Add to existing lane
                        lanes[laneIndex].push(meeting);
                        meeting._lane = laneIndex;
                    }
                });

                // Assign total lane count to each meeting
                meetings.forEach(m => {
                    m._totalLanes = lanes.length;
                });

                return meetings;
            }

            groupMeetingsByTimeSlot(meetings) {
                const grouped = {};
                meetings.forEach(meeting => {
                    if (!grouped[meeting.startTime]) {
                        grouped[meeting.startTime] = [];
                    }
                    grouped[meeting.startTime].push(meeting);
                });
                return grouped;
            }

            renderTimeSlots() {
                const container = document.getElementById('time-slots-container');
                const meetings = this.getMeetingsForDate(this.state.currentMeetingDate);
                const HOUR_HEIGHT = 120; // pixels per hour
                const START_HOUR = 6;   // Start from 6 AM
                const END_HOUR = 23;    // End at 11 PM
                const now = new Date();
                const currentHour = now.getHours();
                const isToday = this.state.currentMeetingDate === this.formatDateStr(now.getFullYear(), now.getMonth(), now.getDate());

                console.log(' Generating time slots from', START_HOUR, 'to', END_HOUR);

                // Generate time labels
                let timeLabelsHTML = '';
                let gridLinesHTML = '';
                for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                    const displayTime = hour > 12 ? `${hour - 12} PM` : hour === 12 ? '12 PM' : hour === 0 ? '12 AM' : `${hour} AM`;
                    const isCurrentHour = isToday && hour === currentHour;

                    timeLabelsHTML += `<div class="time-label">${displayTime}</div>`;
                    gridLinesHTML += `<div class="time-grid-line ${isCurrentHour ? 'current-hour' : ''}" data-hour="${hour}"></div>`;
                }
                console.log(' Generated', (END_HOUR - START_HOUR + 1), 'time slots');

                // Generate meeting blocks with proper positioning
                // Allocate meetings to lanes to avoid overlaps
                // Calculate non-overlapping vertical positions for all meetings
                const CARD_HEIGHT = 72; // Estimated card height with content
                const CARD_GAP = 4;     // Gap between cards
                let placedCards = [];    // Track placed card positions

                meetings.forEach(meeting => {
                    const [sH, sM] = meeting.startTime.split(':').map(Number);
                    const idealTop = ((sH - START_HOUR) * 60 + sM) / 60 * HOUR_HEIGHT;
                    let finalTop = idealTop;

                    // Push down if overlapping with any placed card
                    let hasOverlap = true;
                    while (hasOverlap) {
                        hasOverlap = false;
                        for (const card of placedCards) {
                            if (finalTop < card.bottom && finalTop + CARD_HEIGHT > card.top) {
                                finalTop = card.bottom + CARD_GAP;
                                hasOverlap = true;
                                break;
                            }
                        }
                    }

                    meeting._finalTop = finalTop;
                    placedCards.push({ top: finalTop, bottom: finalTop + CARD_HEIGHT });
                });

                let meetingBlocksHTML = meetings.map(meeting => {
                    return this.createMeetingBlockHTML(meeting, START_HOUR, HOUR_HEIGHT, isToday, now);
                }).join('');

                container.innerHTML = `
                    <div class="timetable">
                        <div class="time-labels">${timeLabelsHTML}</div>
                        <div class="time-grid">
                            ${gridLinesHTML}
                            <div class="meetings-layer">${meetingBlocksHTML}</div>
                        </div>
                    </div>
                `;

                // Check for upcoming meetings and show reminder
                if (isToday) {
                    this.checkMeetingReminders(meetings);
                }
            }

            createMeetingBlockHTML(meeting, startHour, hourHeight, isToday, now) {
                // Use pre-calculated position - no overlapping, full width
                const topPx = meeting._finalTop;
                const [startH, startM] = meeting.startTime.split(':').map(Number);

                // Determine status
                const hasNotes = meeting.notes && meeting.notes.trim().length > 0;
                const hasFiles = meeting.files && meeting.files.length > 0;
                const hasLinked = meeting.linkedRates && meeting.linkedRates.length > 0;
                const isCompleted = hasNotes || hasFiles || hasLinked;

                // Check if meeting is starting soon (within 15 minutes)
                let isStartingSoon = false;
                if (isToday && !isCompleted) {
                    const meetingStart = new Date(now);
                    meetingStart.setHours(startH, startM, 0, 0);
                    const diffMinutes = (meetingStart - now) / (1000 * 60);
                    isStartingSoon = diffMinutes > 0 && diffMinutes <= 15;
                }

                // Determine CSS class and colors based on service type
                const isVoice = (meeting.serviceType || 'SMS') === 'VOICE';
                const bgColor = isVoice ? '#d1fae5' : '#dbeafe';
                const borderColor = isVoice ? '#10b981' : '#3b82f6';
                const typeIcon = isVoice ? 'ph-phone-call' : 'ph-chat-text';
                const typeLabel = isVoice ? 'VOICE' : 'SMS';

                let blockClass = 'meeting-block';
                if (isCompleted) blockClass += ' completed';
                else if (isStartingSoon) blockClass += ' starting-soon';

                return `
                    <div class="${blockClass}"
                         style="top: ${topPx}px; width: calc(100% - 16px); left: 8px; background: ${bgColor}; border-left: 3px solid ${borderColor};"
                         onclick="event.stopPropagation(); app.openMeetingModal('${meeting.id}')">
                        <div class="company" style="display: flex; align-items: center; gap: 3px;">
                            <span style="font-size: 7px; padding: 1px 3px; background: ${borderColor}; color: white; border-radius: 3px; white-space: nowrap; flex-shrink: 0;">
                                <i class="ph ${typeIcon}"></i> ${typeLabel}
                            </span>
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0;">${this.escapeHtml(meeting.company)}</span>
                        </div>
                        <div class="time-range">
                            <i class="ph ph-clock"></i>
                            ${this.formatTimeDisplay(meeting.startTime)} - ${this.formatTimeDisplay(meeting.endTime || this.addHourToTime(meeting.startTime))}
                        </div>
                        ${meeting.scheduledBy ? `<div style="font-size: 9px; color: ${borderColor}; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="ph ph-user-circle"></i> ${this.escapeHtml(meeting.scheduledBy)}</div>` : ''}
                    </div>
                `;
            }

            checkMeetingReminders(meetings) {
                const now = new Date();
                meetings.forEach(meeting => {
                    const hasContent = meeting.notes?.trim() || meeting.files?.length > 0 || meeting.linkedRates?.length > 0;
                    if (hasContent) return; // Skip completed meetings

                    const [startH, startM] = meeting.startTime.split(':').map(Number);
                    const meetingStart = new Date(now);
                    meetingStart.setHours(startH, startM, 0, 0);
                    const diffMinutes = (meetingStart - now) / (1000 * 60);

                    // Show reminder if within 15 minutes
                    if (diffMinutes > 0 && diffMinutes <= 15) {
                        const reminderKey = `reminder_${meeting.id}_${this.state.currentMeetingDate}`;
                        if (!sessionStorage.getItem(reminderKey)) {
                            this.showMeetingReminder(meeting, Math.round(diffMinutes));
                            sessionStorage.setItem(reminderKey, 'shown');
                        }
                    }
                });
            }

            showMeetingReminder(meeting, minutes) {
                // Show toast notification
                this.showToast(` Meeting with ${meeting.company} starts in ${minutes} min!`, 'warning');

                // Try to show browser notification if permitted
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Meeting Reminder', {
                        body: `${meeting.company} - starts in ${minutes} minutes`,
                        icon: '',
                        tag: meeting.id
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            // Legacy card for backwards compatibility
            createMeetingCardHTML(meeting) {
                const hasNotes = meeting.notes && meeting.notes.trim().length > 0;
                const hasFiles = meeting.files && meeting.files.length > 0;
                const hasLinked = meeting.linkedRates && meeting.linkedRates.length > 0;
                const isVoice = (meeting.serviceType || 'SMS') === 'VOICE';
                const bgColor = isVoice ? '#d1fae5' : '#dbeafe';  // Green for VOICE, Blue for SMS
                const borderColor = isVoice ? '#10b981' : '#3b82f6';
                const typeIcon = isVoice ? 'ph-phone-call' : 'ph-chat-text';
                const typeLabel = isVoice ? 'VOICE' : 'SMS';

                return `
                    <div class="meeting-card ${hasNotes ? 'has-notes' : ''}"
                         style="background: ${bgColor}; border-left: 3px solid ${borderColor};"
                         onclick="event.stopPropagation(); app.openMeetingModal('${meeting.id}')">
                        <div class="company" style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 9px; padding: 1px 4px; background: ${borderColor}; color: white; border-radius: 3px;">
                                <i class="ph ${typeIcon}"></i> ${typeLabel}
                            </span>
                            ${this.escapeHtml(meeting.company)}
                        </div>
                        ${meeting.subject ? `<div class="subject">${this.escapeHtml(meeting.subject)}</div>` : ''}
                        <div class="meta" style="flex-wrap: wrap;">
                            <span><i class="ph ph-clock"></i> ${meeting.startTime}${meeting.endTime ? ' - ' + meeting.endTime : ''}</span>
                            ${meeting.scheduledBy ? `<span style="color: ${borderColor}; font-weight: 600;"><i class="ph ph-user-circle"></i> ${this.escapeHtml(meeting.scheduledBy)}</span>` : ''}
                            ${hasFiles ? `<span><i class="ph ph-paperclip"></i> ${meeting.files.length}</span>` : ''}
                            ${hasLinked ? `<span><i class="ph ph-link"></i> ${meeting.linkedRates.length}</span>` : ''}
                        </div>
                    </div>
                `;
            }

            getMeetingsForDate(dateStr) {
                // Filter meetings by date and current service type (SMS or VOICE)
                const currentServiceType = this.state.meetingsServiceType || 'SMS';
                return this.state.meetings.filter(m =>
                    m.date === dateStr && m.serviceType === currentServiceType
                )
                .sort((a, b) => a.startTime.localeCompare(b.startTime));
            }

            updateMeetingCount() {
                const count = this.getMeetingsForDate(this.state.currentMeetingDate).length;
                document.getElementById('meeting-count').textContent = `${count} meeting${count !== 1 ? 's' : ''}`;
            }

            // ==================== COMPANIES MANAGEMENT ====================
            setCompaniesServiceType(type) {
                this.state.companiesServiceType = type;

                // Update toggle buttons
                const smsBtn = document.getElementById('company-sms-btn');
                const voiceBtn = document.getElementById('company-voice-btn');
                const title = document.getElementById('companies-title');

                if (type === 'SMS') {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    title.textContent = 'SMS Companies';
                } else {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#249E94] text-white';
                    title.textContent = 'Voice Companies';
                }

                // Hide add form if open
                document.getElementById('add-company-form').classList.add('hidden');
                document.getElementById('add-company-btn').innerHTML = '<i class="ph-bold ph-plus"></i> Add';

                this.renderCompaniesUI();
            }

            setMeetingsServiceType(type) {
                this.state.meetingsServiceType = type;

                // Update toggle buttons
                const smsBtn = document.getElementById('meeting-sms-btn');
                const voiceBtn = document.getElementById('meeting-voice-btn');

                if (type === 'SMS') {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                } else {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#249E94] text-white';
                }

                this.renderMeetingsUI();
            }

            setClientOffersServiceType(type) {
                this.state.clientOffersServiceType = type;
                this.saveState();
                this.renderClientOffersUI();
            }

            renderClientOffersUI() {
                this.updateClientOffersToggleUI();
                this.renderClientOffersSection();
            }

            updateClientOffersToggleUI() {
                const type = this.state.clientOffersServiceType || 'SMS';
                const smsBtn = document.getElementById('clientoffers-sms-btn');
                const voiceBtn = document.getElementById('clientoffers-voice-btn');
                const title = document.getElementById('clientoffers-title');

                if (type === 'SMS') {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    title.textContent = 'SMS Client Offers';
                } else {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#249E94] text-white';
                    title.textContent = 'Voice Client Offers';
                }
            }

            filterClientOffers() {
                this.renderClientOffersSection();
            }

            clearClientOffersFilters() {
                document.getElementById('clientoffers-search').value = '';
                document.getElementById('clientoffers-date-from').value = '';
                document.getElementById('clientoffers-date-to').value = '';
                document.getElementById('clientoffers-filter-designation').value = '';
                document.getElementById('clientoffers-filter-product').value = '';
                document.getElementById('clientoffers-filter-network').value = '';
                document.getElementById('clientoffers-filter-rate').value = '';
                document.getElementById('clientoffers-filter-traffic').value = '';
                document.getElementById('clientoffers-filter-display').value = '';
                document.getElementById('clientoffers-filter-tps').value = '';
                document.getElementById('clientoffers-filter-cap').value = '';
                document.getElementById('clientoffers-filter-hop').value = '';
                this.renderClientOffersSection();
            }

            toggleClientOffersFilters() {
                const filters = document.getElementById('clientoffers-filters');
                const icon = document.getElementById('clientoffers-filter-icon');
                if (filters.style.display === 'none') {
                    filters.style.display = 'block';
                    icon.className = 'ph-bold ph-caret-down';
                } else {
                    filters.style.display = 'none';
                    icon.className = 'ph-bold ph-caret-right';
                }
            }

            toggleOurOffersFilters() {
                const filters = document.getElementById('ouroffers-filters');
                const icon = document.getElementById('ouroffers-filter-icon');
                if (filters.style.display === 'none') {
                    filters.style.display = 'block';
                    icon.className = 'ph-bold ph-caret-down';
                } else {
                    filters.style.display = 'none';
                    icon.className = 'ph-bold ph-caret-right';
                }
            }

            populateFilterDropdown(dropdownId, values, defaultText) {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;

                const currentValue = dropdown.value;
                const sortedValues = Array.from(values).sort();

                dropdown.innerHTML = `<option value="">${defaultText}</option>` +
                    sortedValues.map(val => `<option value="${this.escapeHtml(val)}">${this.escapeHtml(val)}</option>`).join('');

                // Restore previous selection if it still exists
                if (currentValue && sortedValues.includes(currentValue)) {
                    dropdown.value = currentValue;
                }
            }

            exportClientOffers() {
                const serviceType = this.state.clientOffersServiceType || 'SMS';

                // Get all filtered client offers
                const searchTerm = document.getElementById('clientoffers-search')?.value.toLowerCase().trim() || '';
                const dateFrom = document.getElementById('clientoffers-date-from')?.value || '';
                const dateTo = document.getElementById('clientoffers-date-to')?.value || '';
                const filterDesignation = document.getElementById('clientoffers-filter-designation')?.value || '';
                const filterProduct = document.getElementById('clientoffers-filter-product')?.value || '';
                const filterNetwork = document.getElementById('clientoffers-filter-network')?.value || '';
                const filterRate = document.getElementById('clientoffers-filter-rate')?.value || '';
                const filterTraffic = document.getElementById('clientoffers-filter-traffic')?.value || '';
                const filterDisplay = document.getElementById('clientoffers-filter-display')?.value || '';
                const filterTps = document.getElementById('clientoffers-filter-tps')?.value || '';
                const filterCap = document.getElementById('clientoffers-filter-cap')?.value || '';
                const filterHop = document.getElementById('clientoffers-filter-hop')?.value || '';

                // Filter meetings
                let companiesWithOffers = this.state.meetings.filter(m => {
                    if (!m.clientOffers || !Array.isArray(m.clientOffers) || m.clientOffers.length === 0) return false;
                    if ((m.serviceType || 'SMS') !== serviceType) return false;
                    if (searchTerm && !m.company.toLowerCase().includes(searchTerm)) return false;
                    if (dateFrom && m.date < dateFrom) return false;
                    if (dateTo && m.date > dateTo) return false;
                    return true;
                });

                if (companiesWithOffers.length === 0) {
                    this.showToast('No client offers to export', 'error');
                    return;
                }

                const wb = XLSX.utils.book_new();
                const exportData = [];

                // Headers
                if (serviceType === 'SMS') {
                    exportData.push(['Company', 'Date', 'Contact Person', 'Email', 'Phone', 'Designation', 'Product', 'Network', 'Rate', 'Traffic', 'Display', 'TPS', 'CAP', 'HOP']);
                } else {
                    exportData.push(['Company', 'Date', 'Contact Person', 'Email', 'Phone', 'Destination', 'Product', 'Breakout', 'Rate', 'Billing Increment', 'Display', 'ACD', 'ASR', 'HOP']);
                }

                // Data rows
                companiesWithOffers.forEach(meeting => {
                    meeting.clientOffers.forEach(offer => {
                        // Apply column filters
                        if (serviceType === 'SMS') {
                            if (filterDesignation && offer.designation !== filterDesignation) return;
                            if (filterProduct && offer.product !== filterProduct) return;
                            if (filterNetwork && offer.network !== filterNetwork) return;
                            if (filterRate && offer.rate !== filterRate) return;
                            if (filterTraffic && offer.traffic !== filterTraffic) return;
                            if (filterDisplay && offer.display !== filterDisplay) return;
                            if (filterTps && offer.tps !== filterTps) return;
                            if (filterCap && offer.cap !== filterCap) return;
                            if (filterHop && offer.hop !== filterHop) return;

                            exportData.push([
                                meeting.company || '',
                                meeting.date || '',
                                meeting.contactPerson || '',
                                meeting.email || '',
                                meeting.phone || '',
                                offer.designation || '',
                                offer.product || '',
                                offer.network || '',
                                offer.rate || '',
                                offer.traffic || '',
                                offer.display || '',
                                offer.tps || '',
                                offer.cap || '',
                                offer.hop || ''
                            ]);
                        } else {
                            if (filterDesignation && offer.destination !== filterDesignation) return;
                            if (filterProduct && offer.product !== filterProduct) return;
                            if (filterNetwork && offer.breakout !== filterNetwork) return;
                            if (filterRate && offer.rate !== filterRate) return;
                            if (filterTraffic && offer.billingIncrement !== filterTraffic) return;
                            if (filterDisplay && offer.display !== filterDisplay) return;
                            if (filterTps && offer.acd !== filterTps) return;
                            if (filterCap && offer.asr !== filterCap) return;
                            if (filterHop && offer.hop !== filterHop) return;

                            exportData.push([
                                meeting.company || '',
                                meeting.date || '',
                                meeting.contactPerson || '',
                                meeting.email || '',
                                meeting.phone || '',
                                offer.destination || '',
                                offer.product || '',
                                offer.breakout || '',
                                offer.rate || '',
                                offer.billingIncrement || '',
                                offer.display || '',
                                offer.acd || '',
                                offer.asr || '',
                                offer.hop || ''
                            ]);
                        }
                    });
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                ws['!cols'] = exportData[0].map(() => ({ wch: 15 }));

                XLSX.utils.book_append_sheet(wb, ws, `${serviceType} Client Offers`);

                const filename = `${serviceType.toLowerCase()}_client_offers_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                this.showToast('Client offers exported!');
            }

            toggleComparisonMode() {
                // Initialize comparison state if not exists
                if (!this.comparisonMode) {
                    this.comparisonMode = true;
                    this.selectedOffers = [];
                    document.getElementById('comparison-mode-btn').innerHTML = '<i class="ph-bold ph-check-square"></i> Show Comparison';
                    document.getElementById('comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors flex items-center gap-1';
                    this.showToast('Select offers to compare', 'info');
                } else if (this.selectedOffers.length === 0) {
                    // Cancel comparison mode
                    this.comparisonMode = false;
                    document.getElementById('comparison-mode-btn').innerHTML = '<i class="ph-bold ph-git-diff"></i> Compare';
                    document.getElementById('comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1';
                } else {
                    // Show comparison
                    this.showComparison();
                }
                this.renderClientOffersSection();
            }

            selectOfferForComparison(meetingId, offerIndex) {
                const key = `${meetingId}_${offerIndex}`;
                const index = this.selectedOffers.findIndex(o => o.key === key);

                if (index === -1) {
                    // Add to selection
                    const meeting = this.state.meetings.find(m => m.id === meetingId);
                    if (meeting && meeting.clientOffers[offerIndex]) {
                        this.selectedOffers.push({
                            key: key,
                            meeting: meeting,
                            offer: meeting.clientOffers[offerIndex],
                            offerIndex: offerIndex
                        });
                    }
                } else {
                    // Remove from selection
                    this.selectedOffers.splice(index, 1);
                }

                // Update button text
                if (this.selectedOffers.length > 0) {
                    document.getElementById('comparison-mode-btn').innerHTML = `<i class="ph-bold ph-check-square"></i> Compare (${this.selectedOffers.length})`;
                } else {
                    document.getElementById('comparison-mode-btn').innerHTML = '<i class="ph-bold ph-check-square"></i> Show Comparison';
                }

                this.renderClientOffersSection();
            }

            showComparison() {
                if (this.selectedOffers.length < 2) {
                    this.showToast('Select at least 2 offers to compare', 'error');
                    return;
                }

                const serviceType = this.state.clientOffersServiceType || 'SMS';
                const modal = document.getElementById('comparison-modal');
                const content = document.getElementById('comparison-content');

                let html = '<div class="overflow-x-auto"><table class="linked-rates-table"><thead><tr>';
                html += '<th>Company</th>';

                if (serviceType === 'SMS') {
                    html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                } else {
                    html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Increment</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                }

                html += '</tr></thead><tbody>';

                // Find best rate for highlighting
                const rates = this.selectedOffers.map(s => parseFloat(s.offer.rate) || Infinity);
                const bestRate = Math.min(...rates.filter(r => r !== Infinity));

                this.selectedOffers.forEach(selected => {
                    const { meeting, offer } = selected;
                    const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';
                    const isBestRate = parseFloat(offer.rate) === bestRate;

                    html += '<tr>';
                    html += `<td><strong>${this.escapeHtml(meeting.company)}</strong><br><small class="text-slate-500">${meeting.date}</small></td>`;

                    if (serviceType === 'SMS') {
                        html += `<td>${this.escapeHtml(offer.designation || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.product || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.network || '-')}</td>`;
                        html += `<td class="font-bold ${isBestRate ? 'bg-emerald-50' : ''}" style="color: ${color}">${this.escapeHtml(offer.rate || '-')} ${isBestRate ? '' : ''}</td>`;
                        html += `<td>${this.escapeHtml(offer.traffic || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.display || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.tps || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.cap || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    } else {
                        html += `<td>${this.escapeHtml(offer.destination || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.product || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.breakout || '-')}</td>`;
                        html += `<td class="font-bold ${isBestRate ? 'bg-emerald-50' : ''}" style="color: ${color}">${this.escapeHtml(offer.rate || '-')} ${isBestRate ? '' : ''}</td>`;
                        html += `<td>${this.escapeHtml(offer.billingIncrement || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.display || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.acd || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.asr || '-')}</td>`;
                        html += `<td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    }

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                html += '<p class="text-xs text-slate-500 mt-3 text-center"> indicates the best (lowest) rate</p>';

                content.innerHTML = html;
                modal.classList.add('show');
            }

            closeComparisonModal() {
                document.getElementById('comparison-modal').classList.remove('show');
                // Reset comparison mode
                this.comparisonMode = false;
                this.selectedOffers = [];
                document.getElementById('comparison-mode-btn').innerHTML = '<i class="ph-bold ph-git-diff"></i> Compare';
                document.getElementById('comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1';
                this.renderClientOffersSection();
            }

            renderCompaniesUI() {
                this.updateCompaniesToggleUI();
                this.renderCompaniesList();
                this.updateCompanyCount();
            }

            updateCompaniesToggleUI() {
                const type = this.state.companiesServiceType || 'SMS';
                const smsBtn = document.getElementById('company-sms-btn');
                const voiceBtn = document.getElementById('company-voice-btn');
                const title = document.getElementById('companies-title');

                if (type === 'SMS') {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    title.textContent = 'SMS Companies';
                } else {
                    smsBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                    voiceBtn.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#249E94] text-white';
                    title.textContent = 'Voice Companies';
                }
            }

            renderCompaniesList() {
                const container = document.getElementById('companies-list');
                const serviceType = this.state.companiesServiceType || 'SMS';

                // Fix any meetings with null companyId by matching company names
                const fixedMeetings = [];
                this.state.meetings.forEach(meeting => {
                    if (!meeting.companyId && meeting.company) {
                        const matchingCompany = this.state.companies.find(c => c.company === meeting.company);
                        if (matchingCompany) {
                            meeting.companyId = matchingCompany.id;
                            fixedMeetings.push(meeting);
                        }
                    }
                });
                // Save only the fixed meetings, not all
                fixedMeetings.forEach(m => this.saveSingleMeetingToSupabase(m).catch(err => console.error('Error fixing meeting ref:', err)));

                console.log(' DEBUG: All meetings:', this.state.meetings);
                console.log(' DEBUG: All companies:', this.state.companies);

                // Filter companies by service type
                const filteredCompanies = this.state.companies.filter(c =>
                    (c.serviceType || 'SMS') === serviceType
                );

                if (filteredCompanies.length === 0) {
                    const typeLabel = serviceType === 'SMS' ? 'SMS' : 'Voice';
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-400">
                                <i class="ph ph-buildings text-3xl"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-900">No ${typeLabel} Companies Yet</h3>
                            <p class="text-xs text-slate-500 mt-1">Add your first ${typeLabel} company to start scheduling meetings</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredCompanies.map(company => this.createCompanyCardHTML(company)).join('');
            }

            createCompanyCardHTML(company) {
                const initials = this.getCompanyInitials(company.company);
                const today = this.formatDateStr(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

                // Get meeting for this company (check if meeting exists for today or future dates)
                const todayDate = new Date().toISOString().split('T')[0];
                console.log(` DEBUG: Looking for meetings for company "${company.company}" (ID: ${company.id})`);
                console.log(` DEBUG: Today's date: ${todayDate}`);
                console.log(` DEBUG: Checking meetings:`, this.state.meetings.filter(m => m.companyId === company.id));

                const companyMeeting = this.state.meetings.find(m =>
                    m.companyId === company.id && m.date >= todayDate
                );
                const hasMeeting = !!companyMeeting;
                console.log(` DEBUG: Company "${company.company}" - Has meeting: ${hasMeeting}`, companyMeeting ? `(Meeting on ${companyMeeting.date})` : '(No upcoming meeting)');

                // Determine button based on meeting existence
                let actionButton = '';
                if (hasMeeting) {
                    // Show Details button to view meeting details
                    actionButton = `
                        <button class="btn-details" onclick="app.openMeetingModal('${companyMeeting.id}')">
                            <i class="ph-bold ph-info"></i> Details
                        </button>
                    `;
                } else {
                    // Show Schedule button if no meeting exists
                    actionButton = `
                        <button class="btn-schedule" onclick="app.openScheduleModal('${company.id}')">
                            <i class="ph-bold ph-calendar-plus"></i> Schedule
                        </button>
                    `;
                }

                return `
                    <div class="company-card">
                        <div class="company-avatar">${initials}</div>
                        <div class="company-info">
                            <div class="company-name">${this.escapeHtml(company.company)}</div>
                            ${company.contactPerson ? `<div class="company-contact"><i class="ph ph-map-pin"></i> ${this.escapeHtml(company.contactPerson)}</div>` : ''}
                            ${company.email ? `<div class="company-contact"><i class="ph ph-envelope"></i> ${this.escapeHtml(company.email)}</div>` : ''}
                            ${company.phone ? `<div class="company-contact"><i class="ph ph-phone"></i> ${this.escapeHtml(company.phone)}</div>` : ''}
                            ${company.createdBy ? `<div class="company-contact text-blue-600"><i class="ph ph-user-circle"></i> Added by: ${this.escapeHtml(company.createdBy)}</div>` : ''}
                            ${hasMeeting ? `<div class="company-contact text-emerald-600"><i class="ph ph-calendar-check"></i> Meeting scheduled</div>` : '<div class="company-contact text-slate-400"><i class="ph ph-calendar-x"></i> No meeting</div>'}
                        </div>
                        <div class="company-actions">
                            ${actionButton}
                            <button class="btn-icon danger" onclick="app.deleteCompany('${company.id}')">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            getCompanyInitials(name) {
                return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            }

            updateCompanyCount() {
                const serviceType = this.state.companiesServiceType || 'SMS';
                const count = this.state.companies.filter(c =>
                    (c.serviceType || 'SMS') === serviceType
                ).length;
                const typeLabel = serviceType === 'VOICE' ? 'Voice' : 'SMS';
                document.getElementById('company-count').textContent = `${count} ${typeLabel} compan${count !== 1 ? 'ies' : 'y'}`;
            }

            toggleAddCompanyForm() {
                const form = document.getElementById('add-company-form');
                const btn = document.getElementById('add-company-btn');

                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    btn.innerHTML = '<i class="ph-bold ph-x"></i> Cancel';
                    document.getElementById('new-company-name').focus();
                } else {
                    form.classList.add('hidden');
                    btn.innerHTML = '<i class="ph-bold ph-plus"></i> Add';
                    // Clear form
                    document.getElementById('new-company-name').value = '';
                    document.getElementById('new-company-delegate').value = '';
                    document.getElementById('new-company-email').value = '';
                    document.getElementById('new-company-phone').value = '';
                    document.getElementById('new-company-created-by').value = '';
                }
            }

            saveNewCompany() {
                const name = document.getElementById('new-company-name').value.trim();
                const delegate = document.getElementById('new-company-delegate').value.trim();
                const email = document.getElementById('new-company-email').value.trim();
                const phone = document.getElementById('new-company-phone').value.trim();
                const createdBy = document.getElementById('new-company-created-by').value.trim();

                if (!name) {
                    this.showToast('Company name is required', 'error');
                    return;
                }

                if (!createdBy) {
                    this.showToast('Created By email is required', 'error');
                    return;
                }

                // Basic email validation
                if (!createdBy.includes('@')) {
                    this.showToast('Please enter a valid email', 'error');
                    return;
                }

                const company = {
                    id: `company_${Date.now()}`,
                    company: name,  // FIXED: Changed from 'name' to 'company'
                    contactPerson: delegate,  // FIXED: Changed from 'delegate' to 'contactPerson'
                    email,
                    phone,
                    skype: null,
                    whatsapp: null,
                    serviceType: this.state.companiesServiceType || 'SMS',
                    createdBy: createdBy,  // Who created this company
                    createdAt: new Date().toISOString()
                };

                this.state.companies.push(company);
                this.saveSingleCompanyToSupabase(company).catch(err => {
                    console.error('Error saving company:', err);
                    this.showToast('Error saving company', 'error');
                });
                this.toggleAddCompanyForm();
                this.renderCompaniesUI();
                const typeLabel = company.serviceType === 'VOICE' ? 'Voice' : 'SMS';
                this.showToast(`${typeLabel} company added!`);
            }

            async deleteCompany(companyId) {
                const company = this.state.companies.find(c => c.id === companyId);
                if (!company) return;

                if (confirm(`Delete ${company.company}? This will also delete all their scheduled meetings.`)) {
                    // Get meeting IDs for this company
                    const meetingIds = this.state.meetings
                        .filter(m => m.companyId === companyId)
                        .map(m => m.id)
                        .filter(Boolean);

                    // Remove from in-memory state
                    this.state.companies = this.state.companies.filter(c => c.id !== companyId);
                    this.state.meetings = this.state.meetings.filter(m => m.companyId !== companyId);

                    // Delete directly from DB
                    try {
                        if (meetingIds.length > 0) {
                            await supabaseClient.from('meeting_files').delete().in('meeting_id', meetingIds);
                            await supabaseClient.from('meetings').delete().in('id', meetingIds);
                        }
                        await supabaseClient.from('companies').delete().eq('id', companyId);
                    } catch (err) {
                        console.error('Error deleting company from DB:', err);
                    }

                    this.renderCompaniesUI();
                    this.showToast('Company deleted');
                }
            }

            // ==================== SCHEDULE MEETING MODAL ====================
            openScheduleModal(companyId) {
                const company = this.state.companies.find(c => c.id === companyId);
                if (!company) return;

                this.schedulingCompanyId = companyId;

                // Set company info in modal
                document.getElementById('schedule-company-id').value = companyId;
                document.getElementById('schedule-company-avatar').textContent = this.getCompanyInitials(company.company);
                document.getElementById('schedule-company-name').textContent = company.company;
                // FIXED: Use contactPerson instead of contact
                const contactInfo = company.contactPerson || company.email || company.phone || 'No contact info';
                document.getElementById('schedule-company-contact').textContent = contactInfo;

                // Set default date to today
                document.getElementById('schedule-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('schedule-start').value = '09:00';
                document.getElementById('schedule-end').value = '10:00';
                document.getElementById('schedule-subject').value = '';

                document.getElementById('schedule-modal').classList.add('show');
            }

            closeScheduleModal() {
                document.getElementById('schedule-modal').classList.remove('show');
                document.getElementById('schedule-by-email').value = '';
                document.getElementById('schedule-subject').value = '';
                this.schedulingCompanyId = null;
            }

            confirmScheduleMeeting() {
                // Prevent duplicate submissions
                const scheduleBtn = document.getElementById('schedule-btn');
                if (scheduleBtn && scheduleBtn.disabled) return;

                const companyId = document.getElementById('schedule-company-id').value;
                console.log(' DEBUG: confirmScheduleMeeting - companyId from hidden input:', companyId);
                console.log(' DEBUG: confirmScheduleMeeting - this.schedulingCompanyId:', this.schedulingCompanyId);

                const date = document.getElementById('schedule-date').value;
                const startTime = document.getElementById('schedule-start').value;
                const endTime = document.getElementById('schedule-end').value;
                const subject = document.getElementById('schedule-subject').value.trim();
                const scheduledBy = document.getElementById('schedule-by-email').value.trim();

                if (!date) {
                    this.showToast('Please select a date', 'error');
                    return;
                }

                if (!startTime) {
                    this.showToast('Please select start time', 'error');
                    return;
                }

                if (!scheduledBy) {
                    this.showToast('Please enter your email', 'error');
                    return;
                }

                if (!scheduledBy.includes('@')) {
                    this.showToast('Please enter a valid email', 'error');
                    return;
                }

                const company = this.state.companies.find(c => c.id === companyId);
                console.log(' DEBUG: Found company:', company);
                if (!company) {
                    console.error(' ERROR: Company not found for ID:', companyId);
                    return;
                }

                // Disable button to prevent double-click
                if (scheduleBtn) {
                    scheduleBtn.disabled = true;
                    scheduleBtn.textContent = 'Scheduling...';
                }

                const meeting = {
                    id: `meeting_${Date.now()}`,
                    companyId: companyId,
                    company: company.company,
                    serviceType: company.serviceType || 'SMS',  // Inherit from company
                    // Copy company contact details to meeting
                    contactPerson: company.contactPerson || '',
                    email: company.email || '',
                    phone: company.phone || '',
                    skype: company.skype || '',
                    whatsapp: company.whatsapp || '',
                    date,
                    startTime,
                    endTime,
                    subject,
                    scheduledBy: scheduledBy,  // Who scheduled this meeting
                    notes: '',
                    strongRegion: '',  // Can be filled later in meeting details
                    lookingFor: '',
                    activeStatus: null,
                    reason: '',
                    payable: '',
                    dealProposals: '',
                    routeIssue: '',
                    clientOffers: [],
                    linkedRates: [],
                    files: [],
                    status: 'scheduled',
                    createdAt: new Date().toISOString()
                };

                console.log(' DEBUG: Created meeting object:', meeting);
                console.log(' DEBUG: Meeting companyId:', meeting.companyId);

                this.state.meetings.push(meeting);

                // Save only this new meeting (fast - 1 DB call, not all)
                this.saveSingleMeetingToSupabase(meeting).then(() => {
                    this.closeScheduleModal();
                    this.renderCompaniesUI();
                    this.renderMeetingsUI();
                    const typeLabel = meeting.serviceType === 'VOICE' ? 'Voice' : 'SMS';
                    this.showToast(`${typeLabel} meeting scheduled!`);

                    if (scheduleBtn) {
                        scheduleBtn.disabled = false;
                        scheduleBtn.textContent = 'Schedule';
                    }
                }).catch(error => {
                    console.error('Error saving meeting:', error);
                    this.showToast('Error scheduling meeting', 'error');

                    if (scheduleBtn) {
                        scheduleBtn.disabled = false;
                        scheduleBtn.textContent = 'Schedule';
                    }
                });
            }

            // ==================== MEETING DETAIL MODAL ====================
            openMeetingModal(meetingId) {
                if (!meetingId) return;

                const meeting = this.state.meetings.find(m => m.id === meetingId);
                if (!meeting) return;

                const modal = document.getElementById('meeting-modal');

                // Reset form
                this.pendingMeetingFiles = meeting.files ? [...meeting.files] : [];
                this.pendingLinkedRates = meeting.linkedRates ? [...meeting.linkedRates] : [];
                this.editingMeetingId = meetingId;

                // Set meeting info header (Details View)
                document.getElementById('meeting-id').value = meeting.id;
                document.getElementById('meeting-company-avatar').textContent = this.getCompanyInitials(meeting.company);
                document.getElementById('meeting-company-display').textContent = meeting.company;
                document.getElementById('meeting-subject-display').textContent = meeting.subject || '';

                // Format time display
                const startTime = this.formatTimeDisplay(meeting.startTime);
                const endTime = meeting.endTime ? this.formatTimeDisplay(meeting.endTime) : '';
                const timeStr = endTime ? `${startTime} - ${endTime}` : startTime;
                document.getElementById('meeting-time-display').textContent = timeStr;

                // Show who created the company and who scheduled the meeting
                const company = this.state.companies.find(c => c.id === meeting.companyId);
                const createdByDisplay = document.getElementById('meeting-created-by-display');
                let createdByText = '';
                if (company && company.createdBy) {
                    createdByText += `<i class="ph ph-buildings"></i> Company added by: ${this.escapeHtml(company.createdBy)}`;
                }
                if (meeting.scheduledBy) {
                    if (createdByText) createdByText += '<br>';
                    createdByText += `<i class="ph ph-calendar-plus"></i> Scheduled by: ${this.escapeHtml(meeting.scheduledBy)}`;
                }
                createdByDisplay.innerHTML = createdByText;

                // Set status badge and action button
                const statusBadge = document.getElementById('meeting-status-badge');
                const actionBtn = document.getElementById('meeting-action-btn');
                const actionText = document.getElementById('meeting-action-text');
                const actionIcon = actionBtn.querySelector('i');

                const hasContent = meeting.notes?.trim() || meeting.clientOffers?.length > 0 || meeting.files?.length > 0 || meeting.linkedRates?.length > 0 || meeting.strongRegion?.trim() || meeting.lookingFor?.trim() || meeting.reason?.trim() || meeting.payable?.trim() || meeting.dealProposals?.trim() || meeting.routeIssue?.trim() || meeting.activeStatus;

                if (hasContent) {
                    statusBadge.textContent = 'Completed';
                    statusBadge.className = 'meeting-status completed';
                    // Show Edit button only
                    actionText.textContent = 'Edit';
                    actionIcon.className = 'ph-bold ph-pencil-simple';
                    actionBtn.className = 'flex-1 py-3 bg-[#3BC1A8] text-white rounded-xl font-semibold text-sm flex items-center justify-center gap-2';
                } else {
                    statusBadge.textContent = 'Scheduled';
                    statusBadge.className = 'meeting-status scheduled';
                    // Show Add Details button
                    actionText.textContent = 'Add Details';
                    actionIcon.className = 'ph-bold ph-plus-circle';
                    actionBtn.className = 'flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm flex items-center justify-center gap-2';
                }

                modal.classList.add('show');

                // If no content yet, go directly to edit mode
                // Otherwise show details view first
                if (!hasContent) {
                    this.switchToEditMode();
                } else {
                    // Render Details View (read-only)
                    this.renderMeetingDetailsView(meeting);
                    // Show details view, hide edit view
                    document.getElementById('meeting-details-view').classList.remove('hidden');
                    document.getElementById('meeting-edit-view').classList.add('hidden');
                }
            }

            // Render read-only details view
            renderMeetingDetailsView(meeting) {
                // Meeting Details Grid
                const detailsGrid = document.getElementById('meeting-details-grid');
                detailsGrid.innerHTML = `
                    <div><span class="text-slate-400">Strong Region:</span> <span class="font-medium">${this.escapeHtml(meeting.strongRegion || '-')}</span></div>
                    <div><span class="text-slate-400">Looking For:</span> <span class="font-medium">${this.escapeHtml(meeting.lookingFor || '-')}</span></div>
                    <div><span class="text-slate-400">Status:</span> <span class="font-medium ${meeting.activeStatus === 'active' ? 'text-emerald-600' : 'text-red-500'}">${meeting.activeStatus === 'active' ? 'Active' : meeting.activeStatus === 'inactive' ? 'Inactive' : '-'}</span></div>
                    <div><span class="text-slate-400">Reason:</span> <span class="font-medium">${this.escapeHtml(meeting.reason || '-')}</span></div>
                    <div><span class="text-slate-400">Payable/Receivable:</span> <span class="font-medium">${this.escapeHtml(meeting.payable || '-')}</span></div>
                    <div><span class="text-slate-400">Deal Proposals:</span> <span class="font-medium">${this.escapeHtml(meeting.dealProposals || '-')}</span></div>
                    <div class="col-span-2"><span class="text-slate-400">Route Issue:</span> <span class="font-medium">${this.escapeHtml(meeting.routeIssue || '-')}</span></div>
                `;

                // Linked rates (Our Offers)
                this.renderLinkedRatesTable(meeting.linkedRates || []);

                // Client Offers display
                this.renderClientOffersDisplay(meeting);

                // Attachments display
                this.renderMeetingFilesDisplay(meeting.files || []);

                // Notes display
                const notesDisplay = document.getElementById('meeting-notes-display');
                if (meeting.notes && meeting.notes.trim()) {
                    notesDisplay.innerHTML = `<div class="whitespace-pre-wrap">${this.escapeHtml(meeting.notes)}</div>`;
                } else {
                    notesDisplay.innerHTML = '<span class="text-slate-400 italic">No notes</span>';
                }
            }

            // Render linked rates as full table with all columns
            renderLinkedRatesTable(linkedRates) {
                const container = document.getElementById('linked-rates-display');

                if (!linkedRates || linkedRates.length === 0) {
                    container.innerHTML = '<p class="text-sm text-slate-400 italic p-3 bg-white border border-slate-200 rounded-xl">No linked data</p>';
                    return;
                }

                // Get full data for each linked rate
                // Use stored fullData first, fallback to retrieving from state.data
                const ratesWithData = linkedRates.map(rate => {
                    // If fullData is already stored, use it
                    if (rate.fullData) {
                        return rate;
                    }
                    // Otherwise try to get from state.data (for older saved meetings)
                    const data = this.state.data[rate.key];
                    if (data && data[rate.index]) {
                        return { ...rate, fullData: data[rate.index] };
                    }
                    return rate;
                }).filter(r => r.fullData);

                if (ratesWithData.length === 0) {
                    container.innerHTML = '<p class="text-sm text-slate-400 italic p-3 bg-white border border-slate-200 rounded-xl">Linked data no longer available</p>';
                    return;
                }

                // Group by service type (SMS or VOICE)
                const smsRates = ratesWithData.filter(r => r.key.startsWith('SMS'));
                const voiceRates = ratesWithData.filter(r => r.key.startsWith('VOICE'));

                let html = '';

                // SMS Table - columns: designation, product, network, rate, traffic, display, tps, cap, hop
                if (smsRates.length > 0) {
                    html += `
                        <div class="mb-3">
                            <p class="text-[10px] uppercase tracking-wider text-[#3BC1A8] font-bold mb-1">SMS Rates</p>
                            <table class="linked-rates-table">
                                <thead>
                                    <tr>
                                        <th>Designation</th>
                                        <th>Product</th>
                                        <th>Network</th>
                                        <th>Rate</th>
                                        <th>Traffic</th>
                                        <th>Display</th>
                                        <th>TPS</th>
                                        <th>CAP</th>
                                        <th>HOP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${smsRates.map(r => `
                                        <tr>
                                            <td>${this.escapeHtml(r.fullData.designation || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.product || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.network || '-')}</td>
                                            <td class="font-semibold text-emerald-600">${this.escapeHtml(r.fullData.rate || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.traffic || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.display || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.tps || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.cap || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.hop || '-')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // VOICE Table - columns: destination, product, breakout, rate, billing, display, acd, asr, hop
                if (voiceRates.length > 0) {
                    html += `
                        <div class="mb-3">
                            <p class="text-[10px] uppercase tracking-wider text-[#249E94] font-bold mb-1">Voice Rates</p>
                            <table class="linked-rates-table">
                                <thead>
                                    <tr>
                                        <th>Destination</th>
                                        <th>Product</th>
                                        <th>Breakout</th>
                                        <th>Rate</th>
                                        <th>Billing</th>
                                        <th>Display</th>
                                        <th>ACD</th>
                                        <th>ASR</th>
                                        <th>HOP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${voiceRates.map(r => `
                                        <tr>
                                            <td>${this.escapeHtml(r.fullData.destination || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.product || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.breakout || '-')}</td>
                                            <td class="font-semibold text-emerald-600">${this.escapeHtml(r.fullData.rate || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.billing || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.display || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.acd || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.asr || '-')}</td>
                                            <td>${this.escapeHtml(r.fullData.hop || '-')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                container.innerHTML = html;
            }

            // Render files in read-only display
            renderMeetingFilesDisplay(files) {
                const container = document.getElementById('meeting-files-display');

                if (!files || files.length === 0) {
                    container.innerHTML = '<p class="text-sm text-slate-400 italic p-3 bg-white border border-slate-200 rounded-xl">No attachments</p>';
                    return;
                }

                container.innerHTML = files.map(file => {
                    const isImage = file.type && file.type.startsWith('image/');
                    const isPDF = file.type && file.type === 'application/pdf';
                    const fileIcon = isImage ? 'ph-image' : (isPDF ? 'ph-file-pdf' : 'ph-file');

                    return `
                        <div class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl">
                            <i class="ph ${fileIcon} text-slate-400 text-xl"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-slate-700 truncate">${this.escapeHtml(file.name)}</p>
                                <p class="text-[10px] text-slate-400">${this.formatFileSize(file.size)}</p>
                            </div>
                            ${file.data ? `
                                <div class="flex items-center gap-1">
                                    ${isImage ? `
                                        <button onclick="app.viewFile('${file.id}')" class="p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg" title="View">
                                            <i class="ph ph-eye"></i>
                                        </button>
                                    ` : ''}
                                    <a href="${file.data}" download="${this.escapeHtml(file.name)}" class="p-2 text-[#3BC1A8] hover:bg-[#3BC1A8]/10 rounded-lg" title="Download">
                                        <i class="ph ph-download-simple"></i>
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            // View file (images) in a modal/new tab
            viewFile(fileId) {
                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                if (!meeting || !meeting.files) return;

                // Find file by ID, or by name as fallback
                const file = meeting.files.find(f => f.id === fileId || f.name === fileId);
                if (!file || !file.data) {
                    console.error('File not found or no data:', fileId);
                    this.showToast('Unable to view file', 'error');
                    return;
                }

                // Open image in new tab
                const newTab = window.open();
                if (newTab) {
                    newTab.document.write(`
                        <html>
                        <head>
                            <title>${this.escapeHtml(file.name)}</title>
                            <style>
                                body {
                                    margin: 0;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    min-height: 100vh;
                                    background: #1e293b;
                                }
                                img {
                                    max-width: 95%;
                                    max-height: 95vh;
                                    object-fit: contain;
                                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                                }
                            </style>
                        </head>
                        <body>
                            <img src="${file.data}" alt="${this.escapeHtml(file.name)}">
                        </body>
                        </html>
                    `);
                    newTab.document.close();
                } else {
                    this.showToast('Please allow pop-ups to view file', 'error');
                }
            }

            // Switch to edit mode
            switchToEditMode() {
                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                if (!meeting) return;

                // Populate edit form header
                document.getElementById('meeting-company-avatar-edit').textContent = this.getCompanyInitials(meeting.company);
                document.getElementById('meeting-company-display-edit').textContent = meeting.company;
                const startTime = this.formatTimeDisplay(meeting.startTime);
                const endTime = meeting.endTime ? this.formatTimeDisplay(meeting.endTime) : '';
                document.getElementById('meeting-time-display-edit').textContent = endTime ? `${startTime} - ${endTime}` : startTime;

                // Show who created company and scheduled meeting in edit view
                const companyEdit = this.state.companies.find(c => c.id === meeting.companyId);
                const editCreatedByDisplay = document.getElementById('meeting-created-by-display-edit');
                let editCreatedByText = '';
                if (companyEdit && companyEdit.createdBy) {
                    editCreatedByText += `<i class="ph ph-buildings"></i> Company added by: ${this.escapeHtml(companyEdit.createdBy)}`;
                }
                if (meeting.scheduledBy) {
                    if (editCreatedByText) editCreatedByText += '<br>';
                    editCreatedByText += `<i class="ph ph-calendar-plus"></i> Scheduled by: ${this.escapeHtml(meeting.scheduledBy)}`;
                }
                editCreatedByDisplay.innerHTML = editCreatedByText;

                // Populate meeting detail fields
                document.getElementById('meeting-strong-region').value = meeting.strongRegion || '';
                document.getElementById('meeting-looking-for').value = meeting.lookingFor || '';
                document.getElementById('meeting-status-select').value = meeting.activeStatus || 'active';
                document.getElementById('meeting-reason').value = meeting.reason || '';
                document.getElementById('meeting-payable').value = meeting.payable || '';
                document.getElementById('meeting-deal-proposals').value = meeting.dealProposals || '';
                document.getElementById('meeting-route-issue').value = meeting.routeIssue || '';

                // Show/hide client offers table based on service type
                const serviceType = meeting.serviceType || 'SMS';
                const smsTable = document.getElementById('sms-client-offers-table');
                const voiceTable = document.getElementById('voice-client-offers-table');

                if (serviceType === 'SMS') {
                    smsTable.classList.remove('hidden');
                    voiceTable.classList.add('hidden');
                    this.loadClientOffersData(meeting.clientOffers || [], 'SMS');
                } else {
                    smsTable.classList.add('hidden');
                    voiceTable.classList.remove('hidden');
                    this.loadClientOffersData(meeting.clientOffers || [], 'VOICE');
                }

                document.getElementById('meeting-notes').value = meeting.notes || '';

                // Clear rate search and hide suggestions
                const rateSearch = document.getElementById('meeting-rate-search');
                if (rateSearch) rateSearch.value = '';
                this.hideRateSuggestions();

                // Populate linked data and files
                this.populateRateDropdown();
                this.renderLinkedRates();
                this.renderMeetingFiles();

                // Show edit view, hide details view
                document.getElementById('meeting-details-view').classList.add('hidden');
                document.getElementById('meeting-edit-view').classList.remove('hidden');
            }

            // Switch back to details mode (cancel edit)
            switchToDetailsMode() {
                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                if (!meeting) {
                    this.closeMeetingModal();
                    return;
                }

                // Reset pending data to original
                this.pendingMeetingFiles = meeting.files ? [...meeting.files] : [];
                this.pendingLinkedRates = meeting.linkedRates ? [...meeting.linkedRates] : [];

                // Hide rate suggestions
                this.hideRateSuggestions();

                // Re-render details view
                this.renderMeetingDetailsView(meeting);

                // Show details view, hide edit view
                document.getElementById('meeting-details-view').classList.remove('hidden');
                document.getElementById('meeting-edit-view').classList.add('hidden');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            toggleOfferTable(cardId) {
                const table = document.getElementById(`table-${cardId}`);
                const icon = document.getElementById(`icon-${cardId}`);
                if (table && icon) {
                    table.classList.toggle('table-collapsed');
                    icon.className = table.classList.contains('table-collapsed') ? 'ph-bold ph-caret-down' : 'ph-bold ph-caret-up';
                }
            }

            formatFileSize(bytes) {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            formatTimeDisplay(timeStr) {
                if (!timeStr) return '';
                const [hours, mins] = timeStr.split(':').map(Number);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const hour12 = hours % 12 || 12;
                return `${hour12}:${mins.toString().padStart(2, '0')} ${ampm}`;
            }

            closeMeetingModal() {
                document.getElementById('meeting-modal').classList.remove('show');
                // Reset to details view for next open
                document.getElementById('meeting-details-view').classList.remove('hidden');
                document.getElementById('meeting-edit-view').classList.add('hidden');
                // Hide rate suggestions and clear search
                this.hideRateSuggestions();
                const rateSearch = document.getElementById('meeting-rate-search');
                if (rateSearch) rateSearch.value = '';
                this.editingMeetingId = null;
                this.pendingMeetingFiles = [];
                this.pendingLinkedRates = [];
            }

            addHourToTime(timeStr) {
                const [hours, mins] = timeStr.split(':').map(Number);
                const newHour = Math.min(hours + 1, 23);
                return `${newHour.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            async saveMeetingDetails() {
                if (!this.editingMeetingId) return;

                const saveBtn = document.getElementById('meeting-save-btn');
                if (saveBtn && saveBtn.disabled) return;

                const index = this.state.meetings.findIndex(m => m.id === this.editingMeetingId);
                if (index === -1) return;

                // Disable save button while saving
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }

                // Get all form values
                const strongRegion = document.getElementById('meeting-strong-region').value.trim();
                const lookingFor = document.getElementById('meeting-looking-for').value.trim();
                const activeStatus = document.getElementById('meeting-status-select').value;
                const reason = document.getElementById('meeting-reason').value.trim();
                const payable = document.getElementById('meeting-payable').value.trim();
                const dealProposals = document.getElementById('meeting-deal-proposals').value.trim();
                const routeIssue = document.getElementById('meeting-route-issue').value.trim();
                const notes = document.getElementById('meeting-notes').value.trim();

                // Get client offers from table based on service type
                const meetingServiceType = this.state.meetings[index].serviceType || 'SMS';
                const clientOffers = this.getClientOffersData(meetingServiceType);

                // Update meeting with all fields
                this.state.meetings[index] = {
                    ...this.state.meetings[index],
                    strongRegion,
                    lookingFor,
                    activeStatus,
                    reason,
                    payable,
                    dealProposals,
                    routeIssue,
                    clientOffers,
                    notes,
                    linkedRates: [...this.pendingLinkedRates],
                    files: [...this.pendingMeetingFiles],
                    updatedAt: new Date().toISOString()
                };

                // Save only this meeting to database (fast - single meeting, not all)
                const meeting = this.state.meetings[index];
                console.log(' saveMeetingDetails: About to save meeting:', meeting.id, {
                    strongRegion, lookingFor, activeStatus, reason, payable, dealProposals, routeIssue, notes,
                    clientOffersCount: clientOffers?.length,
                    linkedRatesCount: this.pendingLinkedRates?.length,
                    filesCount: this.pendingMeetingFiles?.length
                });
                try {
                    await this.saveSingleMeetingToSupabase(meeting);
                    console.log(' saveMeetingDetails: Save completed successfully for', meeting.id);
                } catch (error) {
                    console.error(' saveMeetingDetails: SAVE FAILED for', meeting.id, error);
                    this.showToast('Error saving meeting details', 'error');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                    }
                    return;
                }
                const hasContent = meeting.notes?.trim() || meeting.files?.length > 0 || meeting.linkedRates?.length > 0 || meeting.clientOffers?.length > 0 || meeting.strongRegion?.trim() || meeting.lookingFor?.trim() || meeting.reason?.trim() || meeting.payable?.trim() || meeting.dealProposals?.trim() || meeting.routeIssue?.trim();

                // Update status badge and action button
                const statusBadge = document.getElementById('meeting-status-badge');
                const actionBtn = document.getElementById('meeting-action-btn');
                const actionText = document.getElementById('meeting-action-text');
                const actionIcon = actionBtn.querySelector('i');

                if (hasContent) {
                    statusBadge.textContent = 'Completed';
                    statusBadge.className = 'meeting-status completed';
                    // Switch action button to Edit mode
                    actionText.textContent = 'Edit';
                    actionIcon.className = 'ph-bold ph-pencil-simple';
                    actionBtn.className = 'flex-1 py-3 bg-[#3BC1A8] text-white rounded-xl font-semibold text-sm flex items-center justify-center gap-2';
                }

                // Re-enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }

                // Re-render details view and switch back to read-only
                this.renderMeetingDetailsView(meeting);
                document.getElementById('meeting-details-view').classList.remove('hidden');
                document.getElementById('meeting-edit-view').classList.add('hidden');

                this.renderMeetingsUI();
                this.renderCompaniesUI();
                this.showToast('Meeting details saved!');
            }

            async deleteMeeting() {
                if (!this.editingMeetingId) return;

                if (confirm('Delete this meeting?')) {
                    const meetingId = this.editingMeetingId;
                    this.state.meetings = this.state.meetings.filter(m => m.id !== meetingId);

                    // Delete directly from DB
                    try {
                        await supabaseClient.from('meeting_files').delete().eq('meeting_id', meetingId);
                        await supabaseClient.from('meetings').delete().eq('id', meetingId);
                    } catch (err) {
                        console.error('Error deleting meeting from DB:', err);
                    }

                    this.closeMeetingModal();
                    this.renderMeetingsUI();
                    this.renderCompaniesUI();
                    this.showToast('Meeting deleted');
                }
            }

            // ==================== CLIENT OFFERS ====================
            addClientOfferRow(serviceType) {
                const tbody = document.getElementById(`${serviceType.toLowerCase()}-client-offers-rows`);
                const row = document.createElement('tr');

                if (serviceType === 'SMS') {
                    row.innerHTML = `
                        <td><input type="text" placeholder="Designation"></td>
                        <td><input type="text" placeholder="Product"></td>
                        <td><input type="text" placeholder="Network"></td>
                        <td><input type="text" placeholder="Rate"></td>
                        <td><input type="text" placeholder="Traffic"></td>
                        <td><input type="text" placeholder="Display"></td>
                        <td><input type="text" placeholder="TPS"></td>
                        <td><input type="text" placeholder="CAP"></td>
                        <td><input type="text" placeholder="HOP"></td>
                        <td style="text-align: center;"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700 p-2"><i class="ph-bold ph-trash"></i></button></td>
                    `;
                } else {
                    row.innerHTML = `
                        <td><input type="text" placeholder="Destination"></td>
                        <td><input type="text" placeholder="Product"></td>
                        <td><input type="text" placeholder="Breakout"></td>
                        <td><input type="text" placeholder="Rate"></td>
                        <td><input type="text" placeholder="Billing Increment"></td>
                        <td><input type="text" placeholder="Display"></td>
                        <td><input type="text" placeholder="ACD"></td>
                        <td><input type="text" placeholder="ASR"></td>
                        <td><input type="text" placeholder="HOP"></td>
                        <td style="text-align: center;"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700 p-2"><i class="ph-bold ph-trash"></i></button></td>
                    `;
                }

                tbody.appendChild(row);
            }

            getClientOffersData(serviceType) {
                const tbody = document.getElementById(`${serviceType.toLowerCase()}-client-offers-rows`);
                const rows = tbody.querySelectorAll('tr');
                const data = [];

                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if (serviceType === 'SMS') {
                        data.push({
                            designation: inputs[0].value.trim(),
                            product: inputs[1].value.trim(),
                            network: inputs[2].value.trim(),
                            rate: inputs[3].value.trim(),
                            traffic: inputs[4].value.trim(),
                            display: inputs[5].value.trim(),
                            tps: inputs[6].value.trim(),
                            cap: inputs[7].value.trim(),
                            hop: inputs[8].value.trim()
                        });
                    } else {
                        data.push({
                            destination: inputs[0].value.trim(),
                            product: inputs[1].value.trim(),
                            breakout: inputs[2].value.trim(),
                            rate: inputs[3].value.trim(),
                            billingIncrement: inputs[4].value.trim(),
                            display: inputs[5].value.trim(),
                            acd: inputs[6].value.trim(),
                            asr: inputs[7].value.trim(),
                            hop: inputs[8].value.trim()
                        });
                    }
                });

                return data.filter(row => Object.values(row).some(val => val));
            }

            loadClientOffersData(data, serviceType) {
                const tbody = document.getElementById(`${serviceType.toLowerCase()}-client-offers-rows`);
                tbody.innerHTML = '';

                if (!data || data.length === 0) return;

                data.forEach(rowData => {
                    this.addClientOfferRow(serviceType);
                    const row = tbody.lastElementChild;
                    const inputs = row.querySelectorAll('input');

                    if (serviceType === 'SMS') {
                        inputs[0].value = rowData.designation || '';
                        inputs[1].value = rowData.product || '';
                        inputs[2].value = rowData.network || '';
                        inputs[3].value = rowData.rate || '';
                        inputs[4].value = rowData.traffic || '';
                        inputs[5].value = rowData.display || '';
                        inputs[6].value = rowData.tps || '';
                        inputs[7].value = rowData.cap || '';
                        inputs[8].value = rowData.hop || '';
                    } else {
                        inputs[0].value = rowData.destination || '';
                        inputs[1].value = rowData.product || '';
                        inputs[2].value = rowData.breakout || '';
                        inputs[3].value = rowData.rate || '';
                        inputs[4].value = rowData.billingIncrement || '';
                        inputs[5].value = rowData.display || '';
                        inputs[6].value = rowData.acd || '';
                        inputs[7].value = rowData.asr || '';
                        inputs[8].value = rowData.hop || '';
                    }
                });
            }

            renderClientOffersDisplay(meeting) {
                const container = document.getElementById('client-offers-display');

                if (!meeting.clientOffers || !Array.isArray(meeting.clientOffers) || meeting.clientOffers.length === 0) {
                    container.innerHTML = '<span class="text-slate-400 italic text-sm">No client offers</span>';
                    return;
                }

                const serviceType = meeting.serviceType || 'SMS';
                let html = '<div class="overflow-x-auto border border-slate-200 rounded-xl"><table class="linked-rates-table"><thead><tr>';

                if (serviceType === 'SMS') {
                    html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                } else {
                    html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Increment</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                }

                html += '</tr></thead><tbody>';

                meeting.clientOffers.forEach(row => {
                    html += '<tr>';
                    if (serviceType === 'SMS') {
                        html += `
                            <td>${this.escapeHtml(row.designation || '-')}</td>
                            <td>${this.escapeHtml(row.product || '-')}</td>
                            <td>${this.escapeHtml(row.network || '-')}</td>
                            <td class="font-semibold text-[#3BC1A8]">${this.escapeHtml(row.rate || '-')}</td>
                            <td>${this.escapeHtml(row.traffic || '-')}</td>
                            <td>${this.escapeHtml(row.display || '-')}</td>
                            <td>${this.escapeHtml(row.tps || '-')}</td>
                            <td>${this.escapeHtml(row.cap || '-')}</td>
                            <td>${this.escapeHtml(row.hop || '-')}</td>
                        `;
                    } else {
                        html += `
                            <td>${this.escapeHtml(row.destination || '-')}</td>
                            <td>${this.escapeHtml(row.product || '-')}</td>
                            <td>${this.escapeHtml(row.breakout || '-')}</td>
                            <td class="font-semibold text-[#249E94]">${this.escapeHtml(row.rate || '-')}</td>
                            <td>${this.escapeHtml(row.billingIncrement || '-')}</td>
                            <td>${this.escapeHtml(row.display || '-')}</td>
                            <td>${this.escapeHtml(row.acd || '-')}</td>
                            <td>${this.escapeHtml(row.asr || '-')}</td>
                            <td>${this.escapeHtml(row.hop || '-')}</td>
                        `;
                    }
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            renderClientOffersSection() {
                const content = document.getElementById('clientoffers-content');
                const serviceType = this.state.clientOffersServiceType || 'SMS';

                // Get filter values
                const searchTerm = document.getElementById('clientoffers-search')?.value.toLowerCase().trim() || '';
                const dateFrom = document.getElementById('clientoffers-date-from')?.value || '';
                const dateTo = document.getElementById('clientoffers-date-to')?.value || '';
                const filterDesignation = document.getElementById('clientoffers-filter-designation')?.value || '';
                const filterProduct = document.getElementById('clientoffers-filter-product')?.value || '';
                const filterNetwork = document.getElementById('clientoffers-filter-network')?.value || '';
                const filterRate = document.getElementById('clientoffers-filter-rate')?.value || '';
                const filterTraffic = document.getElementById('clientoffers-filter-traffic')?.value || '';
                const filterDisplay = document.getElementById('clientoffers-filter-display')?.value || '';
                const filterTps = document.getElementById('clientoffers-filter-tps')?.value || '';
                const filterCap = document.getElementById('clientoffers-filter-cap')?.value || '';
                const filterHop = document.getElementById('clientoffers-filter-hop')?.value || '';

                // Collect all unique values for filters
                const designations = new Set(), products = new Set(), networks = new Set(), rates = new Set();
                const traffics = new Set(), displays = new Set(), tpss = new Set();
                const caps = new Set(), hops = new Set();

                this.state.meetings.forEach(m => {
                    if (m.clientOffers && Array.isArray(m.clientOffers) && (m.serviceType || 'SMS') === serviceType) {
                        m.clientOffers.forEach(offer => {
                            if (serviceType === 'SMS') {
                                if (offer.designation) designations.add(offer.designation);
                                if (offer.product) products.add(offer.product);
                                if (offer.network) networks.add(offer.network);
                                if (offer.rate) rates.add(offer.rate);
                                if (offer.traffic) traffics.add(offer.traffic);
                                if (offer.display) displays.add(offer.display);
                                if (offer.tps) tpss.add(offer.tps);
                                if (offer.cap) caps.add(offer.cap);
                                if (offer.hop) hops.add(offer.hop);
                            } else {
                                if (offer.destination) designations.add(offer.destination);
                                if (offer.product) products.add(offer.product);
                                if (offer.breakout) networks.add(offer.breakout);
                                if (offer.rate) rates.add(offer.rate);
                                if (offer.billingIncrement) traffics.add(offer.billingIncrement);
                                if (offer.display) displays.add(offer.display);
                                if (offer.acd) tpss.add(offer.acd);
                                if (offer.asr) caps.add(offer.asr);
                                if (offer.hop) hops.add(offer.hop);
                            }
                        });
                    }
                });

                // Populate filter dropdowns
                this.populateFilterDropdown('clientoffers-filter-designation', designations,
                    serviceType === 'SMS' ? 'All Designations' : 'All Destinations');
                this.populateFilterDropdown('clientoffers-filter-product', products, 'All Products');
                this.populateFilterDropdown('clientoffers-filter-network', networks,
                    serviceType === 'SMS' ? 'All Networks' : 'All Breakouts');
                this.populateFilterDropdown('clientoffers-filter-rate', rates, 'All Rates');
                this.populateFilterDropdown('clientoffers-filter-traffic', traffics,
                    serviceType === 'SMS' ? 'All Traffic' : 'All Billing Inc.');
                this.populateFilterDropdown('clientoffers-filter-display', displays, 'All Display');
                this.populateFilterDropdown('clientoffers-filter-tps', tpss,
                    serviceType === 'SMS' ? 'All TPS' : 'All ACD');
                this.populateFilterDropdown('clientoffers-filter-cap', caps,
                    serviceType === 'SMS' ? 'All CAP' : 'All ASR');
                this.populateFilterDropdown('clientoffers-filter-hop', hops, 'All HOP');

                // Filter meetings with client offers
                let companiesWithOffers = this.state.meetings.filter(m => {
                    // Must have client offers and match service type
                    if (!m.clientOffers || !Array.isArray(m.clientOffers) || m.clientOffers.length === 0) return false;
                    if ((m.serviceType || 'SMS') !== serviceType) return false;

                    // Apply search filter
                    if (searchTerm && !m.company.toLowerCase().includes(searchTerm)) return false;

                    // Apply date range filter
                    if (dateFrom && m.date < dateFrom) return false;
                    if (dateTo && m.date > dateTo) return false;

                    // Apply column filters - check if any offer matches
                    const hasFilters = filterDesignation || filterProduct || filterNetwork || filterRate || filterTraffic || filterDisplay || filterTps || filterCap || filterHop;
                    if (hasFilters) {
                        const hasMatch = m.clientOffers.some(offer => {
                            if (serviceType === 'SMS') {
                                if (filterDesignation && offer.designation !== filterDesignation) return false;
                                if (filterProduct && offer.product !== filterProduct) return false;
                                if (filterNetwork && offer.network !== filterNetwork) return false;
                                if (filterRate && offer.rate !== filterRate) return false;
                                if (filterTraffic && offer.traffic !== filterTraffic) return false;
                                if (filterDisplay && offer.display !== filterDisplay) return false;
                                if (filterTps && offer.tps !== filterTps) return false;
                                if (filterCap && offer.cap !== filterCap) return false;
                                if (filterHop && offer.hop !== filterHop) return false;
                            } else {
                                if (filterDesignation && offer.destination !== filterDesignation) return false;
                                if (filterProduct && offer.product !== filterProduct) return false;
                                if (filterNetwork && offer.breakout !== filterNetwork) return false;
                                if (filterRate && offer.rate !== filterRate) return false;
                                if (filterTraffic && offer.billingIncrement !== filterTraffic) return false;
                                if (filterDisplay && offer.display !== filterDisplay) return false;
                                if (filterTps && offer.acd !== filterTps) return false;
                                if (filterCap && offer.asr !== filterCap) return false;
                                if (filterHop && offer.hop !== filterHop) return false;
                            }
                            return true;
                        });
                        if (!hasMatch) return false;
                    }

                    return true;
                });

                // Flatten to individual offers with company info
                const allOffers = [];
                companiesWithOffers.forEach(m => {
                    m.clientOffers.forEach(offer => {
                        // Apply filters to individual offers
                        if (serviceType === 'SMS') {
                            if (filterDesignation && offer.designation !== filterDesignation) return;
                            if (filterProduct && offer.product !== filterProduct) return;
                            if (filterNetwork && offer.network !== filterNetwork) return;
                            if (filterRate && offer.rate !== filterRate) return;
                            if (filterTraffic && offer.traffic !== filterTraffic) return;
                            if (filterDisplay && offer.display !== filterDisplay) return;
                            if (filterTps && offer.tps !== filterTps) return;
                            if (filterCap && offer.cap !== filterCap) return;
                            if (filterHop && offer.hop !== filterHop) return;
                        } else {
                            if (filterDesignation && offer.destination !== filterDesignation) return;
                            if (filterProduct && offer.product !== filterProduct) return;
                            if (filterNetwork && offer.breakout !== filterNetwork) return;
                            if (filterRate && offer.rate !== filterRate) return;
                            if (filterTraffic && offer.billingIncrement !== filterTraffic) return;
                            if (filterDisplay && offer.display !== filterDisplay) return;
                            if (filterTps && offer.acd !== filterTps) return;
                            if (filterCap && offer.asr !== filterCap) return;
                            if (filterHop && offer.hop !== filterHop) return;
                        }
                        allOffers.push({ meeting: m, offer: offer });
                    });
                });

                if (allOffers.length === 0) {
                    const hasAnyFilters = searchTerm || dateFrom || dateTo || filterDesignation || filterProduct || filterNetwork || filterRate || filterTraffic || filterDisplay || filterTps || filterCap || filterHop;
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-400">
                                <i class="ph ${hasAnyFilters ? 'ph-magnifying-glass' : 'ph-download'} text-3xl"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-900">${hasAnyFilters ? 'No Results Found' : 'No Client Offers Yet'}</h3>
                            <p class="text-xs text-slate-500 mt-1">${hasAnyFilters ? 'Try adjusting your filters' : 'Client offers will appear here when you add them to meetings'}</p>
                        </div>
                    `;
                    return;
                }

                // Check if any filters are active
                const hasAnyFilters = searchTerm || dateFrom || dateTo || filterDesignation || filterProduct || filterNetwork || filterRate || filterTraffic || filterDisplay || filterTps || filterCap || filterHop;
                const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';

                // Show unified table view ONLY when filters are active
                if (hasAnyFilters || this.comparisonMode) {
                let html = `
                    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="linked-rates-table">
                                <thead>
                                    <tr>`;

                if (this.comparisonMode) {
                    html += '<th style="width: 40px;"><i class="ph-bold ph-check-square"></i></th>';
                }

                html += '<th>Company</th><th>Date</th>';

                if (serviceType === 'SMS') {
                    html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                } else {
                    html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Inc.</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                }

                html += '</tr></thead><tbody>';

                allOffers.forEach(({ meeting, offer }, index) => {
                    const serviceType = meeting.serviceType || 'SMS';
                    const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';

                    // Find the offer index in the original meeting for checkbox functionality
                    const offerIndex = meeting.clientOffers.findIndex(o => o === offer);
                    const offerKey = `${meeting.id}_${offerIndex}`;
                    const isSelected = this.comparisonMode && this.selectedOffers?.some(o => o.key === offerKey);

                    html += '<tr>';

                    if (this.comparisonMode) {
                        html += `
                            <td style="text-align: center;">
                                <input type="checkbox" ${isSelected ? 'checked' : ''}
                                    onchange="app.selectOfferForComparison('${meeting.id}', ${offerIndex})"
                                    class="cursor-pointer" style="width: 18px; height: 18px;" />
                            </td>`;
                    }

                    html += `
                        <td><strong>${this.escapeHtml(meeting.company)}</strong></td>
                        <td><small>${meeting.date}</small></td>`;

                    if (serviceType === 'SMS') {
                        html += `
                            <td>${this.escapeHtml(offer.designation || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.network || '-')}</td>
                            <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                            <td>${this.escapeHtml(offer.traffic || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.tps || '-')}</td>
                            <td>${this.escapeHtml(offer.cap || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    } else {
                        html += `
                            <td>${this.escapeHtml(offer.destination || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.breakout || '-')}</td>
                            <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                            <td>${this.escapeHtml(offer.billingIncrement || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.acd || '-')}</td>
                            <td>${this.escapeHtml(offer.asr || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    }

                    html += '</tr>';
                });

                    html += '</tbody></table></div></div>';
                    content.innerHTML = html;
                } else {
                    // Show original company card view when NO filters are active
                    let html = '<div class="space-y-4">';

                    // Group offers back by company
                    const companiesByMeeting = {};
                    allOffers.forEach(({ meeting, offer }) => {
                        if (!companiesByMeeting[meeting.id]) {
                            companiesByMeeting[meeting.id] = { meeting: meeting, offers: [] };
                        }
                        companiesByMeeting[meeting.id].offers.push(offer);
                    });

                    Object.values(companiesByMeeting).forEach(({ meeting, offers }, idx) => {
                        const cardId = `offer-${meeting.id}-${idx}`;
                        html += `
                            <div class="border border-slate-200 rounded-xl p-4 bg-white shadow-sm">
                                <div class="flex items-start justify-between mb-3 pb-3 border-b border-slate-100">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h3 class="font-bold text-slate-800 text-base">${this.escapeHtml(meeting.company)}</h3>
                                            <span class="px-2 py-0.5 rounded text-xs font-semibold" style="background: ${color}20; color: ${color}">
                                                ${serviceType}
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-calendar text-teal-600"></i>
                                                <span>${meeting.date} - ${this.formatTimeDisplay(meeting.startTime)}</span>
                                            </div>
                                            ${meeting.strongRegion ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-globe text-teal-600"></i>
                                                <span><strong>Region:</strong> ${this.escapeHtml(meeting.strongRegion)}</span>
                                            </div>` : ''}
                                            ${meeting.contactPerson ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-user text-teal-600"></i>
                                                <span>${this.escapeHtml(meeting.contactPerson)}</span>
                                            </div>` : ''}
                                            ${meeting.email ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-envelope text-teal-600"></i>
                                                <a href="mailto:${this.escapeHtml(meeting.email)}" class="text-teal-600 hover:underline">${this.escapeHtml(meeting.email)}</a>
                                            </div>` : ''}
                                            ${meeting.phone ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-phone text-teal-600"></i>
                                                <a href="tel:${this.escapeHtml(meeting.phone)}" class="text-teal-600 hover:underline">${this.escapeHtml(meeting.phone)}</a>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                    <button onclick="app.toggleOfferTable('${cardId}')" class="toggle-table-btn" title="Collapse/Expand">
                                        <i class="ph-bold ph-caret-up" id="icon-${cardId}"></i>
                                    </button>
                                </div>
                                <div class="overflow-x-auto" id="table-${cardId}">
                                    <table class="linked-rates-table">
                                        <thead><tr>`;

                        if (serviceType === 'SMS') {
                            html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                        } else {
                            html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Inc.</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                        }

                        html += '</tr></thead><tbody>';

                        offers.forEach(offer => {
                            html += '<tr>';
                            if (serviceType === 'SMS') {
                                html += `
                                    <td>${this.escapeHtml(offer.designation || '-')}</td>
                                    <td>${this.escapeHtml(offer.product || '-')}</td>
                                    <td>${this.escapeHtml(offer.network || '-')}</td>
                                    <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                                    <td>${this.escapeHtml(offer.traffic || '-')}</td>
                                    <td>${this.escapeHtml(offer.display || '-')}</td>
                                    <td>${this.escapeHtml(offer.tps || '-')}</td>
                                    <td>${this.escapeHtml(offer.cap || '-')}</td>
                                    <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                            } else {
                                html += `
                                    <td>${this.escapeHtml(offer.destination || '-')}</td>
                                    <td>${this.escapeHtml(offer.product || '-')}</td>
                                    <td>${this.escapeHtml(offer.breakout || '-')}</td>
                                    <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                                    <td>${this.escapeHtml(offer.billingIncrement || '-')}</td>
                                    <td>${this.escapeHtml(offer.display || '-')}</td>
                                    <td>${this.escapeHtml(offer.acd || '-')}</td>
                                    <td>${this.escapeHtml(offer.asr || '-')}</td>
                                    <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                            }
                            html += '</tr>';
                        });

                        html += '</tbody></table></div></div>';
                    });

                    html += '</div>';
                    content.innerHTML = html;
                }
            }

            // ==================== OUR OFFERS ====================
            setOurOffersServiceType(type) {
                this.state.ourOffersServiceType = type;
                document.getElementById('ouroffers-sms-btn').className = type === 'SMS' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                document.getElementById('ouroffers-voice-btn').className = type === 'VOICE' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                document.getElementById('ouroffers-title').textContent = `${type} Our Offers`;
                this.renderOurOffersSection();
            }

            renderOurOffersUI() {
                const type = this.state.ourOffersServiceType || 'SMS';
                document.getElementById('ouroffers-sms-btn').className = type === 'SMS' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                document.getElementById('ouroffers-voice-btn').className = type === 'VOICE' ? 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-[#3BC1A8] text-white' : 'flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-slate-300';
                document.getElementById('ouroffers-title').textContent = `${type} Our Offers`;

                // Populate filter dropdowns
                this.populateOurOffersFilters();

                // Render the offers
                this.renderOurOffersSection();
            }

            populateOurOffersFilters() {
                const serviceType = this.state.ourOffersServiceType || 'SMS';
                const uniqueValues = {
                    designation: new Set(),
                    product: new Set(),
                    network: new Set(),
                    rate: new Set(),
                    traffic: new Set(),
                    display: new Set(),
                    tps: new Set(),
                    cap: new Set(),
                    hop: new Set()
                };

                this.state.meetings.forEach(meeting => {
                    if ((meeting.serviceType || 'SMS') !== serviceType) return;
                    if (!meeting.linkedRates || !Array.isArray(meeting.linkedRates)) return;

                    meeting.linkedRates.forEach(linkedRate => {
                        // Resolve the actual rate data from linkedRates reference
                        const rateData = this.state.data[linkedRate.key]?.[linkedRate.index];
                        if (!rateData) return;

                        if (serviceType === 'SMS') {
                            if (rateData.designation) uniqueValues.designation.add(rateData.designation);
                            if (rateData.product) uniqueValues.product.add(rateData.product);
                            if (rateData.network) uniqueValues.network.add(rateData.network);
                            if (rateData.rate) uniqueValues.rate.add(rateData.rate);
                            if (rateData.traffic) uniqueValues.traffic.add(rateData.traffic);
                            if (rateData.display) uniqueValues.display.add(rateData.display);
                            if (rateData.tps) uniqueValues.tps.add(rateData.tps);
                            if (rateData.cap) uniqueValues.cap.add(rateData.cap);
                            if (rateData.hop) uniqueValues.hop.add(rateData.hop);
                        } else {
                            if (rateData.destination) uniqueValues.designation.add(rateData.destination);
                            if (rateData.product) uniqueValues.product.add(rateData.product);
                            if (rateData.breakout) uniqueValues.network.add(rateData.breakout);
                            if (rateData.rate) uniqueValues.rate.add(rateData.rate);
                            if (rateData.billingIncrement) uniqueValues.traffic.add(rateData.billingIncrement);
                            if (rateData.display) uniqueValues.display.add(rateData.display);
                            if (rateData.acd) uniqueValues.tps.add(rateData.acd);
                            if (rateData.asr) uniqueValues.cap.add(rateData.asr);
                            if (rateData.hop) uniqueValues.hop.add(rateData.hop);
                        }
                    });
                });

                const filterIds = ['designation', 'product', 'network', 'rate', 'traffic', 'display', 'tps', 'cap', 'hop'];
                filterIds.forEach(filterId => {
                    const select = document.getElementById(`ouroffers-filter-${filterId}`);
                    if (select) {
                        const currentValue = select.value;
                        const options = Array.from(uniqueValues[filterId]).sort();
                        select.innerHTML = `<option value="">All ${filterId.charAt(0).toUpperCase() + filterId.slice(1)}s</option>`;
                        options.forEach(opt => {
                            select.innerHTML += `<option value="${this.escapeHtml(opt)}">${this.escapeHtml(opt)}</option>`;
                        });
                        if (currentValue && options.includes(currentValue)) {
                            select.value = currentValue;
                        }
                    }
                });
            }

            filterOurOffers() {
                this.renderOurOffersSection();
            }

            clearOurOffersFilters() {
                document.getElementById('ouroffers-search').value = '';
                document.getElementById('ouroffers-date-from').value = '';
                document.getElementById('ouroffers-date-to').value = '';
                document.getElementById('ouroffers-filter-designation').selectedIndex = 0;
                document.getElementById('ouroffers-filter-product').selectedIndex = 0;
                document.getElementById('ouroffers-filter-network').selectedIndex = 0;
                document.getElementById('ouroffers-filter-rate').selectedIndex = 0;
                document.getElementById('ouroffers-filter-traffic').selectedIndex = 0;
                document.getElementById('ouroffers-filter-display').selectedIndex = 0;
                document.getElementById('ouroffers-filter-tps').selectedIndex = 0;
                document.getElementById('ouroffers-filter-cap').selectedIndex = 0;
                document.getElementById('ouroffers-filter-hop').selectedIndex = 0;

                // Exit comparison mode if active
                if (this.ourOffersComparisonMode) {
                    this.ourOffersComparisonMode = false;
                    this.selectedOurOffers = [];
                    document.getElementById('ouroffers-comparison-mode-btn').innerHTML = '<i class="ph-bold ph-git-diff"></i> Compare';
                    document.getElementById('ouroffers-comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1';
                }

                this.renderOurOffersSection();
            }

            exportOurOffers() {
                const serviceType = this.state.ourOffersServiceType || 'SMS';

                // Get all filtered our offers
                const searchTerm = document.getElementById('ouroffers-search')?.value.toLowerCase().trim() || '';
                const dateFrom = document.getElementById('ouroffers-date-from')?.value || '';
                const dateTo = document.getElementById('ouroffers-date-to')?.value || '';
                const filterDesignation = document.getElementById('ouroffers-filter-designation')?.value || '';
                const filterProduct = document.getElementById('ouroffers-filter-product')?.value || '';
                const filterNetwork = document.getElementById('ouroffers-filter-network')?.value || '';
                const filterRate = document.getElementById('ouroffers-filter-rate')?.value || '';
                const filterTraffic = document.getElementById('ouroffers-filter-traffic')?.value || '';
                const filterDisplay = document.getElementById('ouroffers-filter-display')?.value || '';
                const filterTps = document.getElementById('ouroffers-filter-tps')?.value || '';
                const filterCap = document.getElementById('ouroffers-filter-cap')?.value || '';
                const filterHop = document.getElementById('ouroffers-filter-hop')?.value || '';

                // Filter meetings
                let companiesWithOffers = this.state.meetings.filter(m => {
                    if (!m.linkedRates || !Array.isArray(m.linkedRates) || m.linkedRates.length === 0) return false;
                    if ((m.serviceType || 'SMS') !== serviceType) return false;
                    if (searchTerm && !m.company.toLowerCase().includes(searchTerm)) return false;
                    if (dateFrom && m.date < dateFrom) return false;
                    if (dateTo && m.date > dateTo) return false;
                    return true;
                });

                if (companiesWithOffers.length === 0) {
                    this.showToast('No our offers to export', 'error');
                    return;
                }

                const wb = XLSX.utils.book_new();
                const exportData = [];

                // Headers
                if (serviceType === 'SMS') {
                    exportData.push(['Company', 'Date', 'Contact Person', 'Email', 'Phone', 'Designation', 'Product', 'Network', 'Rate', 'Traffic', 'Display', 'TPS', 'CAP', 'HOP']);
                } else {
                    exportData.push(['Company', 'Date', 'Contact Person', 'Email', 'Phone', 'Destination', 'Product', 'Breakout', 'Rate', 'Billing Increment', 'Display', 'ACD', 'ASR', 'HOP']);
                }

                // Data rows
                companiesWithOffers.forEach(meeting => {
                    meeting.linkedRates.forEach(linkedRate => {
                        // Resolve the actual rate data from linkedRates reference
                        const rateData = this.state.data[linkedRate.key]?.[linkedRate.index];
                        if (!rateData) return;

                        // Apply column filters
                        if (serviceType === 'SMS') {
                            if (filterDesignation && rateData.designation !== filterDesignation) return;
                            if (filterProduct && rateData.product !== filterProduct) return;
                            if (filterNetwork && rateData.network !== filterNetwork) return;
                            if (filterRate && rateData.rate !== filterRate) return;
                            if (filterTraffic && rateData.traffic !== filterTraffic) return;
                            if (filterDisplay && rateData.display !== filterDisplay) return;
                            if (filterTps && rateData.tps !== filterTps) return;
                            if (filterCap && rateData.cap !== filterCap) return;
                            if (filterHop && rateData.hop !== filterHop) return;

                            exportData.push([
                                meeting.company || '',
                                meeting.date || '',
                                meeting.contactPerson || '',
                                meeting.email || '',
                                meeting.phone || '',
                                rateData.designation || '',
                                rateData.product || '',
                                rateData.network || '',
                                rateData.rate || '',
                                rateData.traffic || '',
                                rateData.display || '',
                                rateData.tps || '',
                                rateData.cap || '',
                                rateData.hop || ''
                            ]);
                        } else {
                            if (filterDesignation && rateData.destination !== filterDesignation) return;
                            if (filterProduct && rateData.product !== filterProduct) return;
                            if (filterNetwork && rateData.breakout !== filterNetwork) return;
                            if (filterRate && rateData.rate !== filterRate) return;
                            if (filterTraffic && rateData.billingIncrement !== filterTraffic) return;
                            if (filterDisplay && rateData.display !== filterDisplay) return;
                            if (filterTps && rateData.acd !== filterTps) return;
                            if (filterCap && rateData.asr !== filterCap) return;
                            if (filterHop && rateData.hop !== filterHop) return;

                            exportData.push([
                                meeting.company || '',
                                meeting.date || '',
                                meeting.contactPerson || '',
                                meeting.email || '',
                                meeting.phone || '',
                                rateData.destination || '',
                                rateData.product || '',
                                rateData.breakout || '',
                                rateData.rate || '',
                                rateData.billingIncrement || '',
                                rateData.display || '',
                                rateData.acd || '',
                                rateData.asr || '',
                                rateData.hop || ''
                            ]);
                        }
                    });
                });

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                ws['!cols'] = exportData[0].map(() => ({ wch: 15 }));

                XLSX.utils.book_append_sheet(wb, ws, `${serviceType} Our Offers`);

                const filename = `${serviceType.toLowerCase()}_our_offers_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                this.showToast('Our offers exported!');
            }

            toggleOurOffersComparisonMode() {
                // Initialize comparison state if not exists
                if (!this.ourOffersComparisonMode) {
                    this.ourOffersComparisonMode = true;
                    this.selectedOurOffers = [];
                    document.getElementById('ouroffers-comparison-mode-btn').innerHTML = '<i class="ph-bold ph-check-square"></i> Show Comparison';
                    document.getElementById('ouroffers-comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors flex items-center gap-1';
                    this.showToast('Select offers to compare', 'info');
                } else if (this.selectedOurOffers.length === 0) {
                    // Cancel comparison mode
                    this.ourOffersComparisonMode = false;
                    document.getElementById('ouroffers-comparison-mode-btn').innerHTML = '<i class="ph-bold ph-git-diff"></i> Compare';
                    document.getElementById('ouroffers-comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1';
                } else {
                    // Show comparison
                    this.showOurOffersComparison();
                }
                this.renderOurOffersSection();
            }

            selectOurOfferForComparison(meetingId, offerIndex) {
                if (!this.ourOffersComparisonMode) return;

                const meeting = this.state.meetings.find(m => m.id === meetingId);
                if (!meeting || !meeting.linkedRates || !meeting.linkedRates[offerIndex]) return;

                const linkedRate = meeting.linkedRates[offerIndex];
                // Resolve the actual rate data from linkedRates reference
                const rateData = this.state.data[linkedRate.key]?.[linkedRate.index];
                if (!rateData) return;

                const offerKey = `${meetingId}_${offerIndex}`;

                const existingIndex = this.selectedOurOffers.findIndex(o => o.key === offerKey);
                if (existingIndex >= 0) {
                    this.selectedOurOffers.splice(existingIndex, 1);
                } else {
                    this.selectedOurOffers.push({ key: offerKey, meeting, offer: rateData });
                }

                this.renderOurOffersSection();
            }

            showOurOffersComparison() {
                if (!this.selectedOurOffers || this.selectedOurOffers.length === 0) {
                    this.showToast('No offers selected', 'error');
                    return;
                }

                const serviceType = this.state.ourOffersServiceType || 'SMS';
                const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';

                // Find the best rate
                const rates = this.selectedOurOffers.map(s => parseFloat(s.offer.rate) || Infinity);
                const bestRate = Math.min(...rates.filter(r => r !== Infinity));

                let html = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) app.closeOurOffersComparison()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                <h3 class="text-lg font-bold text-slate-800">Our Offers Comparison (${this.selectedOurOffers.length} offers)</h3>
                                <button onclick="app.closeOurOffersComparison()" class="text-slate-400 hover:text-slate-600 transition-colors">
                                    <i class="ph-bold ph-x text-2xl"></i>
                                </button>
                            </div>
                            <div class="overflow-auto flex-1 p-6">
                                <table class="linked-rates-table">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Date</th>`;

                if (serviceType === 'SMS') {
                    html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                } else {
                    html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Inc.</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                }

                html += `</tr></thead><tbody>`;

                this.selectedOurOffers.forEach(({ meeting, offer }) => {
                    const offerRate = parseFloat(offer.rate);
                    const isBestRate = offerRate === bestRate;

                    html += `<tr ${isBestRate ? 'style="background: #ecfdf5;"' : ''}>
                        <td><strong>${this.escapeHtml(meeting.company)}</strong></td>
                        <td><small>${meeting.date}</small></td>`;

                    if (serviceType === 'SMS') {
                        html += `
                            <td>${this.escapeHtml(offer.designation || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.network || '-')}</td>
                            <td class="font-semibold" style="color: ${isBestRate ? '#10b981' : color}">${this.escapeHtml(offer.rate || '-')} ${isBestRate ? '' : ''}</td>
                            <td>${this.escapeHtml(offer.traffic || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.tps || '-')}</td>
                            <td>${this.escapeHtml(offer.cap || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    } else {
                        html += `
                            <td>${this.escapeHtml(offer.destination || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.breakout || '-')}</td>
                            <td class="font-semibold" style="color: ${isBestRate ? '#10b981' : color}">${this.escapeHtml(offer.rate || '-')} ${isBestRate ? '' : ''}</td>
                            <td>${this.escapeHtml(offer.billingIncrement || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.acd || '-')}</td>
                            <td>${this.escapeHtml(offer.asr || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    }

                    html += '</tr>';
                });

                html += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="px-6 py-4 border-t border-slate-200 flex justify-end gap-2 bg-slate-50">
                                <button onclick="app.closeOurOffersComparison()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', html);
            }

            closeOurOffersComparison() {
                const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
                if (modal) modal.remove();

                // Reset comparison mode
                this.ourOffersComparisonMode = false;
                this.selectedOurOffers = [];
                document.getElementById('ouroffers-comparison-mode-btn').innerHTML = '<i class="ph-bold ph-git-diff"></i> Compare';
                document.getElementById('ouroffers-comparison-mode-btn').className = 'px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1';

                this.renderOurOffersSection();
            }

            renderOurOffersSection() {
                const content = document.getElementById('ouroffers-content');
                if (!content) return;

                const serviceType = this.state.ourOffersServiceType || 'SMS';

                // Get filter values
                const searchTerm = document.getElementById('ouroffers-search')?.value.toLowerCase().trim() || '';
                const dateFrom = document.getElementById('ouroffers-date-from')?.value || '';
                const dateTo = document.getElementById('ouroffers-date-to')?.value || '';
                const filterDesignation = document.getElementById('ouroffers-filter-designation')?.value || '';
                const filterProduct = document.getElementById('ouroffers-filter-product')?.value || '';
                const filterNetwork = document.getElementById('ouroffers-filter-network')?.value || '';
                const filterRate = document.getElementById('ouroffers-filter-rate')?.value || '';
                const filterTraffic = document.getElementById('ouroffers-filter-traffic')?.value || '';
                const filterDisplay = document.getElementById('ouroffers-filter-display')?.value || '';
                const filterTps = document.getElementById('ouroffers-filter-tps')?.value || '';
                const filterCap = document.getElementById('ouroffers-filter-cap')?.value || '';
                const filterHop = document.getElementById('ouroffers-filter-hop')?.value || '';

                // Get all meetings with linked rates (our offers)
                let allOffers = [];
                this.state.meetings.forEach(meeting => {
                    if ((meeting.serviceType || 'SMS') !== serviceType) return;
                    if (!meeting.linkedRates || !Array.isArray(meeting.linkedRates) || meeting.linkedRates.length === 0) return;

                    // Apply search and date filters
                    if (searchTerm && !meeting.company.toLowerCase().includes(searchTerm)) return;
                    if (dateFrom && meeting.date < dateFrom) return;
                    if (dateTo && meeting.date > dateTo) return;

                    meeting.linkedRates.forEach(linkedRate => {
                        // Resolve the actual rate data from linkedRates reference
                        const rateData = this.state.data[linkedRate.key]?.[linkedRate.index];
                        if (!rateData) return;

                        // Apply column filters
                        if (serviceType === 'SMS') {
                            if (filterDesignation && rateData.designation !== filterDesignation) return;
                            if (filterProduct && rateData.product !== filterProduct) return;
                            if (filterNetwork && rateData.network !== filterNetwork) return;
                            if (filterRate && rateData.rate !== filterRate) return;
                            if (filterTraffic && rateData.traffic !== filterTraffic) return;
                            if (filterDisplay && rateData.display !== filterDisplay) return;
                            if (filterTps && rateData.tps !== filterTps) return;
                            if (filterCap && rateData.cap !== filterCap) return;
                            if (filterHop && rateData.hop !== filterHop) return;
                        } else {
                            if (filterDesignation && rateData.destination !== filterDesignation) return;
                            if (filterProduct && rateData.product !== filterProduct) return;
                            if (filterNetwork && rateData.breakout !== filterNetwork) return;
                            if (filterRate && rateData.rate !== filterRate) return;
                            if (filterTraffic && rateData.billingIncrement !== filterTraffic) return;
                            if (filterDisplay && rateData.display !== filterDisplay) return;
                            if (filterTps && rateData.acd !== filterTps) return;
                            if (filterCap && rateData.asr !== filterCap) return;
                            if (filterHop && rateData.hop !== filterHop) return;
                        }

                        allOffers.push({ meeting, offer: rateData, linkedRate });
                    });
                });

                if (allOffers.length === 0) {
                    const hasAnyFilters = searchTerm || dateFrom || dateTo || filterDesignation || filterProduct || filterNetwork || filterRate || filterTraffic || filterDisplay || filterTps || filterCap || filterHop;
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-400">
                                <i class="ph ${hasAnyFilters ? 'ph-magnifying-glass' : 'ph-upload'} text-3xl"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-900">${hasAnyFilters ? 'No Results Found' : 'No Our Offers Yet'}</h3>
                            <p class="text-xs text-slate-500 mt-1">${hasAnyFilters ? 'Try adjusting your filters' : 'Our offers will appear here when you link rates to meetings'}</p>
                        </div>
                    `;
                    return;
                }

                // Check if any filters are active
                const hasAnyFilters = searchTerm || dateFrom || dateTo || filterDesignation || filterProduct || filterNetwork || filterRate || filterTraffic || filterDisplay || filterTps || filterCap || filterHop;
                const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';

                // Show unified table view ONLY when filters are active
                if (hasAnyFilters || this.ourOffersComparisonMode) {
                let html = `
                    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="linked-rates-table">
                                <thead>
                                    <tr>`;

                if (this.ourOffersComparisonMode) {
                    html += '<th style="width: 40px;"><i class="ph-bold ph-check-square"></i></th>';
                }

                html += '<th>Company</th><th>Date</th>';

                if (serviceType === 'SMS') {
                    html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                } else {
                    html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Inc.</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                }

                html += '</tr></thead><tbody>';

                allOffers.forEach(({ meeting, offer }, index) => {
                    const serviceType = meeting.serviceType || 'SMS';
                    const color = serviceType === 'SMS' ? '#3BC1A8' : '#249E94';

                    // Find the offer index in the original meeting for checkbox functionality
                    const offerIndex = meeting.linkedRates.findIndex(o => o === offer);
                    const offerKey = `${meeting.id}_${offerIndex}`;
                    const isSelected = this.ourOffersComparisonMode && this.selectedOurOffers?.some(o => o.key === offerKey);

                    html += '<tr>';

                    if (this.ourOffersComparisonMode) {
                        html += `
                            <td style="text-align: center;">
                                <input type="checkbox" ${isSelected ? 'checked' : ''}
                                    onchange="app.selectOurOfferForComparison('${meeting.id}', ${offerIndex})"
                                    class="cursor-pointer" style="width: 18px; height: 18px;" />
                            </td>`;
                    }

                    html += `
                        <td><strong>${this.escapeHtml(meeting.company)}</strong></td>
                        <td><small>${meeting.date}</small></td>`;

                    if (serviceType === 'SMS') {
                        html += `
                            <td>${this.escapeHtml(offer.designation || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.network || '-')}</td>
                            <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                            <td>${this.escapeHtml(offer.traffic || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.tps || '-')}</td>
                            <td>${this.escapeHtml(offer.cap || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    } else {
                        html += `
                            <td>${this.escapeHtml(offer.destination || '-')}</td>
                            <td>${this.escapeHtml(offer.product || '-')}</td>
                            <td>${this.escapeHtml(offer.breakout || '-')}</td>
                            <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                            <td>${this.escapeHtml(offer.billingIncrement || '-')}</td>
                            <td>${this.escapeHtml(offer.display || '-')}</td>
                            <td>${this.escapeHtml(offer.acd || '-')}</td>
                            <td>${this.escapeHtml(offer.asr || '-')}</td>
                            <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                    }

                    html += '</tr>';
                });

                    html += '</tbody></table></div></div>';
                    content.innerHTML = html;
                } else {
                    // Show original company card view when NO filters are active
                    let html = '<div class="space-y-4">';

                    // Group offers back by company
                    const companiesByMeeting = {};
                    allOffers.forEach(({ meeting, offer }) => {
                        if (!companiesByMeeting[meeting.id]) {
                            companiesByMeeting[meeting.id] = { meeting: meeting, offers: [] };
                        }
                        companiesByMeeting[meeting.id].offers.push(offer);
                    });

                    Object.values(companiesByMeeting).forEach(({ meeting, offers }, idx) => {
                        const cardId = `our-offer-${meeting.id}-${idx}`;
                        html += `
                            <div class="border border-slate-200 rounded-xl p-4 bg-white shadow-sm">
                                <div class="flex items-start justify-between mb-3 pb-3 border-b border-slate-100">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h3 class="font-bold text-slate-800 text-base">${this.escapeHtml(meeting.company)}</h3>
                                            <span class="px-2 py-0.5 rounded text-xs font-semibold" style="background: ${color}20; color: ${color}">
                                                ${serviceType}
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-calendar text-teal-600"></i>
                                                <span>${meeting.date} - ${this.formatTimeDisplay(meeting.startTime)}</span>
                                            </div>
                                            ${meeting.strongRegion ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-globe text-teal-600"></i>
                                                <span><strong>Region:</strong> ${this.escapeHtml(meeting.strongRegion)}</span>
                                            </div>` : ''}
                                            ${meeting.contactPerson ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-user text-teal-600"></i>
                                                <span>${this.escapeHtml(meeting.contactPerson)}</span>
                                            </div>` : ''}
                                            ${meeting.email ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-envelope text-teal-600"></i>
                                                <a href="mailto:${this.escapeHtml(meeting.email)}" class="text-teal-600 hover:underline">${this.escapeHtml(meeting.email)}</a>
                                            </div>` : ''}
                                            ${meeting.phone ? `
                                            <div class="flex items-center gap-1.5 text-slate-600">
                                                <i class="ph-bold ph-phone text-teal-600"></i>
                                                <a href="tel:${this.escapeHtml(meeting.phone)}" class="text-teal-600 hover:underline">${this.escapeHtml(meeting.phone)}</a>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                    <button onclick="app.toggleOfferTable('${cardId}')" class="toggle-table-btn" title="Collapse/Expand">
                                        <i class="ph-bold ph-caret-up" id="icon-${cardId}"></i>
                                    </button>
                                </div>
                                <div class="overflow-x-auto" id="table-${cardId}">
                                    <table class="linked-rates-table">
                                        <thead><tr>`;

                        if (serviceType === 'SMS') {
                            html += '<th>Designation</th><th>Product</th><th>Network</th><th>Rate</th><th>Traffic</th><th>Display</th><th>TPS</th><th>CAP</th><th>HOP</th>';
                        } else {
                            html += '<th>Destination</th><th>Product</th><th>Breakout</th><th>Rate</th><th>Billing Inc.</th><th>Display</th><th>ACD</th><th>ASR</th><th>HOP</th>';
                        }

                        html += '</tr></thead><tbody>';

                        offers.forEach(offer => {
                            html += '<tr>';
                            if (serviceType === 'SMS') {
                                html += `
                                    <td>${this.escapeHtml(offer.designation || '-')}</td>
                                    <td>${this.escapeHtml(offer.product || '-')}</td>
                                    <td>${this.escapeHtml(offer.network || '-')}</td>
                                    <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                                    <td>${this.escapeHtml(offer.traffic || '-')}</td>
                                    <td>${this.escapeHtml(offer.display || '-')}</td>
                                    <td>${this.escapeHtml(offer.tps || '-')}</td>
                                    <td>${this.escapeHtml(offer.cap || '-')}</td>
                                    <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                            } else {
                                html += `
                                    <td>${this.escapeHtml(offer.destination || '-')}</td>
                                    <td>${this.escapeHtml(offer.product || '-')}</td>
                                    <td>${this.escapeHtml(offer.breakout || '-')}</td>
                                    <td class="font-semibold" style="color: ${color}">${this.escapeHtml(offer.rate || '-')}</td>
                                    <td>${this.escapeHtml(offer.billingIncrement || '-')}</td>
                                    <td>${this.escapeHtml(offer.display || '-')}</td>
                                    <td>${this.escapeHtml(offer.acd || '-')}</td>
                                    <td>${this.escapeHtml(offer.asr || '-')}</td>
                                    <td>${this.escapeHtml(offer.hop || '-')}</td>`;
                            }
                            html += '</tr>';
                        });

                        html += '</tbody></table></div></div>';
                    });

                    html += '</div>';
                    content.innerHTML = html;
                }
            }

            // ==================== LINKED RATES ====================
            populateRateDropdown() {
                // No longer needed - using search input instead
                // Kept as empty function to avoid errors from existing calls
            }

            getAllRateDataForDropdown() {
                const results = [];

                // Get the meeting's service type to filter rates
                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                const meetingServiceType = meeting?.serviceType || 'SMS';

                Object.keys(this.state.data).forEach(key => {
                    const [serviceType, listType, region] = key.split('_');

                    // Only show rates matching the meeting's service type
                    if (serviceType !== meetingServiceType) return;

                    const rows = this.state.data[key] || [];

                    rows.forEach((row, index) => {
                        const firstCol = serviceType === 'VOICE' ? row.destination : row.designation;
                        if (firstCol) {
                            results.push({
                                id: `${key}_${index}`,
                                key: key,
                                index: index,
                                label: `${listType} | ${region} | ${firstCol} - ${row.product || 'N/A'}`,
                                data: row
                            });
                        }
                    });
                });

                return results;
            }

            addLinkedRate() {
                const select = document.getElementById('meeting-rate-select');
                const rateId = select?.value;

                if (!rateId) return;

                const allRates = this.getAllRateDataForDropdown();
                const rate = allRates.find(r => r.id === rateId);

                if (rate && !this.pendingLinkedRates.some(r => r.id === rate.id)) {
                    // Store full data directly so it's always available
                    this.pendingLinkedRates.push({
                        id: rate.id,
                        label: rate.label,
                        key: rate.key,
                        index: rate.index,
                        fullData: { ...rate.data }  // Store the full row data
                    });
                    this.renderLinkedRates();
                    this.populateRateDropdown();
                }

                if (select) select.value = '';
            }

            // Add rate from search suggestion
            addLinkedRateById(rateId) {
                const allRates = this.getAllRateDataForDropdown();
                const rate = allRates.find(r => r.id === rateId);

                if (rate && !this.pendingLinkedRates.some(r => r.id === rate.id)) {
                    this.pendingLinkedRates.push({
                        id: rate.id,
                        label: rate.label,
                        key: rate.key,
                        index: rate.index,
                        fullData: { ...rate.data }
                    });
                    this.renderLinkedRates();
                }

                // Clear search and hide suggestions
                document.getElementById('meeting-rate-search').value = '';
                this.hideRateSuggestions();
            }

            // Search rates and show suggestions
            searchRates(query) {
                const container = document.getElementById('rate-suggestions');
                const allRates = this.getAllRateDataForDropdown();

                // Filter out already linked rates
                const availableRates = allRates.filter(r =>
                    !this.pendingLinkedRates.some(linked => linked.id === r.id)
                );

                if (!query.trim()) {
                    // Show all available if no query
                    this.renderRateSuggestions(availableRates.slice(0, 10));
                    return;
                }

                const lowerQuery = query.toLowerCase();
                const filtered = availableRates.filter(rate => {
                    const searchText = `${rate.label} ${rate.data.designation || ''} ${rate.data.destination || ''} ${rate.data.product || ''} ${rate.data.network || ''} ${rate.data.breakout || ''}`.toLowerCase();
                    return searchText.includes(lowerQuery);
                });

                this.renderRateSuggestions(filtered.slice(0, 10));
            }

            renderRateSuggestions(rates) {
                const container = document.getElementById('rate-suggestions');

                if (rates.length === 0) {
                    container.innerHTML = '<div class="rate-no-results">No matching rates found</div>';
                    container.classList.remove('hidden');
                    return;
                }

                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                const isVoice = meeting?.serviceType === 'VOICE';

                container.innerHTML = rates.map(rate => {
                    const mainText = isVoice
                        ? `${rate.data.destination || 'Unknown'} - ${rate.data.product || 'N/A'}`
                        : `${rate.data.designation || 'Unknown'} - ${rate.data.product || 'N/A'}`;
                    const subText = isVoice
                        ? `Rate: ${rate.data.rate || '-'} | ${rate.data.breakout || '-'}`
                        : `Rate: ${rate.data.rate || '-'} | ${rate.data.network || '-'} | ${rate.data.traffic || '-'}`;

                    return `
                        <div class="rate-suggestion-item">
                            <div class="rate-suggestion-info">
                                <span class="rate-main">${this.escapeHtml(mainText)}</span>
                                <span class="rate-sub">${this.escapeHtml(subText)}</span>
                            </div>
                            <div class="rate-suggestion-actions">
                                <button class="btn-rate-view" onclick="event.stopPropagation(); app.previewRate('${rate.id}')">
                                    <i class="ph ph-eye"></i> View
                                </button>
                                <button class="btn-rate-add" onclick="event.stopPropagation(); app.addLinkedRateById('${rate.id}')">
                                    <i class="ph ph-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                container.classList.remove('hidden');
            }

            showRateSuggestions() {
                const query = document.getElementById('meeting-rate-search').value;
                this.searchRates(query);
            }

            hideRateSuggestions() {
                document.getElementById('rate-suggestions')?.classList.add('hidden');
            }

            // Preview rate before linking
            previewRate(rateId) {
                const allRates = this.getAllRateDataForDropdown();
                const rate = allRates.find(r => r.id === rateId);
                if (!rate) return;

                this.previewingRateId = rateId;

                const meeting = this.state.meetings.find(m => m.id === this.editingMeetingId);
                const isVoice = meeting?.serviceType === 'VOICE';

                // Build preview table
                const table = document.getElementById('rate-preview-table');
                let rows = '';

                if (isVoice) {
                    rows = `
                        <tr><td>Destination</td><td>${this.escapeHtml(rate.data.destination || '-')}</td></tr>
                        <tr><td>Product</td><td>${this.escapeHtml(rate.data.product || '-')}</td></tr>
                        <tr><td>Breakout</td><td>${this.escapeHtml(rate.data.breakout || '-')}</td></tr>
                        <tr><td>Rate</td><td>${this.escapeHtml(rate.data.rate || '-')}</td></tr>
                        <tr><td>Billing Increment</td><td>${this.escapeHtml(rate.data.billing || '-')}</td></tr>
                        <tr><td>Display</td><td>${this.escapeHtml(rate.data.display || '-')}</td></tr>
                        <tr><td>ACD</td><td>${this.escapeHtml(rate.data.acd || '-')}</td></tr>
                        <tr><td>ASR</td><td>${this.escapeHtml(rate.data.asr || '-')}</td></tr>
                        <tr><td>HOP</td><td>${this.escapeHtml(rate.data.hop || '-')}</td></tr>
                    `;
                } else {
                    rows = `
                        <tr><td>Designation</td><td>${this.escapeHtml(rate.data.designation || '-')}</td></tr>
                        <tr><td>Product</td><td>${this.escapeHtml(rate.data.product || '-')}</td></tr>
                        <tr><td>Network</td><td>${this.escapeHtml(rate.data.network || '-')}</td></tr>
                        <tr><td>Rate</td><td>${this.escapeHtml(rate.data.rate || '-')}</td></tr>
                        <tr><td>Traffic</td><td>${this.escapeHtml(rate.data.traffic || '-')}</td></tr>
                        <tr><td>Display</td><td>${this.escapeHtml(rate.data.display || '-')}</td></tr>
                        <tr><td>TPS</td><td>${this.escapeHtml(rate.data.tps || '-')}</td></tr>
                        <tr><td>CAP</td><td>${this.escapeHtml(rate.data.cap || '-')}</td></tr>
                        <tr><td>HOP</td><td>${this.escapeHtml(rate.data.hop || '-')}</td></tr>
                    `;
                }

                // Add source info
                rows += `<tr><td>Source</td><td class="text-[#3BC1A8]">${this.escapeHtml(rate.key.replace(/_/g, '  '))}</td></tr>`;

                table.innerHTML = rows;

                // Show panel
                document.getElementById('rate-preview-panel').classList.add('show');
                this.hideRateSuggestions();
            }

            closeRatePreview() {
                document.getElementById('rate-preview-panel').classList.remove('show');
                this.previewingRateId = null;
            }

            confirmLinkRate() {
                if (this.previewingRateId) {
                    this.addLinkedRateById(this.previewingRateId);
                    this.closeRatePreview();
                }
            }

            removeLinkedRate(rateId) {
                this.pendingLinkedRates = this.pendingLinkedRates.filter(r => r.id !== rateId);
                this.renderLinkedRates();
                this.populateRateDropdown();
            }

            renderLinkedRates() {
                const container = document.getElementById('linked-rates');

                if (this.pendingLinkedRates.length === 0) {
                    container.innerHTML = '<span class="text-[10px] text-slate-400">No linked rate data</span>';
                    return;
                }

                container.innerHTML = this.pendingLinkedRates.map(rate => `
                    <span class="linked-tag">
                        <i class="ph ph-link"></i>
                        ${this.escapeHtml(rate.label)}
                        <button onclick="app.removeLinkedRate('${rate.id}')">&times;</button>
                    </span>
                `).join('');
            }

            // ==================== FILE ATTACHMENTS ====================
            handleMeetingFiles(event) {
                const files = Array.from(event.target.files);

                files.forEach(file => {
                    // Convert to base64 for storage
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.pendingMeetingFiles.push({
                            id: `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        });
                        this.renderMeetingFiles();
                    };
                    reader.readAsDataURL(file);
                });

                event.target.value = '';
            }

            removeMeetingFile(fileId) {
                this.pendingMeetingFiles = this.pendingMeetingFiles.filter(f => f.id !== fileId);
                this.renderMeetingFiles();
            }

            renderMeetingFiles() {
                const container = document.getElementById('meeting-files');

                if (this.pendingMeetingFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = this.pendingMeetingFiles.map(file => {
                    const isImage = file.type && file.type.startsWith('image/');
                    const isPDF = file.type && file.type === 'application/pdf';
                    const fileIcon = isImage ? 'ph-image' : (isPDF ? 'ph-file-pdf' : 'ph-file');

                    return `
                        <div class="file-item">
                            <i class="ph ${fileIcon} text-lg"></i>
                            <span class="name">${this.escapeHtml(file.name)}</span>
                            <span class="text-[10px] text-slate-400">${this.formatFileSize(file.size)}</span>
                            <button onclick="app.removeMeetingFile('${file.id}')">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }

            showToast(msg, type = 'success', customDuration = null) {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toast-msg');
                const icon = toast.querySelector('i');

                msgEl.innerText = msg;

                if (type === 'error') {
                    icon.className = 'ph-fill ph-warning-circle text-red-400 text-lg';
                } else if (type === 'warning') {
                    icon.className = 'ph-fill ph-bell-ringing text-amber-400 text-lg';
                } else if (type === 'info') {
                    icon.className = 'ph-fill ph-info text-blue-400 text-lg';
                } else {
                    icon.className = 'ph-fill ph-check-circle text-green-400 text-lg';
                }

                toast.classList.remove('-translate-y-20');
                toast.classList.add('translate-y-2');

                const duration = customDuration || (type === 'warning' ? 4000 : 2000);
                setTimeout(() => {
                    toast.classList.remove('translate-y-2');
                    toast.classList.add('-translate-y-20');
                }, duration);
            }

            // ========================================
            // SKELETON LOADERS
            // ========================================

            showCompaniesSkeleton() {
                const container = document.getElementById('companies-list');
                container.innerHTML = Array(6).fill('').map(() => `
                    <div class="skeleton-company-card">
                        <div class="skeleton" style="width: 48px; height: 48px; border-radius: 50%;"></div>
                        <div style="flex: 1;">
                            <div class="skeleton" style="width: 60%; height: 16px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="width: 40%; height: 12px; margin-bottom: 6px;"></div>
                            <div class="skeleton" style="width: 50%; height: 12px;"></div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <div class="skeleton" style="width: 32px; height: 32px; border-radius: 8px;"></div>
                            <div class="skeleton" style="width: 32px; height: 32px; border-radius: 8px;"></div>
                        </div>
                    </div>
                `).join('');
            }

            showMeetingsSkeleton() {
                const container = document.getElementById('time-slots-container');
                container.innerHTML = Array(8).fill('').map((_, i) => `
                    <div style="position: relative; height: 80px; border-bottom: 1px solid #f1f5f9;">
                        <div style="position: absolute; left: 0; top: 8px; width: 60px; padding-left: 8px;">
                            <div class="skeleton" style="width: 45px; height: 14px;"></div>
                        </div>
                        <div style="margin-left: 68px; padding: 8px;">
                            ${i % 3 === 0 ? `
                                <div class="skeleton-meeting-block">
                                    <div class="skeleton" style="width: 70%; height: 14px; margin-bottom: 6px;"></div>
                                    <div class="skeleton" style="width: 50%; height: 12px;"></div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            showClientOffersSkeleton() {
                const container = document.getElementById('clientoffers-content');
                container.innerHTML = Array(5).fill('').map(() => `
                    <div class="skeleton-offer-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div class="skeleton" style="width: 50%; height: 18px;"></div>
                            <div class="skeleton" style="width: 80px; height: 24px; border-radius: 12px;"></div>
                        </div>
                        <div class="skeleton" style="width: 30%; height: 12px; margin-bottom: 8px;"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                        </div>
                        <div class="skeleton" style="width: 100%; height: 60px; border-radius: 8px; margin-top: 12px;"></div>
                    </div>
                `).join('');
            }

            showOurOffersSkeleton() {
                const container = document.getElementById('ouroffers-content');
                container.innerHTML = Array(5).fill('').map(() => `
                    <div class="skeleton-offer-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div class="skeleton" style="width: 50%; height: 18px;"></div>
                            <div class="skeleton" style="width: 80px; height: 24px; border-radius: 12px;"></div>
                        </div>
                        <div class="skeleton" style="width: 30%; height: 12px; margin-bottom: 8px;"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                            <div class="skeleton" style="height: 12px;"></div>
                        </div>
                        <div class="skeleton" style="width: 100%; height: 60px; border-radius: 8px; margin-top: 12px;"></div>
                    </div>
                `).join('');
            }

            showLoading(msg = 'Loading...') {
                // Simple loading overlay for save/delete operations
                let loader = document.getElementById('global-loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'global-loader';
                    loader.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:99999;display:none;align-items:center;justify-content:center;';
                    loader.innerHTML = `
                        <div style="background:white;border-radius:12px;padding:20px 32px;box-shadow:0 10px 40px rgba(0,0,0,0.2);text-align:center;">
                            <div style="width:40px;height:40px;border:3px solid #e0e0e0;border-top:3px solid #3BC1A8;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px;"></div>
                            <p style="font-size:14px;color:#64748b;font-weight:500;">${msg}</p>
                        </div>
                        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
                    `;
                    document.body.appendChild(loader);
                }
                loader.style.display = 'flex';
            }

            hideLoading() {
                const loader = document.getElementById('global-loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }

            // Cleanup reminders
            stopMeetingReminders() {
                if (this.reminderInterval) {
                    clearInterval(this.reminderInterval);
                    this.reminderInterval = null;
                }
            }
        }

        const app = new TelecomApp();
    </script>
</body>
</html>
